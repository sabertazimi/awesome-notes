"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[13678],{5853:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"web/devops/deploy","title":"Deployment","description":"Static Assets","source":"@site/content/web/devops/deploy.md","sourceDirName":"web/devops","slug":"/web/devops/deploy","permalink":"/notes/web/devops/deploy","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/devops/deploy.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"DevOps","permalink":"/notes/tags/dev-ops"},{"inline":true,"label":"Deployment","permalink":"/notes/tags/deployment"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":5,"frontMatter":{"sidebar_position":5,"tags":["Web","DevOps","Deployment"]},"sidebar":"tutorialSidebar","previous":{"title":"Authentication","permalink":"/notes/web/devops/auth"},"next":{"title":"Linters","permalink":"/notes/web/devops/lint"}}');var i=t(35656),a=t(86145);const r={sidebar_position:5,tags:["Web","DevOps","Deployment"]},l="Deployment",o={},c=[{value:"Static Assets",id:"static-assets",level:2},{value:"CI",id:"ci",level:2},{value:"Docker",id:"docker",level:2},{value:"Nginx",id:"nginx",level:2},{value:"A/B Testing",id:"ab-testing",level:2},{value:"Blue Green",id:"blue-green",level:2},{value:"Rolling Update",id:"rolling-update",level:2},{value:"Gray Release",id:"gray-release",level:2},{value:"Solution",id:"solution",level:3},{value:"Performance",id:"performance",level:3},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"deployment",children:"Deployment"})}),"\n",(0,i.jsx)(n.h2,{id:"static-assets",children:"Static Assets"}),"\n",(0,i.jsxs)(n.p,{children:["Fingerprinting is a technique that makes the name of a file,\ndependent on the ",(0,i.jsx)(n.strong,{children:"contents"})," of the file,\nnot on the ",(0,i.jsx)(n.strong,{children:"timestamp"})," differ from servers.\nWhen the file contents change,\nthe filename is also changed.\nFor content that is static or infrequently changed,\nthis provides an easy way to tell whether two versions of a file are identical,\neven across different servers or deployment dates."]}),"\n",(0,i.jsxs)(n.p,{children:["When a filename is unique and based on its content, HTTP headers\ncan be set to encourage ",(0,i.jsx)(n.strong,{children:"caches"}),"(code: ",(0,i.jsx)(n.code,{children:"200"}),") everywhere\n(whether at CDNs, at ISPs, in networking equipment, or in web browsers)\nto keep their own copy of the content.\nWhen the content is updated(),\nthe fingerprint will change.\nThis will cause the remote clients to request a new copy of the content.\nThis is generally known as cache busting."]}),"\n",(0,i.jsx)(n.h2,{id:"ci",children:"CI"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Full builds upon continuous deployment."}),"\n",(0,i.jsx)(n.li,{children:"Incremental builds are a product of time."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"docker",children:"Docker"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-dockerfile",children:"FROM node:16-alpine as builder\n\nWORKDIR /code\n\nADD package.json package-lock.json /code/\nRUN npm install\n\nADD . /code\nRUN npm run build\n\n# \u9009\u62e9\u66f4\u5c0f\u4f53\u79ef\u7684\u57fa\u7840\u955c\u50cf\nFROM nginx:alpine\n\n# \u5c06\u6784\u5efa\u4ea7\u7269\u79fb\u81f3 Nginx\nCOPY --from=builder code/build/ /usr/share/nginx/html/\n"})}),"\n",(0,i.jsx)(n.h2,{id:"nginx",children:"Nginx"}),"\n",(0,i.jsx)(n.p,{children:"\u5b50\u57df\u540d\u8bbe\u7f6e:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo mkdir -p /var/www/blog/html\nsudo chown -R $USER:$USER /var/www/blog/html\nsudo chmod -R 755 /var/www\nsudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/blog\n# change 'root' and 'server_name' config, remove 'default_server' config\nsudo vim /etc/nginx/sites-available/blog\nsudo ln -s /etc/nginx/sites-available/blog /etc/nginx/sites-enabled/\nsudo nginx -t\nsudo systemctl restart nginx\n"})}),"\n",(0,i.jsx)(n.h2,{id:"ab-testing",children:"A/B Testing"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://rahulsuresh.net/blog/ab-testing-millions-of-users-using-aws-lambda-edge",children:"A/B testing"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Improves customer experience:\nby testing different options,\nbusinesses can find out what their customers prefer\nand make their websites or products more enjoyable to use."}),"\n",(0,i.jsx)(n.li,{children:"Increases sales:\nif a business knows which version of a webpage leads to more sales or sign-ups,\nthey can use that version for everyone, potentially making more money."}),"\n",(0,i.jsx)(n.li,{children:"Reduces risks:\nbefore making big changes, like redesigning a website,\nbusinesses can test small changes to see how people react.\nThis way, they avoid making big investments that might not pay off."}),"\n",(0,i.jsx)(n.li,{children:"Informs decisions:\nInstead of relying on gut feelings,\nbusinesses can make informed decisions that are backed up by actual user behavior."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"// A/B test causing Flash of Unstyled Content (FoUC):\n// - SEO impact.\n// - User experience impact.\n// - Web performance impact.\nimport { useEffect, useState } from 'react'\n\nconst imageUrlA = 'https://fakeimg.pl/150x150/0000FF/808080?text=Variant+A'\nconst imageUrlB = 'https://fakeimg.pl/150x150/FF0000/FFFFFF?text=Variant+B'\n\nconst VariantA = () => <img src={imageUrlA} alt=\"Variant A\" />\nconst VariantB = () => <img src={imageUrlB} alt=\"Variant B\" />\n\nexport default function ABTestComponent() {\n  const [variant, setVariant] = useState('loading')\n\n  useEffect(() => {\n    // Simulate reading from localStorage with a delay\n    const timeout = setTimeout(() => {\n      const randomVariant = Math.random() < 0.5 ? 'A' : 'B'\n      const storedVariant = localStorage.getItem('userVariant') ?? randomVariant\n      localStorage.setItem('userVariant', storedVariant)\n      setVariant(storedVariant)\n    }, 500) // 500ms second delay to simulate a flicker effect\n\n    return () => clearTimeout(timeout)\n  }, [])\n\n  return (\n    <div>\n      {variant === 'loading' && <div>Loading variant...</div>}\n      {variant === 'A' && <VariantA />}\n      {variant === 'B' && <VariantB />}\n    </div>\n  )\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"blue-green",children:"Blue Green"}),"\n",(0,i.jsx)(n.p,{children:"\u4e24\u5957\u7cfb\u7edf, \u4e00\u5957\u7a33\u5b9a\u7684\u7eff\u8272\u7cfb\u7edf, \u4e00\u5957\u5373\u5c06\u53d1\u5e03\u7684\u84dd\u8272\u7cfb\u7edf.\n\u4e0d\u65ad\u5207\u6362\u5e76\u8fed\u4ee3\u53d1\u5e03\u5230\u751f\u4ea7\u73af\u5883\u4e2d."}),"\n",(0,i.jsx)(n.h2,{id:"rolling-update",children:"Rolling Update"}),"\n",(0,i.jsx)(n.p,{children:"\u591a\u4e2a\u96c6\u7fa4\u5b9e\u4f8b\u7684\u670d\u52a1\u4e2d, \u5728\u4e0d\u5f71\u54cd\u670d\u52a1\u7684\u60c5\u51b5\u4e0b,\n\u505c\u6b62\u4e00\u4e2a\u6216\u591a\u4e2a\u5b9e\u4f8b, \u9010\u6b65\u8fdb\u884c\u7248\u672c\u66f4\u65b0."}),"\n",(0,i.jsx)(n.h2,{id:"gray-release",children:"Gray Release"}),"\n",(0,i.jsx)(n.p,{children:"Canary Release: \u5168\u91cf\u6216\u589e\u91cf\u90e8\u7f72\u65b0\u6587\u4ef6, \u5e76\u9010\u6b65\u628a\u6d41\u91cf\u5207\u6362\u81f3\u65b0 CDN URL.\n\u6839\u636e\u7070\u5ea6\u767d\u540d\u5355, \u5c06\u7070\u5ea6\u6d4b\u8bd5\u7528\u6237\u7684 CDN Assets\n\u66f4\u6362\u81f3\u4e0d\u540c Version Number \u6216\u8005 Fingerprint \u7684\u65b0\u7248\u672c\u524d\u7aef\u9875\u9762\u6587\u4ef6."}),"\n",(0,i.jsx)(n.h3,{id:"solution",children:"Solution"}),"\n",(0,i.jsx)(n.p,{children:"\u901a\u8fc7\u7070\u5ea6\u53d1\u5e03\u6536\u96c6\u7528\u6237\u53cd\u9988 (\u8f6c\u5316\u7387\u7b49\u6307\u6807),\n\u51b3\u5b9a\u540e\u7eed\u662f\u5426\u5168\u9762\u5c06\u6240\u6709\u6d41\u91cf\u5207\u81f3\u65b0\u7248\u672c,\n\u6216\u8005\u5b8c\u5168\u653e\u5f03\u65b0\u7248\u672c,\n\u4ea6\u6216\u662f\u901a\u8fc7 FLAGS \u7ed3\u5408\u7528\u6237\u7279\u5f81\u56fe\u50cf,\n(\u5982\u7528\u6237\u7ea7\u522b, UA, Cookie\nLocation, IP,\nFeature List \u7b49)\n\u53ea\u5411\u90e8\u5206\u6d41\u91cf\u6295\u653e\u65b0\u7248\u672c.\n\u53ef\u4ee5\u5b9e\u73b0\u5343\u4eba\u5343\u9875,\n\u6bcf\u4e2a\u7528\u6237\u83b7\u5f97\u7531\u4e0d\u540c\u7684\u529f\u80fd (FLAGS \u5f00\u542f\u5173\u95ed) \u7ec4\u6210\u7684\u4e0d\u540c\u9875\u9762."}),"\n",(0,i.jsx)(n.p,{children:"\u4e1a\u754c\u6210\u719f\u7684\u7070\u5ea6\u65b9\u6848:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u7b80\u5355\u7070\u5ea6\u903b\u8f91\u901a\u8fc7 Nginx \u914d\u7f6e\u505a\u89c4\u5219\u5224\u65ad(\u8def\u7531, \u53c2\u6570, IP, Cookie \u7b49), upstream \u5230\u4e0d\u540c\u7684\u670d\u52a1\u5668:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u65b0\u4ee3\u7801\u90e8\u7f72\u5230 A \u8fb9."}),"\n",(0,i.jsx)(n.li,{children:"\u7b26\u5408\u7070\u5ea6\u7b56\u7565\u7684\u5c0f\u90e8\u5206\u6d41\u91cf\u5207\u5230 A \u8fb9, \u5269\u4f59\u5927\u90e8\u5206\u6d41\u91cf\u4ecd\u53bb\u5f80 B \u8fb9"}),"\n",(0,i.jsx)(n.li,{children:"\u9a8c\u8bc1 A \u8fb9\u529f\u80fd\u662f\u5426\u6b63\u5e38\u53ef\u7528/\u597d\u7528"}),"\n",(0,i.jsx)(n.li,{children:"\u9a8c\u8bc1\u65e0\u8bef\u540e, \u5927\u90e8\u5206\u6d41\u91cf\u8f6c\u5230 A \u8fb9, \u7070\u5ea6\u6d41\u91cf\u53bb\u5f80 B \u8fb9"}),"\n",(0,i.jsx)(n.li,{children:"\u9a8c\u8bc1 B \u8fb9\u529f\u80fd\u662f\u5426\u6b63\u5e38\u53ef\u7528/\u597d\u7528"}),"\n",(0,i.jsx)(n.li,{children:"\u9a8c\u8bc1\u65e0\u8bef\u540e, \u6d41\u91cf\u50cf\u5f80\u5e38\u4e00\u6837\u5747\u5206\u5230 AB \u8fb9"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Canary Deployment\nmap $COOKIE_canary $group {\n  # canary account\n  ~*devui$ server_canary;\n  default server_default;\n}\n\n# \u6d41\u91cf\u5747\u5206, \u6ce8\u91ca\u6389\u5176\u4e2d\u67d0\u4e00\u8fb9, \u53e6\u4e00\u8fb9\u4e3a\u7070\u5ea6\u6d41\u91cf\u8bbf\u95ee\u8fb9\nupstream server_canary {\n  server 11.11.11.11:8000 weight=1 max_fails=1 fail_timeout=30s;\n  server 22.22.22.22 weight=1 max_fails=1 fail_timeout=30s;\n}\n\n# \u6d41\u91cf\u5747\u5206, \u6ce8\u91ca\u6389\u5176\u4e2d\u67d0\u4e00\u8fb9, \u53e6\u4e00\u8fb9\u4e3a\u6b63\u5e38\u6d41\u91cf\u8bbf\u95ee\u8fb9\nupstream server_default {\n  server 11.11.11.11:8000 weight=2 max_fails=1 fail_timeout=30s;\n  server 22.22.22.22 weight=2 max_fails=1 fail_timeout=30s;\n}\n\n# \u914d\u7f6e 8000 \u7aef\u53e3\u7684\u8f6c\u53d1\u89c4\u5219, \u5e76\u4e14 expose port\nserver {\n  listen 8000;\n  server_name _;\n  root /var/canaryDemo;\n\n  # Load configuration files for the default server block.\n  include /etc/nginx/default.d/*.conf;\n\n  location / {\n    root /var/canaryDemo;\n    index index.html;\n    try_files $uri $uri/ /index.html;\n  }\n}\n\nserver {\n  listen 80 default_server;\n  listen [::]:80 default_server;\n  server_name _;\n  # root /usr/share/nginx/html;\n  root /var/canaryDemo;\n\n  # Load configuration files for the default server block.\n  include /etc/nginx/default.d/*.conf;\n\n  location / {\n    proxy_pass http://$group;\n    # root /var/canaryDemo;\n    # index index.html;\n  }\n\n  error_page 404 /404.html;\n    location = /40x.html {\n  }\n\n  error_page 500 502 503 504 /50x.html;\n  location = /50x.h\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u590d\u6742\u7070\u5ea6\u903b\u8f91\u901a\u8fc7 Nginx + Lua \u65b0\u589e\u4e00\u4e2a\u7070\u5ea6\u4e2d\u5fc3\u670d\u52a1,\n\u7ed3\u5408\u4e1a\u52a1\u6765\u505a\u6d41\u91cf\u7684\u7070\u5ea6\u4e0e\u5207\u6362, \u63a7\u5236 HTML \u5165\u53e3\u6587\u4ef6,\n\u4f7f\u7070\u5ea6\u89c4\u5219\u4e0e\u4e1a\u52a1\u4ee3\u7801\u89e3\u8026."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"performance",children:"Performance"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u524d\u7aef\u4f18\u5316:\n\u6bcf\u4e00\u4e2a\u9875\u9762\u90fd\u9700\u8981\u53bb\u83b7\u53d6\u7070\u5ea6\u89c4\u5219, \u8fd9\u4e2a\u7070\u5ea6\u8bf7\u6c42\u5c06\u963b\u585e\u9875\u9762.\n\u53ef\u4ee5\u4f7f\u7528 localStorage \u5b58\u50a8\u8fd9\u4e2a\u7528\u6237\u662f\u5426\u4e3a\u7070\u5ea6\u7528\u6237,\n\u7136\u540e\u5b9a\u671f\u7684\u66f4\u65b0 localStorage,\n\u53d6\u4ee3\u5927\u91cf\u7684\u8bf7\u6c42\u9020\u6210\u7684\u4f53\u9a8c\u95ee\u9898."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u540e\u7aef\u4f18\u5316:\n\u5229\u7528 MemCache \u5728\u5185\u5b58\u4e2d\u7f13\u5b58\u7070\u5ea6\u89c4\u5219\u4e0e\u7070\u5ea6\u7528\u6237\u5217\u8868,\n\u63d0\u5347\u7070\u5ea6\u53d1\u5e03\u6027\u80fd."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["SaaS/PaaS/IaaS ",(0,i.jsx)(n.a,{href:"https://github.com/ripienaar/free-for-dev",children:"list"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Free budget ",(0,i.jsx)(n.a,{href:"https://github.com/255kb/stack-on-a-budget",children:"stack"}),"."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},86145:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>l});var s=t(57140);const i={},a=s.createContext(i);function r(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);