"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[63892],{55775:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"web/react/hooks/effects","title":"Effects","description":"Dispatcher","source":"@site/content/web/react/hooks/effects.md","sourceDirName":"web/react/hooks","slug":"/web/react/hooks/effects","permalink":"/notes/web/react/hooks/effects","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/hooks/effects.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Hook","permalink":"/notes/tags/hook"},{"inline":true,"label":"Effect","permalink":"/notes/tags/effect"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":7,"frontMatter":{"sidebar_position":7,"tags":["Web","React","Hook","Effect"]},"sidebar":"tutorialSidebar","previous":{"title":"Context","permalink":"/notes/web/react/hooks/context"},"next":{"title":"Concurrent","permalink":"/notes/web/react/hooks/concurrent"}}');var c=t(35656),o=t(86145);const r={sidebar_position:7,tags:["Web","React","Hook","Effect"]},i="Effects",l={},a=[{value:"Dispatcher",id:"dispatcher",level:2},{value:"Lifecycle",id:"lifecycle",level:2},{value:"Nasty Loop",id:"nasty-loop",level:2},{value:"Dependencies List",id:"dependencies-list",level:2},{value:"Omits",id:"omits",level:3},{value:"Primitives",id:"primitives",level:3},{value:"Functions",id:"functions",level:3},{value:"Comparison",id:"comparison",level:3},{value:"Closure",id:"closure",level:2},{value:"State",id:"state",level:2},{value:"Cleanup",id:"cleanup",level:2},{value:"useEffect",id:"useeffect",level:2},{value:"useLayoutEffect",id:"uselayouteffect",level:2},{value:"useInsertionEffect",id:"useinsertioneffect",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"effects",children:"Effects"})}),"\n",(0,c.jsx)(n.h2,{id:"dispatcher",children:"Dispatcher"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function mountEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return mountEffectImpl(\n    UpdateEffect | PassiveEffect,\n    HookPassive,\n    create,\n    deps\n  )\n}\n\nfunction mountEffectImpl(fiberFlags, hookFlags, create, deps) {\n  const hook = mountWorkInProgressHook()\n  const nextDeps = deps === undefined ? null : deps\n  currentlyRenderingFiber.flags |= fiberFlags // UpdateEffect | PassiveEffect.\n  hook.memoizedState = pushEffect(\n    HasEffect | hookFlags, // PassiveHook.\n    create,\n    undefined,\n    nextDeps\n  )\n}\n\nfunction updateEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return updateEffectImpl(PassiveEffect, HookPassive, create, deps)\n}\n\nfunction updateEffectImpl(fiberFlags, hookFlags, create, deps) {\n  const hook = updateWorkInProgressHook()\n  const nextDeps = deps === undefined ? null : deps\n  let destroy\n\n  if (currentHook !== null) {\n    const prevEffect = currentHook.memoizedState\n    destroy = prevEffect.destroy\n\n    if (nextDeps !== null) {\n      const prevDeps = prevEffect.deps\n\n      if (areHookInputsEqual(nextDeps, prevDeps)) {\n        // \u5982\u679c\u4f9d\u8d56\u4e0d\u53d8, \u65b0\u5efa Effect (tag \u4e0d\u542b HookHasEffect).\n        // Reconciler.Commit \u9636\u6bb5\u4f1a\u8df3\u8fc7\u6b64 Effect.\n        pushEffect(hookFlags, create, destroy, nextDeps)\n        return\n      }\n    }\n  }\n\n  // \u5982\u679c\u4f9d\u8d56\u6539\u53d8, \u66f4\u6539 fiber.flags, \u65b0\u5efa Effect.\n  // Reconciler.Commit \u9636\u6bb5\u4f1a\u518d\u6b21\u6267\u884c\u6b64 Effect.\n  currentlyRenderingFiber.flags |= fiberFlags\n  hook.memoizedState = pushEffect(\n    HasEffect | hookFlags,\n    create,\n    destroy,\n    nextDeps\n  )\n}\n\nfunction pushEffect(tag, create, destroy, deps) {\n  const effect = {\n    tag,\n    create, // User code: effect callback.\n    destroy, // User code: destroy callback.\n    deps, // User code: deps list.\n    next: null,\n  }\n\n  let componentUpdateQueue = currentlyRenderingFiber.updateQueue\n\n  if (componentUpdateQueue === null) {\n    componentUpdateQueue = createFunctionComponentUpdateQueue()\n    currentlyRenderingFiber.updateQueue = componentUpdateQueue\n    componentUpdateQueue.lastEffect = effect.next = effect\n  } else {\n    const lastEffect = componentUpdateQueue.lastEffect\n\n    if (lastEffect === null) {\n      componentUpdateQueue.lastEffect = effect.next = effect\n    } else {\n      // Circular effect list.\n      const firstEffect = lastEffect.next\n      lastEffect.next = effect\n      effect.next = firstEffect\n      componentUpdateQueue.lastEffect = effect\n    }\n  }\n\n  return effect\n}\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," ",(0,c.jsx)(n.a,{href:"https://jser.dev/2023-07-08-how-does-useeffect-work",children:"quiz"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"import * as React from 'react'\nimport { useEffect, useState } from 'react'\nimport { createRoot } from 'react-dom/client'\n\nfunction App() {\n  const [count, setCount] = useState(1)\n  console.log(1)\n  useEffect(() => {\n    console.log(2)\n    return () => {\n      console.log(3)\n    }\n  }, [count])\n\n  useEffect(() => {\n    console.log(4)\n    setCount(count => count + 1)\n  }, [])\n  return <Child count={count} />\n}\n\nfunction Child({ count }) {\n  useEffect(() => {\n    console.log(5)\n    return () => {\n      console.log(6)\n    }\n  }, [count])\n\n  return null\n};\n\nconst root = createRoot(document.getElementById('root'))\nroot.render(<App />)\n// 1 -> Parent initial render\n// 5 -> Child useEffect normal runs\n// 2 -> Parent first useEffect normal runs\n// 4 -> Parent second useEffect normal runs  <-- Causes a state change\n// 1 -> Parent re-render\n// 6 -> Cleanup code in Child's useEffect (return ...)\n// 3 -> Cleanup code in parent's useEffect (return... )\n// 5 -> Child useEffect normal runs (due to dependency on count)\n// 2 -> Parent useEffect normal runs (due to dependency on count)\n"})}),"\n",(0,c.jsx)(n.h2,{id:"lifecycle",children:"Lifecycle"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsx)(n.li,{children:"React renders UI for current props/state to screen."}),"\n",(0,c.jsx)(n.li,{children:"React cleans up the effect for prev props/state."}),"\n",(0,c.jsxs)(n.li,{children:["React runs the effect for current props/state\n(",(0,c.jsx)(n.code,{children:"useEffect"})," got invoked after ",(0,c.jsx)(n.code,{children:"componentDidMount"}),")."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"nasty-loop",children:"Nasty Loop"}),"\n",(0,c.jsxs)(n.p,{children:["The effect hook runs when the component ",(0,c.jsx)(n.code,{children:"mounts"}),"\nbut also when the component ",(0,c.jsx)(n.code,{children:"updates"}),".\nBecause we are setting the state after every data fetch,\nthe component updates and the effect runs again.\nIt fetches the data again and again.\nThat\u2019s a bug and needs to be avoided."]}),"\n",(0,c.jsx)(n.h2,{id:"dependencies-list",children:"Dependencies List"}),"\n",(0,c.jsxs)(n.p,{children:["\u65e0\u8bba\u662f\u5c06\u7ec4\u4ef6\u7f16\u5199\u4e3a\u7c7b\u8fd8\u662f\u51fd\u6570,\n\u90fd\u5fc5\u987b\u4e3a effect \u54cd\u5e94\u6240\u6709 props \u548c state \u7684\u66f4\u65b0\n(",(0,c.jsx)(n.code,{children:"Reactive Value"}),").\n\u5728\u4f20\u7edf\u7684 Class Component, \u9700\u8981\u7f16\u5199\u4ee3\u7801\u53bb\u68c0\u6d4b\u8fd9\u4e9b props \u548c state \u662f\u5426\u53d8\u66f4\n(",(0,c.jsx)(n.code,{children:"shouldComponentUpdate"}),", ",(0,c.jsx)(n.code,{children:"componentDidUpdate"}),").\n\u5728 Function Component, \u501f\u52a9 ",(0,c.jsx)(n.code,{children:"useEffect"})," \u53ef\u4ee5\u5b9e\u73b0\u81ea\u52a8\u68c0\u6d4b."]}),"\n",(0,c.jsxs)(n.p,{children:["If one of deps list changes, the hook runs again.\nProvide ",(0,c.jsx)(n.strong,{children:"empty array"})," as second argument to the effect hook\nto avoid activating it on component updates\nbut ",(0,c.jsx)(n.strong,{children:"only for the mounting"})," of the component.\nFor listeners binding, use ",(0,c.jsx)(n.code,{children:"[]"})," deps list should be better."]}),"\n",(0,c.jsx)(n.h3,{id:"omits",children:"Omits"}),"\n",(0,c.jsx)(n.p,{children:"Omit stable values from the deps list:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"set"})," function returned from ",(0,c.jsx)(n.code,{children:"useState"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"ref"})," object returned from ",(0,c.jsx)(n.code,{children:"useRef"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"export default function App() {\n  const [count, setCount] = useState(0)\n  const countRef = useRef(count)\n\n  useEffect(() => {\n    countRef.current = count\n  }, [count]) // \u2705 Only count is declared.\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"primitives",children:"Primitives"}),"\n",(0,c.jsxs)(n.p,{children:["Primitive values are ",(0,c.jsx)(n.a,{href:"https://react.dev/learn/removing-effect-dependencies",children:"better"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function ChatRoom({ options }) {\n  const [message, setMessage] = useState('')\n  const { roomId, serverUrl } = options\n\n  useEffect(() => {\n    const connection = createConnection({\n      roomId,\n      serverUrl,\n    })\n    connection.connect()\n    return () => connection.disconnect()\n  }, [roomId, serverUrl]) // \u2705 All dependencies declared\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"functions",children:"Functions"}),"\n",(0,c.jsxs)(n.p,{children:["Functions in ",(0,c.jsx)(n.code,{children:"useEffect"}),":"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"If only use some functions inside an effect, move them directly into that effect."}),"\n",(0,c.jsx)(n.li,{children:"Hoisting functions that don\u2019t need props or state outside of component,\nand pull the ones that are used only by an effect inside of that effect."}),"\n",(0,c.jsxs)(n.li,{children:["For useCallback function, it should be in deps list ",(0,c.jsx)(n.code,{children:"useEffect(() => {}, [callback])"})]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"import axios from 'axios'\n// https://www.robinwieruch.de/react-hooks-fetch-data\nimport { useEffect, useState } from 'react'\n\nfunction useDataApi(initialUrl, initialData) {\n  const [data, setData] = useState(initialData)\n  const [url, setUrl] = useState(initialUrl)\n  const [isLoading, setIsLoading] = useState(false)\n  const [isError, setIsError] = useState(false)\n\n  useEffect(() => {\n    const fetchData = async () => {\n      setIsError(false)\n      setIsLoading(true)\n\n      try {\n        const result = await axios(url)\n\n        setData(result.data)\n      } catch (error) {\n        setIsError(true)\n      }\n\n      setIsLoading(false)\n    }\n\n    fetchData()\n  }, [url])\n\n  const doFetch = (url) => {\n    setUrl(url)\n  }\n\n  return { data, isLoading, isError, doFetch }\n}\n"})}),"\n",(0,c.jsx)(n.h3,{id:"comparison",children:"Comparison"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"import { DependencyList, EffectCallback, useEffect, useRef } from 'react'\n\nconst isPrimitive = (val: any) => val !== Object(val)\n\ntype DepsEqualFnType<TDeps extends DependencyList>\n  = (prevDeps: TDeps, nextDeps: TDeps) => boolean\n\nexport default function useCustomCompareEffect<TDeps extends DependencyList>(\n  effect: EffectCallback,\n  deps: TDeps,\n  depsEqual: DepsEqualFnType<TDeps>,\n) {\n  const ref = useRef<TDeps | undefined>(undefined)\n\n  if (!ref.current || !depsEqual(deps, ref.current)) {\n    ref.current = deps\n  }\n\n  useEffect(effect, ref.current)\n}\n"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"import { DependencyList, EffectCallback } from 'react'\nimport fastDeepEqual from './misc/fastDeepEqual'\nimport useCustomCompareEffect from './useCustomCompareEffect'\n\nconst isPrimitive = (val: any) => val !== Object(val)\n\nexport default function useDeepCompareEffect(\n  effect: EffectCallback,\n  deps: DependencyList,\n) {\n  useCustomCompareEffect(effect, deps, fastDeepEqual)\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"closure",children:"Closure"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"useEffect Hook \u4f1a\u4e22\u5f03\u4e0a\u4e00\u6b21\u6e32\u67d3\u7ed3\u679c,\n\u5b83\u4f1a\u6e05\u9664\u4e0a\u4e00\u6b21 effect,\n\u518d\u5efa\u7acb\u4e0b\u4e00\u4e2a effect\n(\u4e5f\u4f1a\u521b\u5efa\u65b0\u7684 Closure),\n\u4e0b\u4e00\u4e2a effect \u9501\u4f4f\u65b0\u7684 props \u548c state\n(\u6574\u4e2a Counter \u51fd\u6570\u5728 re-render \u65f6\u4f1a\u88ab\u91cd\u590d\u8c03\u7528\u4e00\u6b21)."}),"\n",(0,c.jsx)(n.li,{children:"setInterval \u4e0d\u4f1a\u4e22\u5f03\u4e0a\u4e00\u6b21\u7ed3\u679c,\n\u4f1a\u5f15\u7528\u65e7\u72b6\u6001 Closure \u4e2d\u7684\u53d8\u91cf,\n\u5bfc\u81f4\u5176\u4e0e useEffect \u6240\u9884\u671f\u884c\u4e3a\u4e0d\u4e00\u81f4."}),"\n",(0,c.jsx)(n.li,{children:"\u53ef\u4ee5\u901a\u8fc7 useRef \u89e3\u51b3\u8fd9\u4e00\u73b0\u8c61: get latest value."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"// BUG\nexport default function Counter() {\n  const [count, setCount] = useState(0)\n\n  useEffect(() => {\n    const id = setInterval(() => {\n      setCount(count + 1) // always 1 regardless `count` value change\n    }, 1000)\n    return () => clearInterval(id)\n  }, [])\n\n  return <h1>{count}</h1>\n}\n"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"export default function Counter() {\n  const [count, setCount] = useState(0)\n\n  useInterval(() => {\n    setCount(count + 1)\n  }, 1000)\n\n  return <h1>{count}</h1>\n}\n\nfunction useInterval(callback, delay) {\n  const savedCallback = useRef(callback)\n\n  // Remember the latest callback if it changes\n  useEffect(() => {\n    savedCallback.current = callback\n  }, [callback])\n\n  // Set up the interval\n  useEffect(() => {\n    function tick() {\n      savedCallback.current()\n    }\n\n    const id = setInterval(tick, delay)\n    return () => clearInterval(id)\n  }, [delay])\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"state",children:"State"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u5982 ",(0,c.jsx)(n.code,{children:"UseEffect Closure"})," \u6240\u8ff0, \u6bcf\u6b21\u8c03\u7528 useEffect \u65f6,\n\u4f1a\u6355\u83b7\u90a3\u4e00\u6b21 render \u65f6\u7684 props \u548c state."]}),"\n",(0,c.jsx)(n.li,{children:"Class Component \u4e2d\u7684 this.state.xxx \u5374\u603b\u662f\u6307\u5411\u6700\u65b0\u7684 state."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"export default function Counter() {\n  const [count, setCount] = useState(0)\n\n  useEffect(() => {\n    const timeout = setTimeout(() => {\n      console.log(`You clicked ${count} times`)\n    }, 3000)\n\n    return () => clearTimeout(timeout)\n  })\n\n  return (\n    <div>\n      <p>\n        You clicked\n        {' '}\n        {count}\n        {' '}\n        times\n      </p>\n      <button type=\"button\" onClick={() => setCount(count + 1)}>Click me</button>\n    </div>\n  )\n}\n// Output:\n// Mounted: You clicked 0 times\n// Clicked 5 times in 3s\n// You clicked 1 times\n// You clicked 2 times\n// You clicked 3 times\n// You clicked 4 times\n// You clicked 5 times\n"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"class Counter {\n  componentDidUpdate() {\n    setTimeout(() => {\n      console.log(`You clicked ${this.state.count} times`)\n    }, 3000)\n  }\n\n  render() {\n    const { count } = this.props\n\n    return (\n      <div>\n        <p>\n          You clicked\n          {' '}\n          {count}\n          {' '}\n          times\n        </p>\n        <button type=\"button\" onClick={() => this.setState(count + 1)}>Click me</button>\n      </div>\n    )\n  }\n}\n// Output:\n// Mounted: You clicked 0 times\n// Clicked 5 times in 3s\n// You clicked 5 times\n// You clicked 5 times\n// You clicked 5 times\n// You clicked 5 times\n// You clicked 5 times\n"})}),"\n",(0,c.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Avoid memory leaks."}),"\n",(0,c.jsx)(n.li,{children:"Prevent unexpected errors."}),"\n",(0,c.jsx)(n.li,{children:"Good user experience."}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["Cleanup API requests (",(0,c.jsx)(n.a,{href:"https://maxrozen.com/race-conditions-fetching-data-react-with-useeffect",children:"race condition"}),":"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Boolean"})," flag."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"AbortController"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function App({ url }) {\n  const [results, setResults] = useState([])\n  const [page, setPage] = useState(1)\n\n  // Cleanup with Boolean flag:\n  useEffect(() => {\n    let ignore = false\n    fetchResults(url, page).then((json) => {\n      if (!ignore)\n        setResults(json)\n    })\n    return () => {\n      ignore = true\n    }\n  }, [url, page])\n\n  // Cleanup with AbortController:\n  useEffect(() => {\n    const controller = new AbortController()\n    const { signal } = controller\n\n    const fetchData = async () => {\n      const response = await fetch(url, { signal })\n      const json = await response.json()\n      setResults(json)\n    }\n\n    fetchData()\n\n    return () => controller.abort()\n  }, [url])\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"Cleanup connections:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function App() {\n  useEffect(() => {\n    const socket = new WebSocket('url', protocols)\n    // do what you want with the socket\n\n    return () => socket.close()\n  }, [])\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"Cleanup timeouts:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function App() {\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      // do something in the timeout\n    }, 3000)\n\n    return () => clearTimeout(timeoutId)\n  }, [])\n}\n"})}),"\n",(0,c.jsxs)(n.admonition,{title:"React 18 Development Strict Mode",type:"caution",children:[(0,c.jsxs)(n.p,{children:["With ",(0,c.jsx)(n.code,{children:"Strict Mode"})," in React 18,\nReact will simulate unmounting and remounting component in development mode:"]}),(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["React mounts component:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Layout effects are created."}),"\n",(0,c.jsx)(n.li,{children:"Effect effects are created."}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["React simulates unmounting component:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Layout effects are destroyed."}),"\n",(0,c.jsx)(n.li,{children:"Effects are destroyed."}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["React simulates mounting component with previous state:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Layout effect setup code runs."}),"\n",(0,c.jsx)(n.li,{children:"Effect setup code runs."}),"\n"]}),"\n"]}),"\n"]}),(0,c.jsxs)(n.p,{children:["When ",(0,c.jsx)(n.code,{children:"Strict Mode"})," is on,\nremounts twice helps find out ",(0,c.jsx)(n.code,{children:"Effects"})," need cleanup\nand exposes bugs like race conditions early."]})]}),"\n",(0,c.jsx)(n.h2,{id:"useeffect",children:"useEffect"}),"\n",(0,c.jsxs)(n.p,{children:["Effects are typically used to\n",(0,c.jsx)(n.a,{href:"https://react.dev/learn/synchronizing-with-effects",children:"synchronize with external system"}),":\nbrowser APIs,\nthird-party library,\nnetwork, and so on."]}),"\n",(0,c.jsx)(n.p,{children:"Effects let you specify side effects that are caused by rendering itself,\nrather than by a particular event:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Sending a message in the chat is an event\nbecause it is directly caused by user clicking a specific button:\nput it in ",(0,c.jsx)(n.code,{children:"handleClick()"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["However, setting up a server connection is an ",(0,c.jsx)(n.code,{children:"Effect"}),"\nbecause it needs to happen regardless of\nwhich interaction caused the component to appear:\nput int in ",(0,c.jsx)(n.code,{children:"useEffect()"}),"."]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["If your effect only adjusts some state based on other state,\n",(0,c.jsx)(n.a,{href:"https://react.dev/learn/you-might-not-need-an-effect",children:"you might not need effects"}),":"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"You don\u2019t need Effects to transform data for rendering."}),"\n",(0,c.jsx)(n.li,{children:"You don\u2019t need Effects to handle user events."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function handleClick() {\n  // \u2705 Buying is an event because it is caused by a particular interaction.\n  fetch('/api/buy', { method: 'POST' })\n  showNotification(`Added ${product.name} to the shopping cart!`)\n  navigateTo('/checkout')\n}\n\nfunction Form() {\n  const [firstName, setFirstName] = useState('')\n  const [lastName, setLastName] = useState('')\n\n  // \u2705 Good: calculated during rendering\n  const fullName = `${firstName} ${lastName}`\n\n  // \u2705 Good: This logic runs because the component was displayed\n  useEffect(() => {\n    post('/analytics/event', { eventName: 'visit_form' })\n  }, [])\n\n  function handleSubmit(e) {\n    e.preventDefault()\n    // \u2705 Good: Event-specific logic is in the event handler\n    post('/api/register', { firstName, lastName })\n  }\n  // ...\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"uselayouteffect",children:"useLayoutEffect"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useLayoutEffect"})," callback called ",(0,c.jsx)(n.strong,{children:"synchronously"}),"\n(fires synchronously after all DOM mutations),\nsubstitute for ",(0,c.jsx)(n.code,{children:"componentDidMount"})," lifecycle function:\n",(0,c.jsx)(n.code,{children:"Update"})," effect flags, ",(0,c.jsx)(n.code,{children:"HasEffect | Layout"})," hook flags."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," got invoked after ",(0,c.jsx)(n.code,{children:"componentDidMount"})," ",(0,c.jsx)(n.strong,{children:"asynchronously"}),":\n",(0,c.jsx)(n.code,{children:"Update | Passive"})," effect flags, ",(0,c.jsx)(n.code,{children:"HasEffect | Passive"})," hook flags."]}),"\n",(0,c.jsxs)(n.li,{children:["Lifecycle of React component:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"User interacts, props or state change."}),"\n",(0,c.jsx)(n.li,{children:"React updates DOM."}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useLayoutEffect"})," hook fires."]}),"\n",(0,c.jsx)(n.li,{children:"Browser paints: visual changes are displayed to user."}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," hook fires."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["If need to mutate DOM directly (visual changes to UI)\nor need to perform DOM measurements,\n",(0,c.jsx)(n.code,{children:"useLayoutEffect"})," is better than ",(0,c.jsx)(n.code,{children:"useEffect"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"function mountLayoutEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return mountEffectImpl(\n    UpdateEffect, // Fiber Flags\n    HookLayout, // Hook Flags\n    create,\n    deps\n  )\n}\n\nfunction mountEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return mountEffectImpl(\n    UpdateEffect | PassiveEffect, // Fiber Flags\n    HookPassive, // Hook Flags\n    create,\n    deps\n  )\n}\n\nfunction updateLayoutEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return updateEffectImpl(UpdateEffect, HookLayout, create, deps)\n}\n\nfunction updateEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null\n): void {\n  return updateEffectImpl(PassiveEffect, HookPassive, create, deps)\n}\n"})}),"\n",(0,c.jsx)(n.h2,{id:"useinsertioneffect",children:"useInsertionEffect"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.a,{href:"https://github.com/reactwg/react-18/discussions/110",children:(0,c.jsx)(n.code,{children:"useInsertionEffect"})}),"\nallows ",(0,c.jsx)(n.code,{children:"CSS-in-JS"})," libraries to address performance\nissues of injecting styles in render:"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"useInsertionEffect"})," will run after the DOM is mutated,\nbut before layout effects read the new layout."]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-tsx",children:"function useCSS(rule) {\n  if (!canUseDOM)\n    collectedRulesSet.add(rule)\n\n  useInsertionEffect(() => {\n    if (!isInserted.has(rule)) {\n      isInserted.add(rule)\n      document.head.appendChild(getStyleForRule(rule))\n    }\n  })\n\n  return rule\n}\n\nexport default function Component() {\n  const className = useCSS(rule)\n  return <div className={className} />\n}\n"})}),"\n",(0,c.jsx)(n.p,{children:"In commit phase, the ordering of effects are:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Insertion Effects - ",(0,c.jsx)(n.code,{children:"useInsertionEffect()"}),"."]}),"\n",(0,c.jsx)(n.li,{children:"Mutation Effects - host DOM updates diffed from reconciliation."}),"\n",(0,c.jsxs)(n.li,{children:["Layout Effects - ",(0,c.jsx)(n.code,{children:"useLayoutEffect()"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["Passive Effects - ",(0,c.jsx)(n.code,{children:"useEffect()"}),"."]}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:["It is synchronous from 1 to 3, the last step of Passive Effects are run\n",(0,c.jsx)(n.a,{href:"https://jser.dev/react/2022/01/19/lifecycle-of-effect-hook/#flushpassiveeffects",children:"in next tick"}),"."]}),"\n",(0,c.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," complete ",(0,c.jsx)(n.a,{href:"https://overreacted.io/a-complete-guide-to-useeffect",children:"guide"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"useEffect"})," usage ",(0,c.jsx)(n.a,{href:"https://react.dev/learn/you-might-not-need-an-effect",children:"guide"}),"."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},86145:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var s=t(57140);const c={},o=s.createContext(c);function r(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);