"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[28835],{93705:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"web/react/event","title":"Synthetic Events","description":"- Events delegation:","source":"@site/content/web/react/event.md","sourceDirName":"web/react","slug":"/web/react/event","permalink":"/notes/web/react/event","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/event.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Event","permalink":"/notes/tags/event"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"tags":["Web","React","Event"]},"sidebar":"tutorialSidebar","previous":{"title":"State","permalink":"/notes/web/react/state"},"next":{"title":"Types","permalink":"/notes/web/react/types"}}');var i=t(35656),s=t(86145);const a={sidebar_position:3,tags:["Web","React","Event"]},o="Synthetic Events",l={},c=[];function v(e){const n={a:"a",code:"code",h1:"h1",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"synthetic-events",children:"Synthetic Events"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Events delegation:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["React 16: delegate events handlers on ",(0,i.jsx)(n.code,{children:"document"})," DOM node."]}),"\n",(0,i.jsxs)(n.li,{children:["React 17: delegate events handlers on ",(0,i.jsx)(n.code,{children:"app"})," root DOM node."]}),"\n",(0,i.jsx)(n.li,{children:"\u5148\u5904\u7406\u539f\u751f\u4e8b\u4ef6, \u540e\u5904\u7406 React \u4e8b\u4ef6."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Events dispatching: dispatch native events to ",(0,i.jsx)(n.code,{children:"React.onXXX"})," handlers by ",(0,i.jsx)(n.code,{children:"SyntheticEvent"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u6536\u96c6\u76d1\u542c\u5668: ",(0,i.jsx)(n.code,{children:"const listeners = accumulateSinglePhaseListeners(targetFiber, eventName)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u6d3e\u53d1\u5408\u6210\u4e8b\u4ef6: ",(0,i.jsx)(n.code,{children:"dispatchQueue.push({ new SyntheticEvent(eventName), listeners })"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u6267\u884c\u6d3e\u53d1:\n",(0,i.jsx)(n.code,{children:"processDispatchQueue(dispatchQueue, eventSystemFlags)"}),"\n-> ",(0,i.jsx)(n.code,{children:"executeDispatch(event, listener, currentTarget)"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Capture event: \u4ece\u4e0a\u81f3\u4e0b\u8c03\u7528 Fiber \u6811\u4e2d\u7ed1\u5b9a\u7684\u56de\u8c03\u51fd\u6570."}),"\n",(0,i.jsx)(n.li,{children:"Bubble event: \u4ece\u4e0b\u81f3\u4e0a\u8c03\u7528 Fiber \u6811\u4e2d\u7ed1\u5b9a\u7684\u56de\u8c03\u51fd\u6570."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://7kms.github.io/react-illustration-series/main/synthetic-event",children:(0,i.jsx)(n.img,{alt:"React Synthetic Events",src:t(98490).A+"",width:"1090",height:"1248"})})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-dom/src/events/DOMPluginEventSystem.js",children:"react-dom/src/events/DOMPluginEventSystem"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function listenToAllSupportedEvents(rootContainerElement: EventTarget) {\n  if (enableEagerRootListeners) {\n    // 1. \u8282\u6d41\u4f18\u5316, \u4fdd\u8bc1\u5168\u5c40\u6ce8\u518c\u53ea\u88ab\u8c03\u7528\u4e00\u6b21.\n    if (rootContainerElement[listeningMarker])\n      return\n\n    rootContainerElement[listeningMarker] = true\n\n    // 2. \u904d\u5386 allNativeEvents \u76d1\u542c\u5192\u6ce1\u548c\u6355\u83b7\u9636\u6bb5\u7684\u4e8b\u4ef6.\n    allNativeEvents.forEach((domEventName) => {\n      if (!nonDelegatedEvents.has(domEventName)) {\n        listenToNativeEvent(\n          domEventName,\n          false, // \u5192\u6ce1\u9636\u6bb5\u76d1\u542c.\n          rootContainerElement,\n          null,\n        )\n      }\n\n      listenToNativeEvent(\n        domEventName,\n        true, // \u6355\u83b7\u9636\u6bb5\u76d1\u542c.\n        rootContainerElement,\n        null,\n      )\n    })\n  }\n}\n\nfunction listenToNativeEvent(\n  domEventName: DOMEventName,\n  isCapturePhaseListener: boolean,\n  rootContainerElement: EventTarget,\n  targetElement: Element | null,\n  eventSystemFlags?: EventSystemFlags = 0,\n): void {\n  const target = rootContainerElement\n  const listenerSet = getEventListenerSet(target)\n  const listenerSetKey = getListenerSetKey(domEventName, isCapturePhaseListener)\n\n  // \u5229\u7528 Set \u6570\u636e\u7ed3\u6784, \u4fdd\u8bc1\u76f8\u540c\u7684\u4e8b\u4ef6\u7c7b\u578b\u53ea\u4f1a\u88ab\u6ce8\u518c\u4e00\u6b21.\n  if (!listenerSet.has(listenerSetKey)) {\n    if (isCapturePhaseListener)\n      eventSystemFlags |= IS_CAPTURE_PHASE\n\n    // \u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c.\n    addTrappedEventListener(\n      target,\n      domEventName,\n      eventSystemFlags,\n      isCapturePhaseListener,\n    )\n    listenerSet.add(listenerSetKey)\n  }\n}\n\nfunction addTrappedEventListener(\n  targetContainer: EventTarget,\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n  isCapturePhaseListener: boolean,\n  isDeferredListenerForLegacyFBSupport?: boolean,\n) {\n  // 1. \u6784\u9020 listener.\n  const listener = createEventListenerWrapperWithPriority(\n    targetContainer,\n    domEventName,\n    eventSystemFlags,\n  )\n\n  // 2. \u6ce8\u518c\u4e8b\u4ef6\u76d1\u542c.\n  let unsubscribeListener\n\n  if (isCapturePhaseListener) {\n    unsubscribeListener = addEventCaptureListener(\n      targetContainer,\n      domEventName,\n      listener,\n    )\n  } else {\n    unsubscribeListener = addEventBubbleListener(\n      targetContainer,\n      domEventName,\n      listener,\n    )\n  }\n}\n\n// \u6ce8\u518c\u539f\u751f\u5192\u6ce1\u4e8b\u4ef6.\nfunction addEventBubbleListener(\n  target: EventTarget,\n  eventType: string,\n  listener: Function,\n): Function {\n  target.addEventListener(eventType, listener, false)\n  return listener\n}\n\n// \u6ce8\u518c\u539f\u751f\u6355\u83b7\u4e8b\u4ef6.\nfunction addEventCaptureListener(\n  target: EventTarget,\n  eventType: string,\n  listener: Function,\n): Function {\n  target.addEventListener(eventType, listener, true)\n  return listener\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-dom/src/events/ReactDOMEventListener.js",children:"react-dom/src/events/ReactDOMEventListener"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// \u6d3e\u53d1\u539f\u751f\u4e8b\u4ef6\u81f3 React.onXXX.\nfunction createEventListenerWrapperWithPriority(\n  targetContainer: EventTarget,\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n): Function {\n  // 1. \u6839\u636e\u4f18\u5148\u7ea7\u8bbe\u7f6e listenerWrapper.\n  const eventPriority = getEventPriorityForPluginSystem(domEventName)\n  let listenerWrapper\n\n  switch (eventPriority) {\n    case DiscreteEvent:\n      listenerWrapper = dispatchDiscreteEvent\n      break\n    case UserBlockingEvent:\n      listenerWrapper = dispatchUserBlockingUpdate\n      break\n    case ContinuousEvent:\n    default:\n      listenerWrapper = dispatchEvent\n      break\n  }\n\n  // 2. \u8fd4\u56de listenerWrapper.\n  return listenerWrapper.bind(\n    null,\n    domEventName,\n    eventSystemFlags,\n    targetContainer,\n  )\n}\n\nfunction dispatchDiscreteEvent(\n  domEventName,\n  eventSystemFlags,\n  container,\n  nativeEvent,\n) {\n  const previousPriority = getCurrentUpdatePriority()\n  const prevTransition = ReactCurrentBatchConfig.transition\n  ReactCurrentBatchConfig.transition = null\n\n  try {\n    setCurrentUpdatePriority(DiscreteEventPriority)\n    dispatchEvent(domEventName, eventSystemFlags, container, nativeEvent)\n  } finally {\n    setCurrentUpdatePriority(previousPriority)\n    ReactCurrentBatchConfig.transition = prevTransition\n  }\n}\n\nfunction dispatchContinuousEvent(\n  domEventName,\n  eventSystemFlags,\n  container,\n  nativeEvent,\n) {\n  const previousPriority = getCurrentUpdatePriority()\n  const prevTransition = ReactCurrentBatchConfig.transition\n  ReactCurrentBatchConfig.transition = null\n\n  try {\n    setCurrentUpdatePriority(ContinuousEventPriority)\n    dispatchEvent(domEventName, eventSystemFlags, container, nativeEvent)\n  } finally {\n    setCurrentUpdatePriority(previousPriority)\n    ReactCurrentBatchConfig.transition = prevTransition\n  }\n}\n\nfunction dispatchEvent(\n  domEventName: DOMEventName,\n  eventSystemFlags: EventSystemFlags,\n  targetContainer: EventTarget,\n  nativeEvent: AnyNativeEvent,\n) {\n  let blockedOn = findInstanceBlockingEvent(\n    domEventName,\n    eventSystemFlags,\n    targetContainer,\n    nativeEvent,\n  )\n\n  if (blockedOn === null) {\n    dispatchEventForPluginEventSystem(\n      domEventName,\n      eventSystemFlags,\n      nativeEvent,\n      return_targetInst,\n      targetContainer,\n    )\n    clearIfContinuousEvent(domEventName, nativeEvent)\n    return\n  }\n\n  if (\n    queueIfContinuousEvent(\n      blockedOn,\n      domEventName,\n      eventSystemFlags,\n      targetContainer,\n      nativeEvent,\n    )\n  ) {\n    nativeEvent.stopPropagation()\n    return\n  }\n\n  // We need to clear only if we didn't queue because queueing is accumulative.\n  clearIfContinuousEvent(domEventName, nativeEvent)\n\n  if (\n    eventSystemFlags & IS_CAPTURE_PHASE\n    && isDiscreteEventThatRequiresHydration(domEventName)\n  ) {\n    while (blockedOn !== null) {\n      const fiber = getInstanceFromNode(blockedOn)\n\n      if (fiber !== null)\n        attemptSynchronousHydration(fiber)\n\n      const nextBlockedOn = findInstanceBlockingEvent(\n        domEventName,\n        eventSystemFlags,\n        targetContainer,\n        nativeEvent,\n      )\n\n      if (nextBlockedOn === null) {\n        dispatchEventForPluginEventSystem(\n          domEventName,\n          eventSystemFlags,\n          nativeEvent,\n          return_targetInst,\n          targetContainer,\n        )\n      }\n\n      if (nextBlockedOn === blockedOn)\n        break\n\n      blockedOn = nextBlockedOn\n    }\n\n    if (blockedOn !== null)\n      nativeEvent.stopPropagation()\n\n    return\n  }\n\n  dispatchEventForPluginEventSystem(\n    domEventName,\n    eventSystemFlags,\n    nativeEvent,\n    null,\n    targetContainer,\n  )\n}\n"})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(v,{...e})}):v(e)}},98490:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/react-synthetic-events-4c0afc0525ad26f8ec7ec03816133710.png"},86145:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(57140);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);