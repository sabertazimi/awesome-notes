"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[89751],{81778:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"web/react/redux/query","title":"Query","description":"Server State","source":"@site/content/web/react/redux/query.md","sourceDirName":"web/react/redux","slug":"/web/react/redux/query","permalink":"/notes/web/react/redux/query","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/redux/query.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Redux","permalink":"/notes/tags/redux"},{"inline":true,"label":"State Management","permalink":"/notes/tags/state-management"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":4,"frontMatter":{"sidebar_position":4,"tags":["Web","React","Redux","State Management"]},"sidebar":"tutorialSidebar","previous":{"title":"Middleware","permalink":"/notes/web/react/redux/middleware"},"next":{"title":"Toolchain","permalink":"/notes/web/react/redux/toolchain"}}');var s=t(35656),i=t(86145);const o={sidebar_position:4,tags:["Web","React","Redux","State Management"]},a="Query",l={},c=[{value:"Server State",id:"server-state",level:2},{value:"APIs",id:"apis",level:2},{value:"Cache",id:"cache",level:2},{value:"Selector",id:"selector",level:2},{value:"Splitting Endpoints",id:"splitting-endpoints",level:2},{value:"Transform Response",id:"transform-response",level:2},{value:"References",id:"references",level:2}];function d(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"query",children:"Query"})}),"\n",(0,s.jsx)(r.h2,{id:"server-state",children:"Server State"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Tracking loading state in order to show UI spinners."}),"\n",(0,s.jsx)(r.li,{children:"Avoiding duplicate requests for the same data."}),"\n",(0,s.jsxs)(r.li,{children:["Optimistic updates to make the UI feel faster","\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Requires asynchronous APIs for fetching and updating."}),"\n",(0,s.jsxs)(r.li,{children:["Updating ",(0,s.jsx)(r.code,{children:"out of date"})," data in the background."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(r.li,{children:"Managing cache lifetimes as the user interacts with the UI."}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"https://redux-toolkit.js.org/rtk-query/overview",children:"RTK Query"}),"."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"https://github.com/tannerlinsley/react-query",children:"React Query"}),"."]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"apis",children:"APIs"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Query hooks."}),"\n",(0,s.jsx)(r.li,{children:"Mutation hooks."}),"\n",(0,s.jsx)(r.li,{children:"Refetch function."}),"\n",(0,s.jsx)(r.li,{children:"Cache tags."}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"// Import the RTK Query methods from the React-specific entry point.\r\nimport { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'\r\n\r\n// Define our single API slice object.\r\nexport const apiSlice = createApi({\r\n  // The cache reducer expects to be added at `state.api`.\r\n  reducerPath: 'api',\r\n  // All of our requests will have URLs starting with '/fakeApi'.\r\n  baseQuery: fetchBaseQuery({ baseUrl: '/fakeApi' }),\r\n  tagTypes: ['Post'],\r\n  // The \"endpoints\" represent operations and requests for this server.\r\n  endpoints: builder => ({\r\n    getPost: builder.query({\r\n      query: postId => `/posts/${postId}`,\r\n    }),\r\n    // The `getPosts` endpoint is a \"query\" operation that returns data.\r\n    getPosts: builder.query({\r\n      // The URL for the request is '/fakeApi/posts'.\r\n      query: () => '/posts',\r\n      providesTags: ['Post'],\r\n    }),\r\n    addNewPost: builder.mutation({\r\n      query: initialPost => ({\r\n        url: '/posts',\r\n        method: 'POST',\r\n        // Include the entire post object as the body of the request\r\n        body: initialPost,\r\n      }),\r\n      invalidatesTags: ['Post'],\r\n    }),\r\n  }),\r\n})\r\n\r\n// Export the auto-generated hook for the `getPost` query endpoint\r\nexport const { useGetPostQuery, useGetPostsQuery, useAddNewPostMutation }\r\n  = apiSlice\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { apiSlice } from '../features/api/apiSlice'\r\n\r\nexport default configureStore({\r\n  reducer: {\r\n    // ... Other reducers.\r\n    [apiSlice.reducerPath]: apiSlice.reducer,\r\n  },\r\n  middleware: getDefaultMiddleware =>\r\n    getDefaultMiddleware().concat(apiSlice.middleware),\r\n})\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-tsx",children:'import { useGetPostsQuery } from \'../api\'\r\nimport { PostExcerpt, Spinner } from \'../components\'\r\n\r\nexport function PostsList() {\r\n  const {\r\n    data: posts = [],\r\n    isLoading,\r\n    isSuccess,\r\n    isError,\r\n    error,\r\n    refetch,\r\n  } = useGetPostsQuery()\r\n\r\n  const sortedPosts = useMemo(\r\n    () => posts.slice().sort((a, b) => b.date.localeCompare(a.date)),\r\n    [posts]\r\n  )\r\n\r\n  let content\r\n\r\n  if (isLoading)\r\n    content = <Spinner text="Loading..." />\r\n  else if (isSuccess)\r\n    content = sortedPosts.map(post => <PostExcerpt key={post.id} post={post} />)\r\n  else if (isError)\r\n    content = <div>{error.toString()}</div>\r\n\r\n  return (\r\n    <section className="posts-list">\r\n      <h2>Posts</h2>\r\n      <button type="button" onClick={refetch}>Refetch Posts</button>\r\n      {content}\r\n    </section>\r\n  )\r\n}\n'})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-tsx",children:"import { useState } from 'react'\r\nimport { useAddNewPostMutation } from '../api'\r\n\r\nexport function AddPostForm() {\r\n  const [title, setTitle] = useState('')\r\n  const [content, setContent] = useState('')\r\n  const [userId, setUserId] = useState('')\r\n\r\n  const [addNewPost, { isLoading }] = useAddNewPostMutation()\r\n\r\n  const canSave = [title, content, userId].every(Boolean) && !isLoading\r\n\r\n  const onSavePostClicked = async () => {\r\n    if (canSave) {\r\n      try {\r\n        await addNewPost({ title, content, user: userId }).unwrap()\r\n        setTitle('')\r\n        setContent('')\r\n        setUserId('')\r\n      } catch (err) {\r\n        console.error('Failed to save the post: ', err)\r\n      }\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"cache",children:"Cache"}),"\n",(0,s.jsxs)(r.p,{children:["RTK Query creates a ",(0,s.jsx)(r.strong,{children:"cache key"})," for each ",(0,s.jsx)(r.code,{children:"unique endpoint"})," + ",(0,s.jsx)(r.code,{children:"argument"})," combination,\r\nand stores the results for each cache key separately."]}),"\n",(0,s.jsxs)(r.p,{children:["Use the same query hook multiple times,\r\npass it different query parameters,\r\nand each result will be cached separately in Redux ",(0,s.jsx)(r.code,{children:"store"}),"."]}),"\n",(0,s.jsxs)(r.p,{children:["It's important to note that the query parameter must be a ",(0,s.jsx)(r.strong,{children:"single value"}),"\r\n(a primitive value or an object containing multiple fields, same as with ",(0,s.jsx)(r.code,{children:"createAsyncThunk"}),").\r\nRTK Query will do ",(0,s.jsx)(r.strong,{children:"shallow stable"})," comparison of fields,\r\nand re-fetch the data if any of them have changed."]}),"\n",(0,s.jsxs)(r.p,{children:["By default, ",(0,s.jsx)(r.strong,{children:"unused data is removed from the cache after 60 seconds"}),",\r\ncan be configured in root API slice definition\r\nor overridden in individual endpoint definitions using ",(0,s.jsx)(r.code,{children:"keepUnusedDataFor"})," flag."]}),"\n",(0,s.jsxs)(r.p,{children:["RTK query ",(0,s.jsx)(r.a,{href:"https://redux-toolkit.js.org/rtk-query/api/created-api/cache-management-utils",children:"cache utils"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"export const apiSlice = createApi({\r\n  reducerPath: 'api',\r\n  baseQuery: fetchBaseQuery({ baseUrl: '/fakeApi' }),\r\n  tagTypes: ['Post'],\r\n  endpoints: builder => ({\r\n    getPosts: builder.query({\r\n      query: () => '/posts',\r\n      providesTags: (result = [], error, arg) => [\r\n        'Post',\r\n        ...result.map(({ id }) => ({ type: 'Post', id })),\r\n      ],\r\n    }),\r\n    getPost: builder.query({\r\n      query: postId => `/posts/${postId}`,\r\n      providesTags: (result, error, arg) => [{ type: 'Post', id: arg }],\r\n    }),\r\n    addNewPost: builder.mutation({\r\n      query: initialPost => ({\r\n        url: '/posts',\r\n        method: 'POST',\r\n        body: initialPost,\r\n      }),\r\n      invalidatesTags: ['Post'],\r\n    }),\r\n    editPost: builder.mutation({\r\n      query: post => ({\r\n        url: `posts/${post.id}`,\r\n        method: 'PATCH',\r\n        body: post,\r\n      }),\r\n      invalidatesTags: (result, error, arg) => [{ type: 'Post', id: arg.id }],\r\n    }),\r\n  }),\r\n})\n"})}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["The ",(0,s.jsx)(r.code,{children:"PATCH /posts/:postId"})," from the editPost mutation."]}),"\n",(0,s.jsxs)(r.li,{children:["A ",(0,s.jsx)(r.code,{children:"GET /posts/:postId"})," as the getPost query is refetched."]}),"\n",(0,s.jsxs)(r.li,{children:["A ",(0,s.jsx)(r.code,{children:"GET /posts"})," as the getPosts query is refetched."]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"selector",children:"Selector"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import {\r\n  createEntityAdapter,\r\n  createSelector,\r\n  createSlice,\r\n} from '@reduxjs/toolkit'\r\nimport { apiSlice } from '../api/apiSlice'\r\n\r\nconst emptyUsers = []\r\n\r\nexport const selectUsersResult = apiSlice.endpoints.getUsers.select()\r\n\r\nexport const selectAllUsers = createSelector(\r\n  selectUsersResult,\r\n  usersResult => usersResult?.data ?? emptyUsers\r\n)\r\n\r\nexport const selectUserById = createSelector(\r\n  selectAllUsers,\r\n  (state, userId) => userId,\r\n  (users, userId) => users.find(user => user.id === userId)\r\n)\n"})}),"\n",(0,s.jsx)(r.h2,{id:"splitting-endpoints",children:"Splitting Endpoints"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.a,{href:"https://redux-toolkit.js.org/rtk-query/usage/code-splitting",children:"RTK query code splitting"}),":"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"injectEndpoints()"}),":\r\nmutates original API slice object\r\nto add additional endpoint definitions\r\nand then returns it."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"enhanceEndpoints()"}),":\r\nmerged together on a per-definition basis."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"apiSlice"})," and ",(0,s.jsx)(r.code,{children:"extendedApiSlice"})," are the same object."]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { apiSlice } from '../api/apiSlice'\r\n\r\nexport const extendedApiSlice = apiSlice.injectEndpoints({\r\n  endpoints: builder => ({\r\n    getUsers: builder.query({\r\n      query: () => '/users',\r\n    }),\r\n  }),\r\n})\r\n\r\nexport const { useGetUsersQuery } = extendedApiSlice\r\n\r\nexport const selectUsersResult = extendedApiSlice.endpoints.getUsers.select()\n"})}),"\n",(0,s.jsx)(r.h2,{id:"transform-response",children:"Transform Response"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { apiSlice } from '../api/apiSlice'\r\n\r\nconst usersAdapter = createEntityAdapter()\r\n\r\nconst initialState = usersAdapter.getInitialState()\r\n\r\nexport const extendedApiSlice = apiSlice.injectEndpoints({\r\n  endpoints: builder => ({\r\n    getUsers: builder.query({\r\n      query: () => '/users',\r\n      transformResponse: (responseData) => {\r\n        return usersAdapter.setAll(initialState, responseData)\r\n      },\r\n    }),\r\n  }),\r\n})\r\n\r\nexport const { useGetUsersQuery } = extendedApiSlice\r\n\r\nconst selectUsersResult = extendedApiSlice.endpoints.getUsers.select()\r\n\r\nconst selectUsersData = createSelector(\r\n  selectUsersResult,\r\n  usersResult => usersResult.data\r\n)\r\n\r\nexport const { selectAll: selectAllUsers, selectById: selectUserById }\r\n  = usersAdapter.getSelectors(state => selectUsersData(state) ?? initialState)\n"})}),"\n",(0,s.jsx)(r.h2,{id:"references",children:"References"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["RTK Query real world ",(0,s.jsx)(r.a,{href:"https://www.toptal.com/react/redux-toolkit-and-rtk-query",children:"example"}),"."]}),"\n"]})]})}function u(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},86145:(e,r,t)=>{t.d(r,{R:()=>o,x:()=>a});var n=t(57140);const s={},i=n.createContext(s);function o(e){const r=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),n.createElement(i.Provider,{value:r},e.children)}}}]);