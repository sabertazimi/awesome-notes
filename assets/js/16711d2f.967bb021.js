"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[19573],{81707:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"web/react/update","title":"Update","description":"Update and Update Queue:","source":"@site/content/web/react/update.md","sourceDirName":"web/react","slug":"/web/react/update","permalink":"/notes/web/react/update","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/update.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Reconciler","permalink":"/notes/tags/reconciler"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":35,"frontMatter":{"sidebar_position":35,"tags":["Web","React","Internals","Reconciler"]},"sidebar":"tutorialSidebar","previous":{"title":"Render","permalink":"/notes/web/react/render"},"next":{"title":"Diff","permalink":"/notes/web/react/diff"}}');var s=r(35656),o=r(86145);const a={sidebar_position:35,tags:["Web","React","Internals","Reconciler"]},l="Update",i={},c=[];function d(e){const n={a:"a",code:"code",h1:"h1",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"update",children:"Update"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactUpdateQueue.js",children:"Update and Update Queue"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UpdateQueue"})," \u662f\u4e00\u4e2a",(0,s.jsx)(n.strong,{children:"\u5faa\u73af\u961f\u5217"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["\u521b\u5efa ",(0,s.jsx)(n.code,{children:"Update"})," \u65f6\u673a (",(0,s.jsx)(n.code,{children:"createUpdate"}),"/",(0,s.jsx)(n.code,{children:"enqueueUpdate"}),"):","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactFiberReconciler.updateContainer"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactFiberClassComponent.setState"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactFiberHooks.dispatchAction"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Reconciler.Render"})," \u9636\u6bb5, \u8c03\u7528 ",(0,s.jsx)(n.code,{children:"XXXClassInstance"}),"/",(0,s.jsx)(n.code,{children:"useXXX"}),",\n\u904d\u5386\u5904\u7406 Update Queue (",(0,s.jsx)(n.code,{children:"processUpdateQueue"}),"/",(0,s.jsx)(n.code,{children:"HooksDispatcherOnUpdate"}),"), \u8ba1\u7b97\u51fa memoizedState,\n\u5229\u7528 pendingProps \u4e0e memoizedState \u4ea7\u751f\u65b0\u7684 ReactElement (",(0,s.jsx)(n.code,{children:"ClassComponent.render()"}),"/",(0,s.jsx)(n.code,{children:"FunctionComponent()"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"interface Update<State> {\n  lane: Lane\n  tag: 'UpdateState' | 'ReplaceState' | 'ForceUpdate' | 'CaptureUpdate'\n  payload: any\n  callback: (() => mixed) | null\n  next: Update<State> | null\n  _eventTime: number\n}\n\ninterface SharedQueue<State> {\n  pending: Update<State> | null\n}\n\ninterface UpdateQueue<State> {\n  baseState: State\n  firstBaseUpdate: Update<State> | null\n  lastBaseUpdate: Update<State> | null\n  shared: SharedQueue<State>\n  effects: Array<Update<State>> | null // Updates with `callback`.\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberClassComponent.js",children:"ReactFiberClassComponent.setState"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const classComponentUpdater = {\n  isMounted,\n  enqueueSetState(inst, payload, callback) {\n    // 1. \u83b7\u53d6 ClassComponent \u5b9e\u4f8b\u5bf9\u5e94\u7684 Fiber \u8282\u70b9.\n    const fiber = getInstance(inst)\n    // 2. \u521b\u5efa Update \u5bf9\u8c61.\n    const eventTime = requestEventTime()\n    const lane = requestUpdateLane(fiber)\n    const update = createUpdate(eventTime, lane)\n    update.payload = payload\n\n    if (callback !== undefined && callback !== null)\n      update.callback = callback\n\n    // 3. \u5c06 Update \u5bf9\u8c61\u6dfb\u52a0\u5230\u5f53\u524d Fiber \u8282\u70b9\u7684 updateQueue.\n    enqueueUpdate(fiber, update)\n    // 4. \u8bf7\u6c42\u8c03\u5ea6, \u8fdb\u5165 Reconciler.\n    scheduleUpdateOnFiber(fiber, lane, eventTime)\n  },\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberHooks.js",children:"ReactFiberHooks.dispatchAction"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function dispatchAction<S, A>(\n  fiber: Fiber,\n  queue: UpdateQueue<S, A>,\n  action: A\n) {\n  // 1. \u521b\u5efa Update \u5bf9\u8c61.\n  const eventTime = requestEventTime()\n  const lane = requestUpdateLane(fiber)\n  const update: Update<S, A> = {\n    lane,\n    action,\n    eagerReducer: null,\n    eagerState: null,\n    next: null,\n  }\n\n  // 2. \u5c06 Update \u5bf9\u8c61\u6dfb\u52a0\u5230\u5f53\u524d Hook \u5bf9\u8c61\u7684 updateQueue.\n  const pending = queue.pending\n\n  if (pending === null) {\n    update.next = update\n  } else {\n    update.next = pending.next\n    pending.next = update\n  }\n\n  queue.pending = update\n\n  // 3. \u8bf7\u6c42\u8c03\u5ea6, \u8fdb\u5165 Reconciler.\n  scheduleUpdateOnFiber(fiber, lane, eventTime)\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"createUpdate."}),"\n",(0,s.jsx)(n.li,{children:"enqueueUpdate."}),"\n",(0,s.jsx)(n.li,{children:"scheduleUpdateOnFiber."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"markUpdateLaneFromFiberToRoot"}),":\n\u627e\u51fa Fiber \u6811\u4e2d\u53d7\u5230\u672c\u6b21 ",(0,s.jsx)(n.code,{children:"Update"})," \u5f71\u54cd\u7684\u6240\u6709\u8282\u70b9 (\u5b58\u5728\u66f4\u65b0\u53ef\u80fd),\n\u8bbe\u7f6e\u8fd9\u4e9b\u8282\u70b9\u7684 ",(0,s.jsx)(n.code,{children:"fiber.lanes"})," \u6216 ",(0,s.jsx)(n.code,{children:"fiber.childLanes"}),"."]}),"\n",(0,s.jsx)(n.li,{children:"ensureRootIsScheduled."}),"\n",(0,s.jsx)(n.li,{children:"flushSyncCallbacks."}),"\n",(0,s.jsx)(n.li,{children:"performSyncWorkOnRoot / performConcurrentWorkOnRoot."}),"\n",(0,s.jsx)(n.li,{children:"renderRootSync / renderRootConcurrent."}),"\n",(0,s.jsx)(n.li,{children:"workLoopSync / workLoopConcurrent."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"performUnitOfWork(workInProgress)"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"beginWork"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u82e5\u5224\u65ad\u5f53\u524d Fiber \u8282\u70b9\u65e0\u9700\u66f4\u65b0 (",(0,s.jsx)(n.code,{children:"lanes: 0, childLanes: ?"}),"), \u8c03\u7528 ",(0,s.jsx)(n.code,{children:"bailoutOnAlreadyFinishedWork"})," \u5faa\u73af\u68c0\u6d4b\u5b50\u8282\u70b9\u662f\u5426\u9700\u8981\u66f4\u65b0:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"instance.shouldComponentUpdate() === false"}),",\n",(0,s.jsx)(n.code,{children:"workInProgress.pendingProps === current.memoizedProps"}),",\n",(0,s.jsx)(n.code,{children:"hasLegacyContextChange() === false"}),",\n",(0,s.jsx)(n.code,{children:"checkIfContextChanged(fiber.dependencies) === false"}),",\n",(0,s.jsx)(n.code,{children:"includesSomeLane(fiber.lanes, renderLanes) === false"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["When it comes to ",(0,s.jsx)(n.code,{children:"lanes: 0, childLanes: 0"}),", skip it and its children (",(0,s.jsx)(n.strong,{children:"bailout"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["When it comes to ",(0,s.jsx)(n.code,{children:"lanes: 0, childLanes: 1"}),", continue to check its children."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\u82e5\u5224\u65ad\u5f53\u524d Fiber \u8282\u70b9\u9700\u8981\u66f4\u65b0 (",(0,s.jsx)(n.code,{children:"lanes: 1"}),"), \u8c03\u7528 ",(0,s.jsx)(n.code,{children:"updateXXXComponent"})," \u8fdb\u884c\u66f4\u65b0."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"bailoutOnAlreadyFinishedWork"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u82e5 ",(0,s.jsx)(n.code,{children:"includesSomeLane(renderLanes, workInProgress.childLanes) === false"}),"\n\u8868\u660e\u5b50\u8282\u70b9\u65e0\u9700\u66f4\u65b0, \u53ef\u76f4\u63a5\u8fdb\u5165\u56de\u6eaf\u9636\u6bb5 (",(0,s.jsx)(n.code,{children:"completeUnitOfWork"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["\u82e5 ",(0,s.jsx)(n.code,{children:"includesSomeLane(renderLanes, workInProgress.childLanes) === true"}),",\n\u8868\u660e\u5b50\u8282\u70b9\u9700\u8981\u66f4\u65b0, clone \u5e76\u8fd4\u56de\u5b50\u8282\u70b9."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"updateHostRoot/updateXXXComponent"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ReactClassComponent.render()"})," / ",(0,s.jsx)(n.code,{children:"ReactFunctionComponent()"})," / ",(0,s.jsx)(n.code,{children:"ReactDOMComponent.createElement()"}),":\n\u904d\u5386\u5904\u7406 Update Queue (",(0,s.jsx)(n.code,{children:"processUpdateQueue"}),"/",(0,s.jsx)(n.code,{children:"HooksDispatcherOnUpdate"}),"), \u8ba1\u7b97\u51fa memoizedState,\n\u5229\u7528 pendingProps \u4e0e memoizedState \u4ea7\u751f\u65b0\u7684 ReactElement."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"reconcileChildren"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u901a\u8fc7 ReactElement \u4e0e OldFiber, \u4ea7\u751f\u6216\u590d\u7528 ChildFiber."}),"\n",(0,s.jsxs)(n.li,{children:["\u8bbe\u7f6e ",(0,s.jsx)(n.code,{children:"fiber.flags"}),", \u6807\u8bb0\u526f\u4f5c\u7528: ",(0,s.jsx)(n.code,{children:"Placement"}),"/",(0,s.jsx)(n.code,{children:"Deletion"}),"/etc."]}),"\n",(0,s.jsxs)(n.li,{children:["\u5bf9\u4e8e ",(0,s.jsx)(n.code,{children:"Deletion"})," Fiber, \u5728 ",(0,s.jsx)(n.code,{children:"beginWork"})," \u9636\u6bb5\u63d0\u524d\u5c06\u5176\u6dfb\u52a0\u5230\u7236\u8282\u70b9\u7684 Effects \u961f\u5217\u4e2d\n(\u8be5\u8282\u70b9\u4f1a\u8131\u79bb Fiber \u6811, \u4e0d\u4f1a\u518d\u8fdb\u5165 ",(0,s.jsx)(n.code,{children:"completeWork"})," \u9636\u6bb5, \u65e0\u6cd5\u5728\u6b64\u9636\u6bb5\u6536\u96c6\u6b64\u8282\u70b9\u526f\u4f5c\u7528)."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"reconcileChildFibers."}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"completeUnitOfWork"}),": \u6536\u96c6\u526f\u4f5c\u7528."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"completeWork"}),": \u6536\u96c6\u526f\u4f5c\u7528."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// \u6807\u8bb0\u6240\u6709\u53ef\u80fd\u5b58\u5728\u66f4\u65b0\u7684\u8282\u70b9, \u5e76\u8bbe\u7f6e fiber.lanes \u4e0e fiber.childLanes.\nfunction markUpdateLaneFromFiberToRoot(\n  sourceFiber: Fiber, // \u88ab\u66f4\u65b0\u7684\u8282\u70b9.\n  lane: Lane\n): FiberRoot | null {\n  // \u8bbe\u7f6e sourceFiber.lanes.\n  sourceFiber.lanes = mergeLanes(sourceFiber.lanes, lane)\n  let alternate = sourceFiber.alternate\n\n  if (alternate !== null) {\n    // \u540c\u65f6\u8bbe\u7f6e sourceFiber.alternate.lanes.\n    alternate.lanes = mergeLanes(alternate.lanes, lane)\n  }\n\n  // \u4ece sourceFiber \u5f00\u59cb, \u5411\u4e0a\u904d\u5386\u6240\u6709 Fiber, \u76f4\u5230 HostRootFiber.\n  // \u8bbe\u7f6e\u6cbf\u9014\u6240\u6709 fiber.childLanes \u4e0e fiber.alternate.childLanes.\n  let node = sourceFiber\n  let parent = sourceFiber.return\n\n  while (parent !== null) {\n    parent.childLanes = mergeLanes(parent.childLanes, lane)\n    alternate = parent.alternate\n\n    if (alternate !== null)\n      alternate.childLanes = mergeLanes(alternate.childLanes, lane)\n\n    node = parent\n    parent = parent.return\n  }\n\n  if (node.tag === HostRoot) {\n    const root: FiberRoot = node.stateNode\n    return root\n  } else {\n    return null\n  }\n}\n\nfunction beginWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  const updateLanes = workInProgress.lanes\n\n  if (current !== null) {\n    // \u8fdb\u5165\u5bf9\u6bd4.\n    const oldProps = current.memoizedProps\n    const newProps = workInProgress.pendingProps\n    if (\n      oldProps !== newProps\n      || hasLegacyContextChanged()\n      || (__DEV__ ? workInProgress.type !== current.type : false)\n    ) {\n      didReceiveUpdate = true\n    } else if (!includesSomeLane(renderLanes, updateLanes)) {\n      // \u5f53\u524d\u6e32\u67d3\u4f18\u5148\u7ea7 renderLanes \u4e0d\u5305\u62ec fiber.lanes, \u8868\u660e\u5f53\u524d Fiber \u8282\u70b9\u65e0\u9700\u66f4\u65b0.\n      didReceiveUpdate = false\n      // \u8c03\u7528 bailoutOnAlreadyFinishedWork \u5faa\u73af\u68c0\u6d4b\u5b50\u8282\u70b9\u662f\u5426\u9700\u8981\u66f4\u65b0.\n      return bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes)\n    }\n  }\n\n  // \u5f53\u524d\u8282\u70b9\u9700\u8981\u66f4\u65b0.\n  workInProgress.lanes = NoLanes // \u6700\u9ad8\u4f18\u5148\u7ea7\n\n  switch (workInProgress.tag) {\n    case ClassComponent: {\n      const Component = workInProgress.type\n      const unresolvedProps = workInProgress.pendingProps\n      const resolvedProps\n        = workInProgress.elementType === Component\n          ? unresolvedProps\n          : resolveDefaultProps(Component, unresolvedProps)\n      return updateClassComponent(\n        current,\n        workInProgress,\n        Component,\n        resolvedProps,\n        renderLanes\n      )\n    }\n    case HostRoot:\n      return updateHostRoot(current, workInProgress, renderLanes)\n    case HostComponent:\n      return updateHostComponent(current, workInProgress, renderLanes)\n    case HostText:\n      return updateHostText(current, workInProgress)\n    case Fragment:\n      return updateFragment(current, workInProgress, renderLanes)\n  }\n}\n\nfunction bailoutOnAlreadyFinishedWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  if (!includesSomeLane(renderLanes, workInProgress.childLanes)) {\n    // \u6e32\u67d3\u4f18\u5148\u7ea7\u4e0d\u5305\u62ec workInProgress.childLanes, \u8868\u660e\u5b50\u8282\u70b9\u4e5f\u65e0\u9700\u66f4\u65b0.\n    // \u8fd4\u56de null, \u76f4\u63a5\u8fdb\u5165\u56de\u6eaf\u9636\u6bb5.\n    return null\n  } else {\n    // Fiber \u81ea\u8eab\u65e0\u9700\u66f4\u65b0, \u4f46\u5b50\u8282\u70b9\u9700\u8981\u66f4\u65b0, clone \u5e76\u8fd4\u56de\u5b50\u8282\u70b9.\n    cloneChildFibers(current, workInProgress)\n    return workInProgress.child\n  }\n}\n\nfunction completeWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  const newProps = workInProgress.pendingProps\n\n  switch (workInProgress.tag) {\n    case HostComponent: {\n      // \u975e\u6587\u672c\u8282\u70b9.\n      popHostContext(workInProgress)\n      const rootContainerInstance = getRootHostContainer()\n      const type = workInProgress.type\n\n      if (current !== null && workInProgress.stateNode !== null) {\n        // \u5904\u7406\u6539\u52a8.\n        updateHostComponent(\n          current,\n          workInProgress,\n          type,\n          newProps,\n          rootContainerInstance\n        )\n\n        if (current.ref !== workInProgress.ref)\n          markRef(workInProgress)\n      }\n\n      return null\n    }\n    case HostText: {\n      // \u6587\u672c\u8282\u70b9.\n      const newText = newProps\n\n      if (current !== null && workInProgress.stateNode !== null) {\n        const oldText = current.memoizedProps\n        // \u5904\u7406\u6539\u52a8.\n        updateHostText(current, workInProgress, oldText, newText)\n      }\n\n      return null\n    }\n  }\n}\n\nfunction updateHostComponent(\n  current: Fiber,\n  workInProgress: Fiber,\n  type: Type,\n  newProps: Props,\n  rootContainerInstance: Container\n) {\n  const oldProps = current.memoizedProps\n\n  if (oldProps === newProps)\n    return\n\n  const instance: Instance = workInProgress.stateNode\n  const currentHostContext = getHostContext()\n  const updatePayload = prepareUpdate(\n    instance,\n    type,\n    oldProps,\n    newProps,\n    rootContainerInstance,\n    currentHostContext\n  )\n  workInProgress.updateQueue = updatePayload\n\n  // \u5982\u679c\u6709\u5c5e\u6027\u53d8\u52a8, \u8bbe\u7f6e fiber.flags |= Update, \u7b49\u5f85 Commit \u9636\u6bb5\u5904\u7406.\n  if (updatePayload)\n    markUpdate(workInProgress)\n}\n\nfunction updateHostText(\n  current: Fiber,\n  workInProgress: Fiber,\n  oldText: string,\n  newText: string\n) {\n  // \u5982\u679c\u6709\u5c5e\u6027\u53d8\u52a8, \u8bbe\u7f6e fiber.flags |= Update, \u7b49\u5f85 Commit \u9636\u6bb5\u5904\u7406.\n  if (oldText !== newText)\n    markUpdate(workInProgress)\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},86145:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>l});var t=r(57140);const s={},o=t.createContext(s);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);