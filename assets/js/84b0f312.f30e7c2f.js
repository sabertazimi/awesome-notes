"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[421],{6348:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"web/typescript/narrowing","title":"Narrowing","description":"Type Inference","source":"@site/content/web/typescript/narrowing.md","sourceDirName":"web/typescript","slug":"/web/typescript/narrowing","permalink":"/notes/web/typescript/narrowing","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/typescript/narrowing.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"TypeScript","permalink":"/notes/tags/type-script"},{"inline":true,"label":"Narrowing","permalink":"/notes/tags/narrowing"},{"inline":true,"label":"Inference","permalink":"/notes/tags/inference"},{"inline":true,"label":"Infer","permalink":"/notes/tags/infer"},{"inline":true,"label":"Guard","permalink":"/notes/tags/guard"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":16,"frontMatter":{"sidebar_position":16,"tags":["Web","TypeScript","Narrowing","Inference","Infer","Guard"]},"sidebar":"tutorialSidebar","previous":{"title":"Utility","permalink":"/notes/web/typescript/utility"},"next":{"title":"Decorators","permalink":"/notes/web/typescript/decorator"}}');var s=r(35656),i=r(86145);const a={sidebar_position:16,tags:["Web","TypeScript","Narrowing","Inference","Infer","Guard"]},o="Narrowing",l={},c=[{value:"Type Inference",id:"type-inference",level:2},{value:"Type Guard",id:"type-guard",level:2},{value:"In",id:"in",level:3},{value:"Instance",id:"instance",level:3},{value:"TypeOf",id:"typeof",level:3},{value:"Discriminated Union",id:"discriminated-union",level:3},{value:"Never",id:"never",level:3},{value:"Exhaustiveness",id:"exhaustiveness",level:3},{value:"Excess Property",id:"excess-property",level:3},{value:"Type Predicate Signature",id:"type-predicate-signature",level:3},{value:"Type Assertion",id:"type-assertion",level:2},{value:"As",id:"as",level:3},{value:"Const",id:"const",level:3},{value:"Assertion Signature",id:"assertion-signature",level:3}];function d(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"narrowing",children:"Narrowing"})}),"\n",(0,s.jsx)(e.h2,{id:"type-inference",children:"Type Inference"}),"\n",(0,s.jsxs)(e.p,{children:["\u7c7b\u578b\u7cfb\u7edf\u5728\u83b7\u5f97\u8db3\u591f\u7684\u4fe1\u606f\u540e,\n\u80fd\u5c06 ",(0,s.jsx)(e.a,{href:"https://github.com/microsoft/TypeScript/pull/21496",children:(0,s.jsx)(e.code,{children:"infer"})})," \u540e\u8ddf\u968f\u7684\u7c7b\u578b\u53c2\u6570\u63a8\u5bfc\u51fa\u6765,\n\u6700\u540e\u8fd4\u56de\u8fd9\u4e2a\u63a8\u5bfc\u7ed3\u679c:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"type Parameters<T extends (...args: any) => any> = T extends (\n  ...args: infer P\n) => any\n  ? P\n  : never\n\ntype ConstructorParameters<T extends new (...args: any) => any>\n  = T extends new (...args: infer P) => any ? P : never\n\ntype ReturnType<T extends (...args: any) => any> = T extends (\n  ...args: any[]\n) => infer R\n  ? R\n  : any\n\ntype InstanceType<T extends new (...args: any) => any> = T extends new (\n  ...args: any\n) => infer R\n  ? R\n  : any\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u534f\u53d8\u4f4d\u7f6e\u4e0a, \u82e5\u540c\u4e00\u4e2a\u7c7b\u578b\u53d8\u91cf\u5b58\u5728\u591a\u4e2a\u5019\u9009\u8005, \u5219\u6700\u7ec8\u7684\u7c7b\u578b\u5c06\u88ab\u63a8\u65ad\u4e3a\u8054\u5408\u7c7b\u578b:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"type PropertyType<T> = T extends { id: infer U, name: infer U } ? U : never\n\ntype InferType = PropertyType<{\n  id: number\n  name: string\n}>\n// string | number\n"})}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u9006\u53d8\u4f4d\u7f6e\u4e0a, \u82e5\u540c\u4e00\u4e2a\u7c7b\u578b\u53d8\u91cf\u5b58\u5728\u591a\u4e2a\u5019\u9009\u8005, \u5219\u6700\u7ec8\u7684\u7c7b\u578b\u5c06\u88ab\u63a8\u65ad\u4e3a\u4ea4\u53c9\u7c7b\u578b:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"type PropertyType<T> = T extends {\n  a: (x: infer U) => void\n  b: (x: infer U) => void\n}\n  ? U\n  : never\n\ntype InferType = PropertyType<{\n  a: (x: string) => void\n  b: (x: number) => void\n}>\n// string & number\n\ntype UnionToIntersection<U> = (\n  U extends any ? (arg: U) => void : never\n) extends (arg: infer R) => void\n  ? R\n  : never\n\ntype UnionType = { a: 'a' } | { b: 'b' }\ntype IntersectionType = UnionToIntersection<UnionType>\n// { a: 'a' } & { b: 'b' }\n"})}),"\n",(0,s.jsx)(e.h2,{id:"type-guard",children:"Type Guard"}),"\n",(0,s.jsx)(e.h3,{id:"in",children:"In"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"interface Fish {\n  swim: () => void\n}\ninterface Bird {\n  fly: () => void\n}\n\nfunction move(animal: Fish | Bird) {\n  if ('swim' in animal)\n    return animal.swim()\n\n  return animal.fly()\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"instance",children:"Instance"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function logValue(x: Date | string) {\n  if (x instanceof Date)\n    console.log(x.toUTCString())\n  else\n    console.log(x.toUpperCase())\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"typeof",children:"TypeOf"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function fn(x: string | number) {\n  if (typeof x === 'string')\n    return x.length\n  else\n    return x + 1\n}\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function getScore(value: number | string): number {\n  switch (typeof value) {\n    case 'number':\n      // %inferred-type: number\n      return value + 1\n    case 'string':\n      // %inferred-type: string\n      return value.length\n    default:\n      throw new Error(`Unsupported value: ${value}`)\n  }\n}\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function contains(text: string, terms: string | string[]) {\n  const termList = Array.isArray(terms) ? terms : [terms]\n  console.log(termList) // string[]\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"discriminated-union",children:"Discriminated Union"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"interface Teacher {\n  kind: 'Teacher'\n  teacherId: string\n}\n\ninterface Student {\n  kind: 'Student'\n  studentId: string\n}\n\ntype Attendee = Teacher | Student\n\nfunction getId(attendee: Attendee) {\n  switch (attendee.kind) {\n    case 'Teacher':\n      // %inferred-type: { kind: \"Teacher\"; teacherId: string; }\n      return attendee.teacherId\n    case 'Student':\n      // %inferred-type: { kind: \"Student\"; studentId: string; }\n      return attendee.studentId\n    default:\n      throw new Error('Unsupported type')\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"never",children:"Never"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["The ",(0,s.jsx)(e.code,{children:"never"})," type is assignable to every type."]}),"\n",(0,s.jsxs)(e.li,{children:["No type is assignable to ",(0,s.jsx)(e.code,{children:"never"})," (except ",(0,s.jsx)(e.code,{children:"never"})," itself)."]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"interface Triangle {\n  kind: 'triangle'\n  sideLength: number\n}\n\ntype Shape = Circle | Square | Triangle\n\nfunction getArea(shape: Shape) {\n  switch (shape.kind) {\n    case 'circle':\n      return Math.PI * shape.radius ** 2\n    case 'square':\n      return shape.sideLength ** 2\n    default: {\n      // Type 'Triangle' is not assignable to type 'never'.\n      const _exhaustiveCheck: never = shape\n      return _exhaustiveCheck\n    }\n  }\n}\n"})}),"\n",(0,s.jsxs)(e.admonition,{title:"Never and Void",type:"tip",children:[(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u5f53\u4e00\u4e2a\u51fd\u6570\u8fd4\u56de\u7a7a\u503c\u65f6, \u5b83\u7684\u8fd4\u56de\u503c\u4e3a ",(0,s.jsx)(e.code,{children:"void"})," \u7c7b\u578b."]}),"\n",(0,s.jsxs)(e.li,{children:["\u5f53\u4e00\u4e2a\u51fd\u6570",(0,s.jsx)(e.strong,{children:"\u6c38\u4e0d\u8fd4\u56de"}),"\u65f6 (\u6216\u8005\u603b\u662f\u629b\u51fa\u9519\u8bef), \u5b83\u7684\u8fd4\u56de\u503c\u4e3a ",(0,s.jsx)(e.code,{children:"never"})," \u7c7b\u578b."]}),"\n",(0,s.jsxs)(e.li,{children:["\u5728 ",(0,s.jsx)(e.code,{children:"strictNullChecking"})," \u4e3a ",(0,s.jsx)(e.code,{children:"false"})," \u65f6, ",(0,s.jsx)(e.code,{children:"void"})," \u7c7b\u578b\u53ef\u4ee5\u88ab\u8d4b\u503c."]}),"\n",(0,s.jsxs)(e.li,{children:["\u9664\u4e86 ",(0,s.jsx)(e.code,{children:"never"})," \u672c\u8eab\u4ee5\u5916, \u5176\u4ed6\u4efb\u4f55\u7c7b\u578b\u4e0d\u80fd\u8d4b\u503c\u7ed9 ",(0,s.jsx)(e.code,{children:"never"}),"."]}),"\n"]}),(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function fail(message: string): never {\n  throw new Error(`Invariant failure: ${message}.`)\n}\n\nfunction workWithUnsafeParam(param: unknown) {\n  if (typeof param !== 'string')\n    fail(`Param should be a string, not ${typeof param}`)\n\n  // Here, param is known to be type string\n  param.toUpperCase() // Ok\n}\n"})})]}),"\n",(0,s.jsx)(e.h3,{id:"exhaustiveness",children:"Exhaustiveness"}),"\n",(0,s.jsxs)(e.p,{children:["Exhaustiveness check using ",(0,s.jsx)(e.code,{children:"never"})," in ",(0,s.jsx)(e.code,{children:"switch"})," statement:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"class UnsupportedValueError extends Error {\n  constructor(value: never) {\n    super(`Unsupported value: ${value}`)\n  }\n}\n\nfunction toGerman4(value: NoYesStrings): string {\n  switch (value) {\n    case 'Yes':\n      return 'Ja'\n    default:\n      // @ts-expect-error: Argument of type '\"No\"'\n      // is not assignable to parameter of type 'never'. (2345)\n      throw new UnsupportedValueError(value)\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"excess-property",children:"Excess Property"}),"\n",(0,s.jsx)(e.p,{children:"Excess property check:\ntypes check on assigning object literal to variable/function parameter."}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"interface Room {\n  numDoors: number\n  ceilingHeightFt: number\n}\n\nconst r: Room = {\n  numDoors: 1,\n  ceilingHeightFt: 10,\n  elephant: 'present',\n  // Excess property check:\n  // Object literal may only specify known properties,\n  // and 'elephant' does not exist in type 'Room'.\n}\n\nenterRoom({\n  numDoors: 1,\n  ceilingHeightFt: 10,\n  elephant: 'present',\n})\n// Excess property check:\n// Object literal may only specify known properties,\n// and 'elephant' does not exist in type 'Room'.\n\n// Normal structural types check\nconst obj = {\n  numDoors: 1,\n  ceilingHeightFt: 10,\n  elephant: 'present',\n}\n\n// OK\nconst r: Room = obj\n"})}),"\n",(0,s.jsx)(e.h3,{id:"type-predicate-signature",children:"Type Predicate Signature"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"is"})," keyword for ",(0,s.jsx)(e.code,{children:"value"})," type predicate:"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"type Falsy = false | '' | 0 | null | undefined\n\nconst isFalsy = (val: unknown): val is Falsy => !val\n\nconst isDefined = <T>(x: T | undefined): x is T => x !== undefined\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function isNotNullish<T>(value: T): value is NonNullable<T> {\n  return value !== undefined && value !== null\n}\n\n// %inferred-type: (number | null | undefined)[]\nconst mixedValues = [1, undefined, 2, null]\n\n// %inferred-type: number[]\nconst numbers = mixedValues.filter(isNotNullish)\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"/**\n * A partial implementation of the `typeof` operator.\n */\nfunction isTypeof(value: any, typeString: 'boolean'): value is boolean\nfunction isTypeof(value: any, typeString: 'number'): value is number\nfunction isTypeof(value: any, typeString: 'string'): value is string\n\nconst value: unknown = {}\n\nif (isTypeof(value, 'boolean')) {\n  // %inferred-type: boolean\n  console.log(value)\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"type-assertion",children:"Type Assertion"}),"\n",(0,s.jsx)(e.h3,{id:"as",children:"As"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"let foo: any\nconst bar = foo as string // \u73b0\u5728 bar \u7684\u7c7b\u578b\u662f 'string'\n\nfunction handler(event: Event) {\n  const mouseEvent = event as MouseEvent\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"const",children:"Const"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"const v1 = {\n  x: 1,\n  y: 2,\n} // { x: number; y: number; }\n\nconst v2 = {\n  x: 1 as const,\n  y: 2,\n} // { x: 1; y: number; }\n\nconst v3 = {\n  x: 1,\n  y: 2,\n} as const // { readonly x: 1; readonly y: 2; }\n\nconst a1 = [1, 2, 3] // number[]\n\nconst a2 = [1, 2, 3] as const // readonly [1, 2, 3]\n"})}),"\n",(0,s.jsxs)(e.p,{children:["Const assertion ",(0,s.jsx)(e.code,{children:"readonly"})," tuples are convenient for function returns\n(returned tuples are often destructured immediately):"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"// Return type: readonly [string, number]\nfunction firstCharAndSizeAsConst(input: string) {\n  return [input[0], input.length] as const\n}\n\n// firstChar type: string\n// size type: number\nconst [firstChar, size] = firstCharAndSizeAsConst('Sabertaz')\n"})}),"\n",(0,s.jsx)(e.h3,{id:"assertion-signature",children:"Assertion Signature"}),"\n",(0,s.jsx)(e.p,{children:"Boolean assertion signature"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function assert(condition: any, msg?: string): asserts condition {\n  if (!condition)\n    throw new AssertionError(msg)\n}\n\nfunction yell(str) {\n  assert(typeof str === 'string')\n  return str.toUppercase()\n  //         ~~~~~~~~~~~\n  // error: Property 'toUppercase' does not exist on type 'string'.\n  //        Did you mean 'toUpperCase'?\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"String assertion signature"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function assertIsString(val: any): asserts val is string {\n  if (typeof val !== 'string')\n    throw new AssertionError('Not a string!')\n}\n\nfunction yell(str: any) {\n  assertIsString(str)\n  // Now TypeScript knows that 'str' is a 'string'.\n  return str.toUppercase()\n  //         ~~~~~~~~~~~\n  // error: Property 'toUppercase' does not exist on type 'string'.\n  //        Did you mean 'toUpperCase'?\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:"Generics assertion signature"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function assertIsDefined<T>(val: T): asserts val is NonNullable<T> {\n  if (val === undefined || val === null) {\n    throw new AssertionError(\n      `Expected 'val' to be defined, but received ${val}`\n    )\n  }\n}\n"})})]})}function p(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},86145:(n,e,r)=>{r.d(e,{R:()=>a,x:()=>o});var t=r(57140);const s={},i=t.createContext(s);function a(n){const e=t.useContext(i);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:a(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);