"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[37313],{51246:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"web/typescript/decorator","title":"Decorators","description":"- Attaching to a class:","source":"@site/content/web/typescript/decorator.md","sourceDirName":"web/typescript","slug":"/web/typescript/decorator","permalink":"/notes/web/typescript/decorator","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/typescript/decorator.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"TypeScript","permalink":"/notes/tags/type-script"},{"inline":true,"label":"Decorator","permalink":"/notes/tags/decorator"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":20,"frontMatter":{"sidebar_position":20,"tags":["Web","TypeScript","Decorator"]},"sidebar":"tutorialSidebar","previous":{"title":"Narrowing","permalink":"/notes/web/typescript/narrowing"},"next":{"title":"Type Gymnastics","permalink":"/notes/web/typescript/gymnastics"}}');var s=t(35656),a=t(86145);const r={sidebar_position:20,tags:["Web","TypeScript","Decorator"]},i="Decorators",c={},l=[{value:"Class",id:"class",level:2},{value:"Property",id:"property",level:2},{value:"Method",id:"method",level:2},{value:"Getter and Setter",id:"getter-and-setter",level:2},{value:"Reflect Metadata",id:"reflect-metadata",level:2}];function d(n){const e={admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"decorators",children:"Decorators"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Attaching to a class:\naccess to the class prototype and its member properties."}),"\n",(0,s.jsxs)(e.li,{children:["Attaching to a class property:\naccess to the name and value of that property,\nalong with its class prototype ",(0,s.jsx)(e.code,{children:"target"}),"."]}),"\n",(0,s.jsx)(e.li,{children:"Attaching to a class method parameter:\naccess to that parameter\u2019s index, name and value."}),"\n",(0,s.jsxs)(e.li,{children:["Attaching to a class method:\naccess to the method\u2019s parameters, the metadata associated with the method object,\nalong with its class prototype ",(0,s.jsx)(e.code,{children:"target"}),"."]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"// class definitions\n@decorator\nclass MyComponent extends React.Component<Props, State> {\n  // class properties\n  @decorator\n  private static api_version: string\n\n  // class method parameters\n  private handleFormSubmit1(@decorator myParam: string) {}\n\n  // class methods\n  @decorator\n  private handleFormSubmit2() {}\n\n  // accessors\n  @decorator\n  public myAccessor() {\n    return this.privateProperty\n  }\n}\n"})}),"\n",(0,s.jsx)(e.admonition,{title:"Pros",type:"tip",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5b9e\u73b0 Open-closed \u539f\u5219."}),"\n",(0,s.jsx)(e.li,{children:"\u5206\u79bb\u8f85\u52a9\u6027\u529f\u80fd\u903b\u8f91 (Before/After \u94a9\u5b50, Trace, Log, Report, Debounce/Throttle)\n\u4e0e\u4e1a\u52a1\u903b\u8f91."}),"\n",(0,s.jsx)(e.li,{children:"\u62bd\u8c61\u516c\u6709\u529f\u80fd\u51fd\u6570."}),"\n",(0,s.jsx)(e.li,{children:"\u88c5\u9970\u5668\u6a21\u5f0f\u662f Class \u7ee7\u627f\u7684\u4e00\u4e2a\u66ff\u4ee3\u6a21\u5f0f.\n(\u7c7b\u4f3c\u4e8e\u7ec4\u5408\u6a21\u5f0f)"}),"\n"]})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"type Decorator = (value: Input, context: {\n  kind: string\n  name: string | symbol\n  access: {\n    get?: () => unknown\n    set?: (value: unknown) => void\n  }\n  private?: boolean\n  static?: boolean\n  addInitializer: (initializer: () => void) => void\n}) => Output | void\n\ntype ClassDecorator = (value: Function, context: {\n  kind: 'class'\n  name: string | undefined\n  addInitializer: (initializer: () => void) => void\n}) => Function | void\n\ntype ClassMethodDecorator = (value: Function, context: {\n  kind: 'method'\n  name: string | symbol\n  access: { get: () => unknown }\n  static: boolean\n  private: boolean\n  addInitializer: (initializer: () => void) => void\n}) => Function | void\n\ntype ClassGetterDecorator = (value: Function, context: {\n  kind: 'getter'\n  name: string | symbol\n  access: { get: () => unknown }\n  static: boolean\n  private: boolean\n  addInitializer: (initializer: () => void) => void\n}) => Function | void\n\ntype ClassSetterDecorator = (value: Function, context: {\n  kind: 'setter'\n  name: string | symbol\n  access: { set: (value: unknown) => void }\n  static: boolean\n  private: boolean\n  addInitializer: (initializer: () => void) => void\n}) => Function | void\n\ntype ClassFieldDecorator = (value: undefined, context: {\n  kind: 'field'\n  name: string | symbol\n  access: { get: () => unknown, set: (value: unknown) => void }\n  static: boolean\n  private: boolean\n  addInitializer: (initializer: () => void) => void\n}) => (initialValue: unknown) => unknown | void\n\ntype ClassAutoAccessorDecorator = (\n  value: {\n    get: () => unknown\n    set: (value: unknown) => void\n  },\n  context: {\n    kind: 'accessor'\n    name: string | symbol\n    access: { get: () => unknown, set: (value: unknown) => void }\n    static: boolean\n    private: boolean\n    addInitializer: (initializer: () => void) => void\n  }\n) => {\n  get?: () => unknown\n  set?: (value: unknown) => void\n  init?: (initialValue: unknown) => unknown\n} | void\n"})}),"\n",(0,s.jsx)(e.h2,{id:"class",children:"Class"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:'type Constructor<T = object> = new (...args: any[]) => T\n\nfunction toString<Class extends Constructor>(\n  Value: Class,\n  context: ClassDecoratorContext<Class>\n) {\n  return class extends Value {\n    constructor(...args: any[]) {\n      super(...args)\n      console.log(JSON.stringify(this))\n      console.log(JSON.stringify(context))\n    }\n  }\n}\n\n@toString\nclass Person {\n  name: string\n\n  constructor(name: string) {\n    this.name = name\n  }\n\n  greet() {\n    return `Hello, ${this.name}`\n  }\n}\nconst person = new Person(\'Simon\')\n/**\n * Logs:\n * {"name":"Simon"}\n * {"kind":"class","name":"Person"}\n */\n'})}),"\n",(0,s.jsx)(e.h2,{id:"property",children:"Property"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function upperCase<T>(\n  target: undefined,\n  context: ClassFieldDecoratorContext<T, string>\n) {\n  return function (this: T, value: string) {\n    return value.toUpperCase()\n  }\n}\n\nclass MyClass {\n  @upperCase\n  prop1 = 'hello!'\n}\n\nconsole.log(new MyClass().prop1) // Logs: HELLO!\n"})}),"\n",(0,s.jsx)(e.h2,{id:"method",children:"Method"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function log<This, Args extends any[], Return>(\n  target: (this: This, ...args: Args) => Return,\n  context: ClassMethodDecoratorContext<\n    This,\n    (this: This, ...args: Args) => Return\n  >\n) {\n  const methodName = String(context.name)\n\n  function replacementMethod(this: This, ...args: Args): Return {\n    console.log(`LOG: Entering method '${methodName}'.`)\n    const result = target.call(this, ...args)\n    console.log(`LOG: Exiting method '${methodName}'.`)\n    return result\n  }\n\n  return replacementMethod\n}\n\nclass MyClass {\n  @log\n  sayHello() {\n    console.log('Hello!')\n  }\n}\n\nnew MyClass().sayHello()\n"})}),"\n",(0,s.jsx)(e.h2,{id:"getter-and-setter",children:"Getter and Setter"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function range<This, Return extends number>(min: number, max: number) {\n  return function (\n    target: (this: This) => Return,\n    context: ClassGetterDecoratorContext<This, Return>\n  ) {\n    return function (this: This): Return {\n      const value = target.call(this)\n\n      if (value < min || value > max) {\n        throw new Error('Invalid')\n      }\n\n      Object.defineProperty(this, context.name, {\n        value,\n        enumerable: true,\n      })\n      return value\n    }\n  }\n}\n\nclass MyClass {\n  private _value = 0\n\n  constructor(value: number) {\n    this._value = value\n  }\n\n  @range(1, 100)\n  get getValue(): number {\n    return this._value\n  }\n}\n\nconst obj = new MyClass(10)\nconsole.log(obj.getValue) // Valid: 10\n\nconst obj2 = new MyClass(999)\nconsole.log(obj2.getValue) // Throw: Invalid!\n"})}),"\n",(0,s.jsx)(e.h2,{id:"reflect-metadata",children:"Reflect Metadata"}),"\n",(0,s.jsx)(e.p,{children:"IoC and DI implementation:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"const INJECTIONS = new WeakMap()\n\nfunction createInjections() {\n  const injections = []\n\n  function injectable(Class) {\n    INJECTIONS.set(Class, injections)\n  }\n\n  function inject(injectionKey) {\n    return function applyInjection(v, context) {\n      injections.push({ injectionKey, set: context.access.set })\n    }\n  }\n\n  return { injectable, inject }\n}\n\nclass Container {\n  registry = new Map()\n\n  register(injectionKey, value) {\n    this.registry.set(injectionKey, value)\n  }\n\n  lookup(injectionKey) {\n    this.registry.get(injectionKey)\n  }\n\n  create(Class) {\n    const instance = new Class()\n\n    for (const { injectionKey, set } of INJECTIONS.get(Class) || [])\n      set.call(instance, this.lookup(injectionKey))\n\n    return instance\n  }\n}\n\nclass Store {}\n\nconst { injectable, inject } = createInjections()\n\n@injectable\nclass C {\n  @inject('store') store\n}\n\nconst container = new Container()\nconst store = new Store()\n\ncontainer.register('store', store)\n\nconst c = container.create(C)\n\nc.store === store // true\n"})}),"\n",(0,s.jsx)(e.p,{children:"AOP programming:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"const PATH_METADATA = 'path'\nconst METHOD_METADATA = 'method'\n\nfunction Controller(path: string): ClassDecorator {\n  return (target) => {\n    Reflect.defineMetadata(PATH_METADATA, path, target)\n  }\n}\n\nfunction createMappingDecorator(method: string) {\n  return (path: string): MethodDecorator => {\n    return (target, key, descriptor) => {\n      Reflect.defineMetadata(PATH_METADATA, path, descriptor.value)\n      Reflect.defineMetadata(METHOD_METADATA, method, descriptor.value)\n    }\n  }\n}\n\nconst Get = createMappingDecorator('GET')\nconst Post = createMappingDecorator('POST')\n\nfunction mapRoute(instance: object) {\n  const prototype = Object.getPrototypeOf(instance)\n\n  // \u7b5b\u9009\u51fa\u7c7b\u7684 methodName\n  const methodsNames = Object.getOwnPropertyNames(prototype).filter(\n    item => !isConstructor(item) && isFunction(prototype[item])\n  )\n  return methodsNames.map((methodName) => {\n    const fn = prototype[methodName]\n\n    // \u53d6\u51fa\u5b9a\u4e49\u7684 metadata\n    const route = Reflect.getMetadata(PATH_METADATA, fn)\n    const method = Reflect.getMetadata(METHOD_METADATA, fn)\n\n    return {\n      route,\n      method,\n      fn,\n      methodName,\n    }\n  })\n}\n\n@Controller('/test')\nclass SomeClass {\n  @Get('/a')\n  someGetMethod() {\n    return 'hello world'\n  }\n\n  @Post('/b')\n  somePostMethod() {}\n}\n\nReflect.getMetadata(PATH_METADATA, SomeClass) // '/test'\n\nmapRoute(new SomeClass())\n/**\n * [{\n *    route: '/a',\n *    method: 'GET',\n *    fn: someGetMethod() { ... },\n *    methodName: 'someGetMethod'\n *  },{\n *    route: '/b',\n *    method: 'POST',\n *    fn: somePostMethod() { ... },\n *    methodName: 'somePostMethod'\n * }]\n *\n */\n"})})]})}function u(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},86145:(n,e,t)=>{t.d(e,{R:()=>r,x:()=>i});var o=t(57140);const s={},a=o.createContext(s);function r(n){const e=o.useContext(a);return o.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:r(n.components),o.createElement(a.Provider,{value:e},n.children)}}}]);