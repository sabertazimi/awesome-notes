"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[47684],{52559:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"web/react/redux/internals","title":"Internals","description":"Constructor","source":"@site/content/web/react/redux/internals.md","sourceDirName":"web/react/redux","slug":"/web/react/redux/internals","permalink":"/notes/web/react/redux/internals","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/redux/internals.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Redux","permalink":"/notes/tags/redux"},{"inline":true,"label":"State Management","permalink":"/notes/tags/state-management"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":8,"frontMatter":{"sidebar_position":8,"tags":["Web","React","Redux","State Management","Internals"]},"sidebar":"tutorialSidebar","previous":{"title":"Best Practices","permalink":"/notes/web/react/redux/best-practices"},"next":{"title":"Performance","permalink":"/notes/web/react/performance"}}');var s=r(35656),o=r(86145);const i={sidebar_position:8,tags:["Web","React","Redux","State Management","Internals"]},a="Internals",c={},d=[{value:"Constructor",id:"constructor",level:2},{value:"Action Validation",id:"action-validation",level:2},{value:"Provider",id:"provider",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"internals",children:"Internals"})}),"\n",(0,s.jsx)(n.h2,{id:"constructor",children:"Constructor"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Use closure to store state and subscribe."}),"\n",(0,s.jsx)(n.li,{children:"Use middleware to change normal dispatch function."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function applyMiddleware(...middlewares) {\r\n  return (store) => {\r\n    // should return (next) => (action) => { ... } function\r\n    if (middlewares.length === 0)\r\n      return dispatch => dispatch\r\n\r\n    if (middlewares.length === 1)\r\n      return middlewares[0]\r\n\r\n    // [ (next) => (action) => {...}, ... ] array\r\n    // next: (action) => { ... } function\r\n    const boundMiddlewares = middlewares.map(middleware => middleware(store))\r\n\r\n    return boundMiddlewares.reduce((a, b) => next => a(b(next)))\r\n  }\r\n}\r\n\r\nfunction createStore(reducer, middleware) {\r\n  // closure for storing global state\r\n  let state\r\n  const subscribers = []\r\n  const coreDispatch = (action) => {\r\n    validateAction(action)\r\n    state = reducer(state, action)\r\n    subscribers.forEach(handler => handler())\r\n  }\r\n  const getState = () => state\r\n\r\n  const store = {\r\n    dispatch: coreDispatch,\r\n    getState,\r\n    subscribe: (handler) => {\r\n      subscribers.push(handler)\r\n\r\n      // unsubscribe function\r\n      return () => {\r\n        const index = subscribers.indexOf(handler)\r\n\r\n        if (index > 0)\r\n          subscribers.splice(index, 1)\r\n      }\r\n    },\r\n  }\r\n\r\n  if (middleware) {\r\n    // store default dispatch\r\n    const dispatch = action => store.dispatch(action)\r\n\r\n    // middleware = ({ dispatch, getState }) => (next) => (action) => { ... };\r\n    // middleware is a higher-order function (return (action) => { ... });\r\n    // dispatch, getState and coreDispatch are injected into middleware as arguments\r\n    store.dispatch = middleware({\r\n      dispatch,\r\n      getState,\r\n    })(coreDispatch)\r\n  }\r\n\r\n  coreDispatch({\r\n    type: INIT_REDUX,\r\n  })\r\n  return store\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"action-validation",children:"Action Validation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"function isValidKey(key) {\r\n  return ['type', 'payload', 'error', 'meta'].includes(key)\r\n}\r\n\r\nfunction validateAction(action) {\r\n  if (!action || typeof action !== 'object' || Array.isArray(action))\r\n    throw new Error('Action must be an object!')\r\n\r\n  if (typeof action.type === 'undefined')\r\n    throw new TypeError('Action must have a type!')\r\n\r\n  if (!Object.keys(action).every(isValidKey)) {\r\n    throw new Error(\r\n      'Action only have `type`, `payload`, `error` or `meta` field!'\r\n    )\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"provider",children:"Provider"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["use Context to provide store (two methods):","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"inject store into every children recursively"}),"\n",(0,s.jsxs)(n.li,{children:["use Consumer in Connect higher order component\r\n",(0,s.jsx)(n.code,{children:"<Consumer>{store => (<WrapperComponent store={store}>)}</Consumer>"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-tsx",children:"interface Store {\r\n  getState: Function\r\n  subscribe: Function\r\n  dispatch: Function\r\n}\r\n\r\nconst StoreContext = React.createContext(store)\r\n\r\nexport function Provider({\r\n  store,\r\n  children,\r\n}: {\r\n  store: Store\r\n  children: ReactElement\r\n}) {\r\n  return (\r\n    <StoreContext value={store}>\r\n      <StoreContext.Consumer>\r\n        {(store) => {\r\n          const childrenWithStore = React.Children.map(children, child =>\r\n            React.cloneElement(child, { store }))\r\n\r\n          return <div>{childrenWithStore}</div>\r\n        }}\r\n      </StoreContext.Consumer>\r\n    </StoreContext>\r\n  )\r\n}\r\n\r\nfunction connect(\r\n  mapStateToProps = () => ({}),\r\n  mapDispatchToProps = () => ({})\r\n) {\r\n  return (Component) => {\r\n    class Connected extends React.Component<{ store: Store }> {\r\n      onStoreOrPropsChange(props) {\r\n        const { store } = this.props\r\n        const state = store.getState()\r\n        const stateProps = mapStateToProps(state, props)\r\n        const dispatchProps = mapDispatchToProps(store.dispatch, props)\r\n        this.setState({\r\n          ...stateProps,\r\n          ...dispatchProps,\r\n        })\r\n      }\r\n\r\n      UNSAFE_componentWillMount() {\r\n        const { store } = this.props\r\n        this.onStoreOrPropsChange(this.props)\r\n        this.unsubscribe = store.subscribe(() =>\r\n          this.onStoreOrPropsChange(this.props)\r\n        )\r\n      }\r\n\r\n      UNSAFE_componentWillReceiveProps(nextProps) {\r\n        this.onStoreOrPropsChange(nextProps)\r\n      }\r\n\r\n      componentWillUnmount() {\r\n        this.unsubscribe()\r\n      }\r\n\r\n      render() {\r\n        return <Component {...this.props} {...this.state} />\r\n      }\r\n    }\r\n\r\n    return Connected\r\n  }\r\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},86145:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var t=r(57140);const s={},o=t.createContext(s);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);