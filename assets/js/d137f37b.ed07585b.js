"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[68966],{50232:(n,e,o)=>{o.r(e),o.d(e,{assets:()=>l,contentTitle:()=>c,default:()=>m,frontMatter:()=>i,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"web/vue/concurrent","title":"Concurrent","description":"Async Component","source":"@site/content/web/vue/concurrent.md","sourceDirName":"web/vue","slug":"/web/vue/concurrent","permalink":"/notes/web/vue/concurrent","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/vue/concurrent.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"Vue","permalink":"/notes/tags/vue"},{"inline":true,"label":"Concurrent","permalink":"/notes/tags/concurrent"},{"inline":true,"label":"Asynchronous","permalink":"/notes/tags/asynchronous"},{"inline":true,"label":"Suspense","permalink":"/notes/tags/suspense"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":14,"frontMatter":{"tags":["Web","Vue","Concurrent","Asynchronous","Suspense"],"sidebar_position":14},"sidebar":"tutorialSidebar","previous":{"title":"Animation","permalink":"/notes/web/vue/animation"},"next":{"title":"Keep Alive and Teleport","permalink":"/notes/web/vue/keep-alive-teleport"}}');var t=o(35656),s=o(86145);const i={tags:["Web","Vue","Concurrent","Asynchronous","Suspense"],sidebar_position:14},c="Concurrent",l={},a=[{value:"Async Component",id:"async-component",level:2},{value:"Resolve Async Component",id:"resolve-async-component",level:2},{value:"Define Async Component",id:"define-async-component",level:2},{value:"Suspense",id:"suspense",level:2}];function d(n){const e={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"concurrent",children:"Concurrent"})}),"\n",(0,t.jsx)(e.h2,{id:"async-component",children:"Async Component"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"// 1. Basic async component:\nVue.component('AsyncExample', (resolve, reject) => {\n  // \u8fd9\u4e2a\u7279\u6b8a\u7684 require \u8bed\u6cd5\u544a\u8bc9 webpack\n  // \u81ea\u52a8\u5c06\u7f16\u8bd1\u540e\u7684\u4ee3\u7801\u5206\u5272\u6210\u4e0d\u540c\u7684\u5757,\n  // \u8fd9\u4e9b\u5757\u5c06\u901a\u8fc7 Ajax \u8bf7\u6c42\u81ea\u52a8\u4e0b\u8f7d.\n  require(['./my-async-component'], resolve)\n})\n\n// 2. Promise async component:\nVue.component(\n  'AsyncWebpackExample',\n  // \u8be5 `import` \u51fd\u6570\u8fd4\u56de\u4e00\u4e2a `Promise` \u5bf9\u8c61.\n  () => import('./my-async-component')\n)\n\n// 3. Advanced async component:\nfunction AsyncComp() {\n  return {\n    // \u9700\u8981\u52a0\u8f7d\u7684\u7ec4\u4ef6, \u5e94\u5f53\u662f\u4e00\u4e2a Promise.\n    component: import('./MyComp.vue'),\n    // \u52a0\u8f7d\u4e2d\u5e94\u5f53\u6e32\u67d3\u7684\u7ec4\u4ef6.\n    loading: LoadingComp,\n    // \u51fa\u9519\u65f6\u6e32\u67d3\u7684\u7ec4\u4ef6.\n    error: ErrorComp,\n    // \u6e32\u67d3\u52a0\u8f7d\u4e2d\u7ec4\u4ef6\u524d\u7684\u7b49\u5f85\u65f6\u95f4, \u9ed8\u8ba4: 200ms.\n    delay: 200,\n    // \u6700\u957f\u7b49\u5f85\u65f6\u95f4, \u8d85\u51fa\u6b64\u65f6\u95f4\u5219\u6e32\u67d3\u9519\u8bef\u7ec4\u4ef6, \u9ed8\u8ba4: Infinity.\n    timeout: 3000,\n  }\n}\nVue.component('AsyncExample', AsyncComp)\n"})}),"\n",(0,t.jsx)(e.h2,{id:"resolve-async-component",children:"Resolve Async Component"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"core/vdom/helpers/resolve-async-component.js"}),":"]}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["3 \u79cd\u5f02\u6b65\u7ec4\u4ef6\u7684\u5b9e\u73b0\u65b9\u5f0f.","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u9ad8\u7ea7\u5f02\u6b65\u7ec4\u4ef6\u5b9e\u73b0\u4e86 loading/resolve/reject/timeout 4 \u79cd\u72b6\u6001."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u5f02\u6b65\u7ec4\u4ef6\u5b9e\u73b0\u7684\u672c\u8d28\u662f 2 \u6b21\u6e32\u67d3:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u7b2c\u4e00\u6b21\u6e32\u67d3\u751f\u6210\u4e00\u4e2a\u6ce8\u91ca\u8282\u70b9/",(0,t.jsx)(e.code,{children:"<LoadingComponent>"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u5f53\u5f02\u6b65\u83b7\u53d6\u7ec4\u4ef6\u6210\u529f\u540e, \u901a\u8fc7 ",(0,t.jsx)(e.code,{children:"forceRender"})," \u5f3a\u5236\u91cd\u65b0\u6e32\u67d3."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"import { currentRenderingInstance } from 'core/instance/render'\nimport {\n  hasSymbol,\n  isDef,\n  isObject,\n  isPromise,\n  isTrue,\n  isUndef,\n  once,\n  remove,\n} from 'core/util/index'\nimport { createEmptyVNode } from 'core/vdom/vnode'\n\nexport function resolveAsyncComponent(\n  factory: Function,\n  baseCtor: Class<Component>\n): Class<Component> | void {\n  // 3.\n  if (isTrue(factory.error) && isDef(factory.errorComp))\n    return factory.errorComp\n\n  if (isDef(factory.resolved))\n    return factory.resolved\n\n  const owner = currentRenderingInstance\n\n  if (owner && isDef(factory.owners) && !factory.owners.includes(owner)) {\n    // already pending\n    factory.owners.push(owner)\n  }\n\n  // 3.\n  if (isTrue(factory.loading) && isDef(factory.loadingComp))\n    return factory.loadingComp\n\n  if (owner && !isDef(factory.owners)) {\n    const owners = (factory.owners = [owner])\n    let sync = true\n    let timerLoading = null\n    let timerTimeout = null\n\n    owner.$on('hook:destroyed', () => remove(owners, owner))\n\n    const forceRender = (renderCompleted: boolean) => {\n      for (let i = 0, l = owners.length; i < l; i++) owners[i].$forceUpdate()\n\n      if (renderCompleted) {\n        owners.length = 0\n\n        if (timerLoading !== null) {\n          clearTimeout(timerLoading)\n          timerLoading = null\n        }\n\n        if (timerTimeout !== null) {\n          clearTimeout(timerTimeout)\n          timerTimeout = null\n        }\n      }\n    }\n\n    const resolve = once((res: object | Class<Component>) => {\n      // cache resolved\n      factory.resolved = ensureCtor(res, baseCtor)\n      // invoke callbacks only if this is not a synchronous resolve\n      // (async resolves are shimmed as synchronous during SSR)\n      if (!sync)\n        forceRender(true)\n      else owners.length = 0\n    })\n\n    const reject = once((reason) => {\n      if (isDef(factory.errorComp)) {\n        factory.error = true\n        forceRender(true)\n      }\n    })\n\n    const res = factory(resolve, reject)\n\n    if (isObject(res)) {\n      if (isPromise(res)) {\n        // 2. () => Promise.\n        if (isUndef(factory.resolved))\n          res.then(resolve, reject)\n      } else if (isPromise(res.component)) {\n        // 3.\n        res.component.then(resolve, reject)\n\n        if (isDef(res.error))\n          factory.errorComp = ensureCtor(res.error, baseCtor)\n\n        if (isDef(res.loading)) {\n          factory.loadingComp = ensureCtor(res.loading, baseCtor)\n\n          if (res.delay === 0) {\n            factory.loading = true\n          } else {\n            timerLoading = setTimeout(() => {\n              timerLoading = null\n\n              if (isUndef(factory.resolved) && isUndef(factory.error)) {\n                factory.loading = true\n                forceRender(false)\n              }\n            }, res.delay || 200)\n          }\n        }\n\n        if (isDef(res.timeout)) {\n          timerTimeout = setTimeout(() => {\n            timerTimeout = null\n\n            if (isUndef(factory.resolved))\n              reject(null)\n          }, res.timeout)\n        }\n      }\n    }\n\n    sync = false\n    // return in case resolved synchronously\n    return factory.loading ? factory.loadingComp : factory.resolved\n  }\n}\n\nfunction ensureCtor(comp: any, base) {\n  if (comp.__esModule || (hasSymbol && comp[Symbol.toStringTag] === 'Module'))\n    comp = comp.default\n\n  return isObject(comp) ? base.extend(comp) : comp\n}\n\nfunction createAsyncPlaceholder(\n  factory: Function,\n  data: ?VNodeData,\n  context: Component,\n  children: ?Array<VNode>,\n  tag: ?string\n): VNode {\n  const node = createEmptyVNode()\n  node.asyncFactory = factory\n  node.asyncMeta = { data, context, children, tag }\n  return node\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"define-async-component",children:"Define Async Component"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"defineAsyncComponent"})," higher order component:"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"function defineAsyncComponent({\n  loader,\n  timeout,\n  loadingComponent,\n  errorComponent,\n}) {\n  let InnerComponent = null\n\n  return {\n    name: 'AsyncComponentWrapper',\n    setup() {\n      const loaded = ref(false)\n      const error = shallowRef(null)\n      let timer = null\n\n      loader()\n        .then((Component) => {\n          InnerComponent = Component\n          loaded.value = true\n        })\n        .catch(err => (error.value = err))\n\n      if (timeout) {\n        timer = setTimeout(() => {\n          const err = new Error(`Async component timed out after ${timeout}ms.`)\n          error.value = err\n        }, timeout)\n      }\n\n      onUnmounted(() => clearTimeout(timer))\n\n      const placeholder = { type: Text, children: '' }\n\n      // Return render function.\n      return () => {\n        if (loaded.value)\n          return { type: InnerComponent }\n        else if (error.value && errorComponent)\n          return { type: errorComponent }\n        else return loadingComponent ? { type: loadingComponent } : placeholder\n      }\n    },\n  }\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"suspense",children:"Suspense"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-html",children:"\x3c!-- Events.vue --\x3e\n<script setup lang=\"ts\">\n  import { getEvents } from '@/services'\n  import type { Event } from '@/services'\n  const events: Event[] = await getEvents()\n<\/script>\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-html",children:"<template>\n  <suspense>\n    <template #default>\n      <Events />\n    </template>\n    <template #fallback>\n      <div>Loading events list ...</div>\n    </template>\n  </suspense>\n</template>\n"})})]})}function m(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(d,{...n})}):d(n)}},86145:(n,e,o)=>{o.d(e,{R:()=>i,x:()=>c});var r=o(57140);const t={},s=r.createContext(t);function i(n){const e=r.useContext(s);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:i(n.components),r.createElement(s.Provider,{value:e},n.children)}}}]);