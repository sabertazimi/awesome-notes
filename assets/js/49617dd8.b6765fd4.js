"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[29604],{76835:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>a,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"web/vue/keep-alive-teleport","title":"Keep Alive and Teleport","description":"Keep Alive","source":"@site/content/web/vue/keep-alive-teleport.md","sourceDirName":"web/vue","slug":"/web/vue/keep-alive-teleport","permalink":"/notes/web/vue/keep-alive-teleport","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/vue/keep-alive-teleport.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"Vue","permalink":"/notes/tags/vue"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":15,"frontMatter":{"tags":["Web","Vue"],"sidebar_position":15},"sidebar":"tutorialSidebar","previous":{"title":"Concurrent","permalink":"/notes/web/vue/concurrent"},"next":{"title":"Router","permalink":"/notes/web/vue/router"}}');var s=t(35656),c=t(86145);const r={tags:["Web","Vue"],sidebar_position:15},a="Keep Alive and Teleport",i={},l=[{value:"Keep Alive",id:"keep-alive",level:2},{value:"Teleport",id:"teleport",level:2},{value:"Client Only",id:"client-only",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"keep-alive-and-teleport",children:"Keep Alive and Teleport"})}),"\n",(0,s.jsx)(n.h2,{id:"keep-alive",children:"Keep Alive"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"include"}),": ",(0,s.jsx)(n.code,{children:"string | RegExp | Array<string>"}),", \u5339\u914d\u7684\u7ec4\u4ef6\u4f1a\u88ab\u7f13\u5b58."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"exclude"}),": ",(0,s.jsx)(n.code,{children:"string | RegExp | Array<string>"}),", \u5339\u914d\u7684\u7ec4\u4ef6\u4e0d\u4f1a\u88ab\u7f13\u5b58."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"max"}),": \u7f13\u5b58\u5927\u5c0f."]}),"\n",(0,s.jsxs)(n.li,{children:["\u7ec4\u4ef6\u4e00\u65e6\u88ab ",(0,s.jsx)(n.code,{children:"<keep-alive>"})," \u7f13\u5b58,\n\u518d\u6b21\u6e32\u67d3\u7684\u65f6\u5019\u4e0d\u4f1a\u6267\u884c ",(0,s.jsx)(n.code,{children:"created"}),"/",(0,s.jsx)(n.code,{children:"mounted"})," \u7b49\u94a9\u5b50\u51fd\u6570 (",(0,s.jsx)(n.code,{children:"core/vdom/create-component.js"}),").\n\u4f46\u4f1a\u6267\u884c ",(0,s.jsx)(n.code,{children:"activated"}),"/",(0,s.jsx)(n.code,{children:"deactivated"})," \u94a9\u5b50\u51fd\u6570 (",(0,s.jsx)(n.code,{children:"core/vdom/create-component.js"}),"/",(0,s.jsx)(n.code,{children:"core/instance/lifecycle.js"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"// core/components/keep-alive.js\nconst KeepAlive = defineComponent({\n  name: 'KeepAlive',\n  abstract: true,\n\n  props: {\n    include: patternTypes,\n    exclude: patternTypes,\n    max: [String, Number],\n  },\n\n  created() {\n    this.cache = Object.create(null)\n    this.keys = []\n  },\n\n  mounted() {\n    this.$watch('include', (val) => {\n      pruneCache(this, name => matches(val, name))\n    })\n    this.$watch('exclude', (val) => {\n      pruneCache(this, name => !matches(val, name))\n    })\n  },\n\n  unmounted() {\n    for (const key in this.cache) pruneCacheEntry(this.cache, key, this.keys)\n  },\n\n  render() {\n    const slot = this.$slots.default\n    const vnode: VNode = getFirstComponentChild(slot)\n    const componentOptions: ?VNodeComponentOptions\n      = vnode && vnode.componentOptions\n\n    if (componentOptions) {\n      // check pattern\n      const name: ?string = getComponentName(componentOptions)\n      const { include, exclude } = this\n\n      if (\n        // not included\n        (include && (!name || !matches(include, name)))\n        // excluded\n        || (exclude && name && matches(exclude, name))\n      ) {\n        return vnode\n      }\n\n      const { cache, keys } = this\n      // same constructor may get registered as different local components\n      // so cid alone is not enough (#3269)\n      const key: ?string\n        = vnode.key == null\n          ? componentOptions.Ctor.cid\n          + (componentOptions.tag ? `::${componentOptions.tag}` : '')\n          : vnode.key\n\n      if (cache[key]) {\n        vnode.componentInstance = cache[key].componentInstance\n        // make current key freshest\n        remove(keys, key)\n        keys.push(key)\n      } else {\n        cache[key] = vnode\n        keys.push(key)\n\n        // prune oldest entry\n        if (this.max && keys.length > Number.parseInt(this.max))\n          pruneCacheEntry(cache, keys[0], keys, this._vnode)\n      }\n\n      vnode.data.keepAlive = true\n    }\n\n    return vnode || (slot && slot[0])\n  },\n})\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const KeepAlive = {\n  __isKeepAlive: true,\n  props: {\n    include: RegExp,\n    exclude: RegExp,\n  },\n  setup(props, { slots }) {\n    const instance = currentInstance\n    const { move, createElement } = instance.keepAliveCtx\n\n    const storageContainer = createElement('div')\n\n    instance._deactivate = (vnode) => {\n      move(vnode, storageContainer)\n    }\n\n    instance._activate = (vnode, container, anchor) => {\n      move(vnode, container, anchor)\n    }\n\n    return () => {\n      const rawVNode = slots.default()\n\n      if (typeof rawVNode.type !== 'object')\n        return rawVNode\n\n      const name = rawVNode.type.name\n\n      if (\n        name\n        && ((props.include && !props.include.test(name))\n          || (props.exclude && props.exclude.test(name)))\n      ) {\n        return rawVNode\n      }\n\n      const cachedVNode = cache.get(rawVNode.type)\n\n      if (cachedVNode) {\n        rawVNode.component = cachedVNode.component\n        rawVNode.keptAlive = true\n      } else {\n        cache.set(rawVNode.type, rawVNode)\n      }\n\n      rawVNode.shouldKeepAlive = true\n      rawVNode.keepAliveInstance = instance\n\n      return rawVNode\n    }\n  },\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"teleport",children:"Teleport"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const Teleport = {\n  __isTeleport: true,\n  process(n1, n2, container, anchor, internals) {\n    const { patch, patchChildren, move } = internals\n\n    if (!n1) {\n      // \u6302\u8f7d\n      const target\n        = typeof n2.props.to === 'string'\n          ? document.querySelector(n2.props.to)\n          : n2.props.to\n      n2.children.forEach(c => patch(null, c, target, anchor))\n    } else {\n      // \u66f4\u65b0\n      patchChildren(n1, n2, container)\n\n      if (n2.props.to !== n1.props.to) {\n        const newTarget\n          = typeof n2.props.to === 'string'\n            ? document.querySelector(n2.props.to)\n            : n2.props.to\n        n2.children.forEach(c => move(c, newTarget))\n      }\n    }\n  },\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"client-only",children:"Client Only"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"const ClientOnly = defineComponent({\n  setup(_, { slots }) {\n    const show = ref(false)\n\n    // `onMounted()` hooks \u53ea\u5728\u5ba2\u6237\u7aef\u6267\u884c,\n    // \u670d\u52a1\u7aef\u6e32\u67d3\u65f6\u4e0d\u6267\u884c.\n    onMounted(() => {\n      show.value = true\n    })\n\n    return () => (show.value && slots.default ? slots.default() : null)\n  },\n})\n"})})]})}function p(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},86145:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var o=t(57140);const s={},c=o.createContext(s);function r(e){const n=o.useContext(c);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(c.Provider,{value:n},e.children)}}}]);