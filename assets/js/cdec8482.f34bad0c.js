"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[65200],{83694:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"web/vue/architecture","title":"Core","description":"Constructor","source":"@site/content/web/vue/architecture.md","sourceDirName":"web/vue","slug":"/web/vue/architecture","permalink":"/notes/web/vue/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/vue/architecture.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"Vue","permalink":"/notes/tags/vue"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Architecture","permalink":"/notes/tags/architecture"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":20,"frontMatter":{"tags":["Web","Vue","Internals","Architecture"],"sidebar_position":20},"sidebar":"tutorialSidebar","previous":{"title":"Toolchain","permalink":"/notes/web/vue/toolchain"},"next":{"title":"Options","permalink":"/notes/web/vue/options"}}');var o=t(35656),r=t(86145);const s={tags:["Web","Vue","Internals","Architecture"],sidebar_position:20},c="Core",l={},a=[{value:"Constructor",id:"constructor",level:2},{value:"Prototype",id:"prototype",level:2},{value:"Global APIs",id:"global-apis",level:2},{value:"Extend",id:"extend",level:3},{value:"NextTick",id:"nexttick",level:3},{value:"Mixin",id:"mixin",level:3},{value:"Use",id:"use",level:3}];function u(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.header,{children:(0,o.jsx)(e.h1,{id:"core",children:"Core"})}),"\n",(0,o.jsx)(e.h2,{id:"constructor",children:"Constructor"}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/instance/index.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// \u4ece\u4e94\u4e2a\u6587\u4ef6\u5bfc\u5165\u4e94\u4e2a\u65b9\u6cd5\uff08\u4e0d\u5305\u62ec warn\uff09\nimport { warn } from '../util/index'\nimport { eventsMixin } from './events'\nimport { initMixin } from './init'\nimport { lifecycleMixin } from './lifecycle'\nimport { renderMixin } from './render'\nimport { stateMixin } from './state'\n\n// \u5b9a\u4e49 Vue \u6784\u9020\u51fd\u6570\nfunction Vue(options) {\n  this._init(options)\n}\n\n// \u5c06 Vue \u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u5bfc\u5165\u7684\u4e94\u4e2a\u65b9\u6cd5\ninitMixin(Vue)\nstateMixin(Vue)\neventsMixin(Vue)\nlifecycleMixin(Vue)\nrenderMixin(Vue)\n\n// \u5bfc\u51fa Vue\nexport default Vue\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/instance/init.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// initMixin(Vue)\nVue.prototype._init = function (options?: object) {}\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/instance/state.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// stateMixin(Vue)\nVue.prototype.$data = data\nVue.prototype.$props = props\nVue.prototype.$set = set\nVue.prototype.$delete = del\nVue.prototype.$watch = function (\n  expOrFn: string | Function,\n  cb: any,\n  options?: object\n): Function {}\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/instance/events.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// eventsMixin(Vue)\nVue.prototype.$on = function (\n  event: string | Array<string>,\n  fn: Function\n): Component {}\nVue.prototype.$once = function (event: string, fn: Function): Component {}\nVue.prototype.$off = function (\n  event?: string | Array<string>,\n  fn?: Function\n): Component {}\nVue.prototype.$emit = function (event: string): Component {}\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/instance/lifecycle.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// lifecycleMixin(Vue)\nVue.prototype._update = function (vnode: VNode, hydrating?: boolean) {}\nVue.prototype.$forceUpdate = function () {}\nVue.prototype.$destroy = function () {}\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/instance/render.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"export function initRender(vm: Component) {\n  vm._vnode = null // the root of the child tree\n  vm._staticTrees = null // v-once cached trees\n  const options = vm.$options\n  const parentVnode = (vm.$vnode = options._parentVnode)\n  const renderContext = parentVnode && parentVnode.context\n  vm.$slots = resolveSlots(options._renderChildren, renderContext)\n  vm.$scopedSlots = emptyObject\n  vm._c = (a, b, c, d) => createElement(vm, a, b, c, d, false)\n  vm.$createElement = (a, b, c, d) => createElement(vm, a, b, c, d, true)\n  const parentData = parentVnode && parentVnode.data\n}\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/instance/render-helpers/index.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"export function installRenderHelpers(target: any) {\n  target._o = markOnce\n  target._n = toNumber\n  target._s = toString\n  target._l = renderList\n  target._t = renderSlot\n  target._q = looseEqual\n  target._i = looseIndexOf\n  target._m = renderStatic\n  target._f = resolveFilter\n  target._k = checkKeyCodes\n  target._b = bindObjectProps\n  target._v = createTextVNode\n  target._e = createEmptyVNode\n  target._u = resolveScopedSlots\n  target._g = bindObjectListeners\n}\n"})}),"\n",(0,o.jsx)(e.h2,{id:"prototype",children:"Prototype"}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/index.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"import { isServerRendering } from 'core/util/env'\nimport { FunctionalRenderContext } from 'core/vdom/create-functional-component'\nimport { initGlobalAPI } from './global-api/index'\nimport Vue from './instance/index'\n\ninitGlobalAPI(Vue)\n\nObject.defineProperty(Vue.prototype, '$isServer', {\n  get: isServerRendering,\n})\n\nObject.defineProperty(Vue.prototype, '$ssrContext', {\n  get() {\n    return this.$vnode && this.$vnode.ssrContext\n  },\n})\n\n// expose FunctionalRenderContext for ssr runtime helper installation\nObject.defineProperty(Vue, 'FunctionalRenderContext', {\n  value: FunctionalRenderContext,\n})\n\nVue.version = '__VERSION__'\n\nexport default Vue\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"runtime/index.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"import config from 'core/config'\nimport Vue from 'core/index'\nimport { mountComponent } from 'core/instance/lifecycle'\nimport { devtools, inBrowser, isChrome } from 'core/util/index'\nimport { extend, noop } from 'shared/util'\n\nimport {\n  getTagNamespace,\n  isReservedAttr,\n  isReservedTag,\n  isUnknownElement,\n  mustUseProp,\n  query,\n} from 'web/util/index'\n\nimport platformComponents from './components/index'\nimport platformDirectives from './directives/index'\nimport { patch } from './patch'\n\n// Install platform specific utils.\nVue.config.mustUseProp = mustUseProp\nVue.config.isReservedTag = isReservedTag\nVue.config.isReservedAttr = isReservedAttr\nVue.config.getTagNamespace = getTagNamespace\nVue.config.isUnknownElement = isUnknownElement\n\n// Install platform runtime directives & components.\nextend(Vue.options.directives, platformDirectives)\nextend(Vue.options.components, platformComponents)\n\n// Install platform patch function.\nVue.prototype.__patch__ = inBrowser ? patch : noop\n\n// Public mount method.\nVue.prototype.$mount = function (\n  el?: string | Element,\n  hydrating?: boolean\n): Component {\n  el = el && inBrowser ? query(el) : undefined\n  return mountComponent(this, el, hydrating)\n}\n"})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"platforms/web/entry-runtime-with-compiler.js"})," \u91cd\u5199 ",(0,o.jsx)(e.code,{children:"Vue.prototype.$mount"})," \u65b9\u6cd5:"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"import config from 'core/config'\nimport { cached } from 'core/util/index'\n\nimport { compileToFunctions } from './compiler/index'\nimport Vue from './runtime/index'\nimport {\n  shouldDecodeNewlines,\n  shouldDecodeNewlinesForHref,\n} from './util/compat'\nimport { query } from './util/index'\n\nconst mount = Vue.prototype.$mount\n\nconst idToTemplate = cached((id) => {\n  const el = query(id)\n  return el && el.innerHTML\n})\n\n/**\n * Get outerHTML of elements, taking care\n * of SVG elements in IE as well.\n */\nfunction getOuterHTML(el: Element): string {\n  if (el.outerHTML) {\n    return el.outerHTML\n  } else {\n    const container = document.createElement('div')\n    container.appendChild(el.cloneNode(true))\n    return container.innerHTML\n  }\n}\n\nVue.prototype.$mount = function (\n  el?: string | Element,\n  hydrating?: boolean\n): Component {\n  el = el && query(el)\n\n  if (el === document.body || el === document.documentElement) {\n    // Do not mount Vue to <html> or <body>\n    return this\n  }\n\n  const options = this.$options\n  // resolve template/el and convert to render function\n  if (!options.render) {\n    let template = options.template\n    if (template) {\n      if (typeof template === 'string') {\n        if (template.charAt(0) === '#')\n          template = idToTemplate(template)\n      } else if (template.nodeType) {\n        template = template.innerHTML\n      } else {\n        // Invalid template option\n        return this\n      }\n    } else if (el) {\n      template = getOuterHTML(el)\n    }\n    if (template) {\n      const { render, staticRenderFns } = compileToFunctions(\n        template,\n        {\n          shouldDecodeNewlines,\n          shouldDecodeNewlinesForHref,\n          delimiters: options.delimiters,\n          comments: options.comments,\n        },\n        this\n      )\n      options.render = render\n      options.staticRenderFns = staticRenderFns\n    }\n  }\n\n  return mount.call(this, el, hydrating)\n}\n\nVue.compile = compileToFunctions\n\nexport default Vue\n"})}),"\n",(0,o.jsx)(e.h2,{id:"global-apis",children:"Global APIs"}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/global-api/index.js"})," \u6dfb\u52a0 ",(0,o.jsx)(e.code,{children:"Vue.XXX"})," \u9759\u6001\u65b9\u6cd5:"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// initGlobalAPI\nVue.config = config\nVue.util = {\n  warn,\n  extend,\n  mergeOptions,\n  defineReactive,\n}\nVue.set = set\nVue.delete = del\nVue.nextTick = nextTick\nVue.options = {\n  components: {\n    KeepAlive,\n    // Transition \u548c TransitionGroup \u7ec4\u4ef6\u5728 runtime/index.js \u6587\u4ef6\u4e2d\u88ab\u6dfb\u52a0\n    // Transition,\n    // TransitionGroup\n  },\n  directives: Object.create(null),\n  // \u5728 runtime/index.js \u6587\u4ef6\u4e2d, \u4e3a directives \u6dfb\u52a0\u4e86\u4e24\u4e2a\u5e73\u53f0\u5316\u7684\u6307\u4ee4 model \u548c show\n  // directives:{\n  // model,\n  // show\n  // },\n  filters: Object.create(null),\n  _base: Vue,\n}\n\n// initUse: global-api/use.js\nVue.use = function (plugin: Function | object) {}\n\n// initMixin: global-api/mixin.js\nVue.mixin = function (mixin: object) {}\n\n// initExtend: global-api/extend.js\nVue.cid = 0\nVue.extend = function (extendOptions: object): Function {}\n\n// initAssetRegisters: global-api/assets.js\nVue.component\n  = Vue.directive\n    = Vue.filter\n      = function (\n        id: string,\n        definition: Function | object\n      ): Function | object | void {}\n\n// expose FunctionalRenderContext for ssr runtime helper installation\nObject.defineProperty(Vue, 'FunctionalRenderContext', {\n  value: FunctionalRenderContext,\n})\n\nVue.version = '__VERSION__'\n\n// entry-runtime-with-compiler.js\nVue.compile = compileToFunctions\n"})}),"\n",(0,o.jsx)(e.h3,{id:"extend",children:"Extend"}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/global-api/extend.js"}),":"]}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsxs)(e.li,{children:[(0,o.jsx)(e.code,{children:"Vue.extend"}),"/",(0,o.jsx)(e.code,{children:"vm.$options._base.extend"})," will return brand new ",(0,o.jsx)(e.code,{children:"Vue"})," constructor."]}),"\n"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"/**\n * Class inheritance\n */\nVue.extend = function (extendOptions: object): Function {\n  extendOptions = extendOptions || {}\n  const Super = this\n  const SuperId = Super.cid\n  const cachedCtors = extendOptions._Ctor || (extendOptions._Ctor = {})\n\n  if (cachedCtors[SuperId])\n    return cachedCtors[SuperId]\n\n  const name = extendOptions.name || Super.options.name\n  const Sub = function VueComponent(options) {\n    this._init(options)\n  }\n\n  Sub.prototype = Object.create(Super.prototype)\n  Sub.prototype.constructor = Sub\n  Sub.cid = cid++\n  Sub.options = mergeOptions(Super.options, extendOptions)\n  Sub.super = Super\n\n  // For props and computed properties, we define the proxy getters on\n  // the Vue instances at extension time. This\n  // avoids Object.defineProperty calls for each instance created.\n  if (Sub.options.props)\n    initProps(Sub)\n\n  if (Sub.options.computed)\n    initComputed(Sub)\n\n  // allow further extension/mixin/plugin usage\n  Sub.extend = Super.extend\n  Sub.mixin = Super.mixin\n  Sub.use = Super.use\n\n  // create asset registers, so extended classes\n  // can have their private assets too.\n  ASSET_TYPES.forEach((type) => {\n    Sub[type] = Super[type]\n  })\n\n  // enable recursive self-lookup\n  if (name)\n    Sub.options.components[name] = Sub\n\n  // keep a reference to the super options at extension time.\n  // later at instantiation we can check if Super's options have\n  // been updated.\n  Sub.superOptions = Super.options\n  Sub.extendOptions = extendOptions\n  Sub.sealedOptions = extend({}, Sub.options)\n\n  // cache constructor\n  cachedCtors[SuperId] = Sub\n  return Sub\n}\n"})}),"\n",(0,o.jsx)(e.h3,{id:"nexttick",children:"NextTick"}),"\n",(0,o.jsxs)(e.p,{children:["\u4e3a\u4e86\u51cf\u5c11\u5e03\u5c40\u548c\u6e32\u67d3,\n",(0,o.jsx)(e.code,{children:"Vue"})," \u628a ",(0,o.jsx)(e.code,{children:"DOM"})," \u66f4\u65b0\u8bbe\u8ba1\u4e3a\u5f02\u6b65\u66f4\u65b0,\n\u6bcf\u6b21\u4fa6\u542c\u5230\u6570\u636e\u53d8\u5316,\n\u5c06\u5f00\u542f\u4e00\u4e2a\u961f\u5217,\n\u5e76\u7f13\u51b2\u5728\u540c\u4e00\u4e8b\u4ef6\u5faa\u73af\u4e2d\u53d1\u751f\u7684\u6240\u6709\u6570\u636e\u53d8\u66f4\u3002\n\u5982\u679c\u540c\u4e00\u4e2a ",(0,o.jsx)(e.code,{children:"watcher"})," \u88ab\u591a\u6b21\u89e6\u53d1,\n\u53ea\u4f1a\u88ab\u63a8\u5165\u5230\u961f\u5217\u4e2d\u4e00\u6b21\u3002\n\u5728\u4e0b\u4e00\u4e2a\u4e8b\u4ef6\u5faa\u73af tick \u4e2d,\n",(0,o.jsx)(e.code,{children:"Vue"})," \u624d\u4f1a\u771f\u6b63\u6267\u884c\u961f\u5217\u4e2d\u7684\u6570\u636e\u53d8\u66f4,\n\u9875\u9762\u624d\u4f1a\u91cd\u65b0\u6e32\u67d3,\n\u4f7f\u5f97\u591a\u6b21 DOM \u66f4\u65b0\u5408\u5e76\u6210\u4e00\u6b21\u6279\u5904\u7406\u66f4\u65b0\u3002"]}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/util/next-tick.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"import { noop } from 'shared/util'\nimport { isIOS, isNative } from './env'\nimport { handleError } from './error'\n\nconst callbacks = []\nlet pending = false\n\nfunction flushCallbacks() {\n  pending = false\n  const copies = callbacks.slice(0)\n  callbacks.length = 0\n\n  for (let i = 0; i < copies.length; i++) copies[i]()\n}\n\nlet microTimerFunc\nlet macroTimerFunc\nlet useMacroTask = false\n\n// setImmediate -> MessageChannel -> setTimeout.\nif (typeof setImmediate !== 'undefined' && isNative(setImmediate)) {\n  macroTimerFunc = () => {\n    setImmediate(flushCallbacks)\n  }\n} else if (\n  typeof MessageChannel !== 'undefined'\n  && (isNative(MessageChannel)\n  // PhantomJS\n    || MessageChannel.toString() === '[object MessageChannelConstructor]')\n) {\n  const channel = new MessageChannel()\n  const port = channel.port2\n  channel.port1.onmessage = flushCallbacks\n  macroTimerFunc = () => {\n    port.postMessage(1)\n  }\n} else {\n  macroTimerFunc = () => {\n    setTimeout(flushCallbacks, 0)\n  }\n}\n\n// Promise.then -> Macro Timer.\nif (typeof Promise !== 'undefined' && isNative(Promise)) {\n  const p = Promise.resolve()\n  microTimerFunc = () => {\n    p.then(flushCallbacks)\n    if (isIOS)\n      setTimeout(noop)\n  }\n} else {\n  microTimerFunc = macroTimerFunc\n}\n\n/**\n * Wrap a function so that if any code inside triggers state change,\n * the changes are queued using a (macro) task instead of a micro task.\n */\nexport function withMacroTask(fn: Function): Function {\n  return (\n    fn._withTask\n    || (fn._withTask = function (...args) {\n      useMacroTask = true\n      const res = fn(...args)\n      useMacroTask = false\n      return res\n    })\n  )\n}\n\nexport function nextTick(cb?: Function, ctx?: object) {\n  let _resolve\n\n  callbacks.push(() => {\n    if (cb) {\n      try {\n        cb.call(ctx)\n      } catch (e) {\n        handleError(e, ctx, 'nextTick')\n      }\n    } else if (_resolve) {\n      _resolve(ctx)\n    }\n  })\n\n  if (!pending) {\n    pending = true\n\n    if (useMacroTask)\n      macroTimerFunc()\n    else microTimerFunc()\n\n    if (!cb && typeof Promise !== 'undefined') {\n      return new Promise((resolve) => {\n        _resolve = resolve\n      })\n    }\n  }\n}\n"})}),"\n",(0,o.jsx)(e.h3,{id:"mixin",children:"Mixin"}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/global-api/mixin.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"export function initMixin(Vue: GlobalAPI) {\n  Vue.mixin = function (mixin: object) {\n    this.options = mergeOptions(this.options, mixin)\n    return this\n  }\n}\n"})}),"\n",(0,o.jsx)(e.h3,{id:"use",children:"Use"}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.code,{children:"core/global-api/use.js"}),":"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"export function initUse(Vue: GlobalAPI) {\n  Vue.use = function (plugin: Function | object, ...args: any) {\n    const installedPlugins\n      = this._installedPlugins || (this._installedPlugins = [])\n\n    if (installedPlugins.includes(plugin))\n      return this\n\n    // Pass `Vue` to plugin install hook.\n    args.unshift(this)\n\n    if (typeof plugin.install === 'function')\n      plugin.install(...args)\n    else if (typeof plugin === 'function')\n      plugin(...args)\n\n    installedPlugins.push(plugin)\n    return this\n  }\n}\n"})})]})}function d(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(u,{...n})}):u(n)}},86145:(n,e,t)=>{t.d(e,{R:()=>s,x:()=>c});var i=t(57140);const o={},r=i.createContext(o);function s(n){const e=i.useContext(r);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:s(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);