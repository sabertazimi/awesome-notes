"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[34242],{42777:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"language/java/mybatis","title":"MyBatis","description":"Proxy and Interceptor","source":"@site/content/language/java/mybatis.md","sourceDirName":"language/java","slug":"/language/java/mybatis","permalink":"/notes/language/java/mybatis","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/language/java/mybatis.md","tags":[{"inline":true,"label":"Language","permalink":"/notes/tags/language"},{"inline":true,"label":"Java","permalink":"/notes/tags/java"},{"inline":true,"label":"MyBatis","permalink":"/notes/tags/my-batis"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":40,"frontMatter":{"sidebar_position":40,"tags":["Language","Java","MyBatis","Internals"]},"sidebar":"tutorialSidebar","previous":{"title":"Comments","permalink":"/notes/language/java/comments"},"next":{"title":"Rust","permalink":"/notes/language/rust/"}}');var a=t(35656),i=t(86145);const s={sidebar_position:40,tags:["Language","Java","MyBatis","Internals"]},c="MyBatis",o={},l=[{value:"Proxy and Interceptor",id:"proxy-and-interceptor",level:2}];function p(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"mybatis",children:"MyBatis"})}),"\n",(0,a.jsx)(n.h2,{id:"proxy-and-interceptor",children:"Proxy and Interceptor"}),"\n",(0,a.jsx)(n.p,{children:"\u63a5\u53e3\u5b9a\u4e49:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public interface UserService {\n    void addUser(String username);\n    void removeUser(String username);\n}\n\npublic class Invocation {\n\n    /**\n     * \u76ee\u6807\u5bf9\u8c61\n     */\n    private Object target;\n    /**\n     * \u6267\u884c\u7684\u65b9\u6cd5\n     */\n    private Method method;\n    /**\n     * \u65b9\u6cd5\u7684\u53c2\u6570\n     */\n    private Object[] args;\n\n    public Invocation(Object target, Method method, Object[] args) {\n        this.target = target;\n        this.method = method;\n        this.args = args;\n    }\n\n    /**\n     * \u6267\u884c\u76ee\u6807\u5bf9\u8c61\u7684\u65b9\u6cd5\n     */\n    public Object invoke() throws Exception{\n       return method.invoke(target,args);\n    }\n}\n\npublic interface Interceptor {\n    /**\n     * \u5177\u4f53\u62e6\u622a\u5904\u7406, \u76ee\u6807\u5bf9\u8c61\u5c01\u88c5\u5230Invocation\n     */\n    Object intercept(Invocation invocation) throws Exception;\n\n    /**\n     *  \u63d2\u5165\u76ee\u6807\u7c7b, \u521b\u5efa\u4ee3\u7406\u5bf9\u8c61\n     */\n    Object plugin(Object target);\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u63a5\u53e3\u5b9e\u73b0:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class UserServiceImpl implements UserService {\n    @Override\n    public void addUser(String username) {\n        System.out.println("User " + username + " added.");\n    }\n\n    @Override\n    public void removeUser(String username) {\n        System.out.println("User " + username + " removed.");\n    }\n}\n\npublic class LogInterceptor implements Interceptor {\n\n    @Override\n    public Object intercept(Invocation invocation) throws Exception{\n        System.out.println("------\u4e1a\u52a1\u4ee3\u7801\u6267\u884c\u4e4b\u524d-------------");\n        Object result = invocation.process();\n        System.out.println("------\u4e1a\u52a1\u4ee3\u7801\u6267\u884c\u4e4b\u540e-------------");\n        return result;\n    }\n\n    @Override\n    public Object plugin(Object target){\n        return UserServiceProxyHandler.wrap(target, this);\n    }\n}\n\npublic class CatInterceptor implements Interceptor {\n    @Override\n    public Object intercept(Invocation invocation) throws Exception{\n        System.out.println("------\u76d1\u63a7\u5f00\u542f-------------");\n        Object result = invocation.process();\n        System.out.println("------\u76d1\u63a7\u7ed3\u675f-------------");\n        return result;\n    }\n\n    @Override\n    public Object plugin(Object target){\n        return UserServiceProxyHandler.wrap(target, this);\n    }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u4ee3\u7406\u7c7b\u5b9e\u73b0:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"import java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\n\npublic class UserServiceProxyHandler implements InvocationHandler {\n    private final UserService userService;\n    private final Interceptor interceptor;\n\n    public UserServiceProxyHandler(UserService userService, Interceptor interceptor) {\n        this.userService = userService;\n        this.interceptor = interceptor;\n    }\n\n    @Override\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n        Invocation invocation = new Invocation(userService, method, args);\n        Object result = interceptor.intercept(invocation);\n        return result;\n    }\n\n    public static Object wrap(Object target,Interceptor interceptor) {\n        UserServiceProxyHandler targetProxy = new UserServiceProxyHandler(target, interceptor);\n        return Proxy.newProxyInstance(target.getClass().getClassLoader(),target.getClass().getInterfaces(),targetProxy);\n    }\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u8d23\u4efb\u94fe\u6a21\u5f0f:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import java.lang.reflect.Proxy;\n\npublic class Main {\n    public static void main(String[] args) {\n        UserService realUserService = new UserServiceImpl();\n\n        LogInterceptor logInterceptor = new LogInterceptor();\n        realUserService = (UserService)logInterceptor.plugin(realUserService);\n\n        CatInterceptor catInterceptor = new CatInterceptor();\n        realUserService = (UserService)catInterceptor.plugin(realUserService);\n\n        // \u4f7f\u7528\u4ee3\u7406\u5b9e\u4f8b\n        realUserService.addUser("\u5f20\u4e09");\n        realUserService.removeUser("\u5f20\u4e09");\n    }\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},86145:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>c});var r=t(57140);const a={},i=r.createContext(a);function s(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);