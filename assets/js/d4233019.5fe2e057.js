"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[63737],{12375:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"web/react/render","title":"Render","description":"Reconciler construct Fiber tree:","source":"@site/content/web/react/render.md","sourceDirName":"web/react","slug":"/web/react/render","permalink":"/notes/web/react/render","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/render.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Reconciler","permalink":"/notes/tags/reconciler"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":34,"frontMatter":{"sidebar_position":34,"tags":["Web","React","Internals","Reconciler"]},"sidebar":"tutorialSidebar","previous":{"title":"Reconciler","permalink":"/notes/web/react/reconciler"},"next":{"title":"Update","permalink":"/notes/web/react/update"}}');var t=r(35656),s=r(86145);const i={sidebar_position:34,tags:["Web","React","Internals","Reconciler"]},l="Render",c={},d=[{value:"Host Root",id:"host-root",level:2},{value:"Host Component",id:"host-component",level:2}];function a(n){const e={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"render",children:"Render"})}),"\n",(0,t.jsx)(e.p,{children:"Reconciler construct Fiber tree:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["scheduleUpdateOnFiber:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u9996\u6b21 render \u76f4\u63a5\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"performWorkOnRoot"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u518d\u6b21 render \u9700\u8981\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"ensureRootIsScheduled"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.li,{children:"ensureRootIsScheduled."}),"\n",(0,t.jsx)(e.li,{children:"flushSyncCallbacks."}),"\n",(0,t.jsxs)(e.li,{children:["performSyncWorkOnRoot / performConcurrentWorkOnRoot:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"performConcurrentWorkOnRoot"})," \u652f\u6301\u53ef\u4e2d\u65ad\u6e32\u67d3:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u6b64\u51fd\u6570\u9996\u5148\u68c0\u67e5\u662f\u5426\u5904\u4e8e render \u8fc7\u7a0b\u4e2d,\n\u662f\u5426\u9700\u8981\u6062\u590d\u4e0a\u4e00\u6b21\u6e32\u67d3."}),"\n",(0,t.jsxs)(e.li,{children:["\u5982\u679c\u672c\u6b21\u6e32\u67d3\u88ab\u4e2d\u65ad,\n\u6b64\u51fd\u6570\u6700\u540e\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684 ",(0,t.jsx)(e.code,{children:"performConcurrentWorkOnRoot"})," \u51fd\u6570,\n\u7b49\u5f85\u4e0b\u4e00\u6b21 Scheduler \u8c03\u5ea6."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["renderRootSync / renderRootConcurrent:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6b64\u51fd\u6570\u4f1a\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"prepareFreshStack"}),", \u91cd\u7f6e FiberRoot \u4e0a\u7684\u5168\u5c40\u5c5e\u6027, \u91cd\u7f6e Fiber work loop \u5168\u5c40\u53d8\u91cf."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6b64\u51fd\u6570\u4f1a\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"workInProgressRoot = FiberRoot"}),", \u8868\u793a\u6b63\u5728\u8fdb\u884c render."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6b64\u51fd\u6570\u9000\u51fa\u524d, \u4f1a\u91cd\u7f6e ",(0,t.jsx)(e.code,{children:"workInProgressRoot = null"}),", \u8868\u793a\u6ca1\u6709\u6b63\u5728\u8fdb\u884c\u4e2d\u7684 render."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6b64\u51fd\u6570\u9000\u51fa\u524d, \u4f1a\u6302\u8f7d ",(0,t.jsx)(e.code,{children:"FiberRoot.finishedWork = workInProgressHostRootFiber"}),".\n\u6b64\u65f6 ",(0,t.jsx)(e.code,{children:"HostRootFiber"})," \u4e0a\u6302\u8f7d\u4e86\u526f\u4f5c\u7528\u961f\u5217, \u5c42\u7ea7\u8d8a\u6df1\u5b50\u8282\u70b9\u526f\u4f5c\u7528\u8d8a\u9760\u524d."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["workLoopSync / workLoopConcurrent:\n\u5faa\u73af\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"performUnitOfWork"}),",\n\u76f4\u5230 ",(0,t.jsx)(e.code,{children:"workInProgress === null"})," \u6216\u7528\u5b8c\u5f53\u524d\u65f6\u95f4\u5206\u7247."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"performUnitOfWork(workInProgress)"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5b58\u5728\u5b50\u8282\u70b9\uff0c ",(0,t.jsx)(e.code,{children:"beginWork"})," \u4e0e ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u4e0d\u5728\u540c\u4e00\u6b21\u5faa\u73af\u91cc\u8c03\u7528:\n\u6267\u884c\u5b8c ",(0,t.jsx)(e.code,{children:"beginWork"})," \u540e,\n\u4f18\u5148\u5411\u4e0b\u904d\u5386, \u6267\u884c\u5b50\u8282\u70b9\u7684 ",(0,t.jsx)(e.code,{children:"beginWork"})," \u4e0e ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"}),",\n\u5728 N \u6b21\u5faa\u73af\u540e\u518d\u5411\u4e0a\u56de\u6eaf."]}),"\n",(0,t.jsxs)(e.li,{children:["\u4e0d\u5b58\u5728\u5b50\u8282\u70b9\uff0c ",(0,t.jsx)(e.code,{children:"beginWork"})," \u4e0e ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u5728\u540c\u4e00\u6b21\u5faa\u73af\u91cc\u8c03\u7528."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82e5 ",(0,t.jsx)(e.code,{children:"beginWork"})," \u8fd4\u56de ",(0,t.jsx)(e.code,{children:"next"})," \u8282\u70b9,\n\u5219\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"workInProgress = next"})," \u8fdb\u884c DFS \u904d\u5386,\n\u518d\u6b21\u8c03\u7528\u6b64\u51fd\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82e5 ",(0,t.jsx)(e.code,{children:"beginWork"})," \u8fd4\u56de ",(0,t.jsx)(e.code,{children:"null"})," \u8282\u70b9,\n\u5219\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u51fd\u6570\u5b8c\u6210\u8282\u70b9\u5904\u7406."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82e5\u5b58\u5728\u5144\u5f1f\u8282\u70b9,\n",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u4f1a\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"workInProgress = siblingFiber"})," \u8fdb\u884c DFS \u904d\u5386,\n\u518d\u6b21\u8c03\u7528\u6b64\u51fd\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u82e5\u5230\u8fbe\u5b50\u53f6\u8282\u70b9,\n",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u4f1a\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"workInProgress = returnFiber"})," \u8fdb\u884c DFS \u56de\u6eaf,\n\u518d\u6b21\u8c03\u7528\u6b64\u51fd\u6570."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"beginWork"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6839\u636e ",(0,t.jsx)(e.code,{children:"ReactElement"})," \u5bf9\u8c61\u521b\u5efa\u6240\u6709\u7684 Fiber \u8282\u70b9, \u6700\u7ec8\u6784\u9020\u51fa Fiber \u6811\u5f62\u7ed3\u6784\n(\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"return"})," \u548c ",(0,t.jsx)(e.code,{children:"sibling"})," \u6307\u9488)."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"updateXXX"}),", \u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"fiber.flags"}),"/",(0,t.jsx)(e.code,{children:"fiber.stateNode"})," \u7b49\u72b6\u6001."]}),"\n",(0,t.jsxs)(e.li,{children:["\u975e\u5b50\u53f6\u8282\u70b9\u8fd4\u56de\u5b50\u8282\u70b9, \u8fdb\u884c DFS \u904d\u5386; \u5b50\u53f6\u8282\u70b9\u8fd4\u56de ",(0,t.jsx)(e.code,{children:"null"}),", \u76f4\u63a5\u8fdb\u5165 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u9636\u6bb5."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"updateHostRoot/updateXXXComponent"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6839\u636e ",(0,t.jsx)(e.code,{children:"fiber.pendingProps"}),"/",(0,t.jsx)(e.code,{children:"fiber.updateQueue"})," \u7b49\u8f93\u5165\u6570\u636e\u72b6\u6001,\n\u8ba1\u7b97 ",(0,t.jsx)(e.code,{children:"fiber.memoizedState"})," \u4f5c\u4e3a\u8f93\u51fa\u72b6\u6001."]}),"\n",(0,t.jsxs)(e.li,{children:["ClassComponent:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6784\u5efa ",(0,t.jsx)(e.code,{children:"React.Component"})," \u5b9e\u4f8b."]}),"\n",(0,t.jsxs)(e.li,{children:["\u628a\u65b0\u5b9e\u4f8b\u6302\u8f7d\u5230 ",(0,t.jsx)(e.code,{children:"fiber.stateNode"})," \u4e0a."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6267\u884c ",(0,t.jsx)(e.code,{children:"render"})," \u4e4b\u524d\u7684\u751f\u547d\u5468\u671f\u51fd\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6267\u884c ",(0,t.jsx)(e.code,{children:"render"})," \u65b9\u6cd5, \u83b7\u53d6\u4e0b\u7ea7 ",(0,t.jsx)(e.code,{children:"ReactElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8bb0\u526f\u4f5c\u7528."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["FunctionComponent:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u6267\u884c ",(0,t.jsx)(e.code,{children:"renderWithHooks()"})," -> ",(0,t.jsx)(e.code,{children:"FunctionComponent()"}),", \u83b7\u53d6\u4e0b\u7ea7 ",(0,t.jsx)(e.code,{children:"ReactElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8bb0\u526f\u4f5c\u7528."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["HostComponent.","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"pendingProps.children"})," \u4f5c\u4e3a\u4e0b\u7ea7 ",(0,t.jsx)(e.code,{children:"ReactElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u5982\u679c\u4e0b\u7ea7\u8282\u70b9\u662f\u6587\u672c\u8282\u70b9, \u5219\u8bbe\u7f6e\u4e0b\u7ea7\u8282\u70b9\u4e3a ",(0,t.jsx)(e.code,{children:"null"})," (\u8fdb\u5165 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u9636\u6bb5)."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8bb0\u526f\u4f5c\u7528."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\u6839\u636e\u5b9e\u9645\u60c5\u51b5, \u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6807\u8bb0\u526f\u4f5c\u7528."]}),"\n",(0,t.jsxs)(e.li,{children:["\u6839\u636e\u83b7\u53d6\u7684\u4e0b\u7ea7 ",(0,t.jsx)(e.code,{children:"ReactElement"})," \u5bf9\u8c61, \u8c03\u7528 ",(0,t.jsx)(e.code,{children:"reconcileChildren"})," \u751f\u6210 ",(0,t.jsx)(e.code,{children:"Fiber"})," \u5b50\u8282\u70b9 (\u53ea\u751f\u6210\u6b21\u7ea7\u5b50\u8282\u70b9)."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"ReactDOMComponent.createElement()"})," / ",(0,t.jsx)(e.code,{children:"ReactClassComponent.render()"})," / ",(0,t.jsx)(e.code,{children:"ReactFunctionComponent()"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"reconcileChildren"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["mountChildFibers/reconcileChildFibers:","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"mountChildFibers"}),": similar logic, not tracking side effects."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileChildFibers"}),": similar logic, tracking side effects."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileSingleElement"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileSingleTextNode"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileSinglePortal"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileChildrenArray"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.code,{children:"reconcileChildrenIterator"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"completeUnitOfWork"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5f53 ",(0,t.jsx)(e.code,{children:"reconcileChildren"})," \u8fd4\u56de\u503c\u4e3a ",(0,t.jsx)(e.code,{children:"null"})," \u65f6, \u8868\u793a DFS \u8fdb\u884c\u5230\u5b50\u53f6\u8282\u70b9,\n",(0,t.jsx)(e.code,{children:"performUnitOfWork"})," \u4f1a\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"completeUnitOfWork"})," \u51fd\u6570."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8c03\u7528 ",(0,t.jsx)(e.code,{children:"completeWork"})," \u8fdb\u884c ",(0,t.jsx)(e.code,{children:"render"}),"."]}),"\n",(0,t.jsxs)(e.li,{children:["\u628a\u5f53\u524d Fiber \u5bf9\u8c61\u7684\u526f\u4f5c\u7528\u961f\u5217 (",(0,t.jsx)(e.code,{children:"firstEffect"})," \u4e0e ",(0,t.jsx)(e.code,{children:"lastEffect"}),")\n\u52a0\u5230\u7236\u8282\u70b9\u7684\u526f\u4f5c\u7528\u961f\u5217\u4e4b\u540e, \u66f4\u65b0\u7236\u8282\u70b9\u7684 ",(0,t.jsx)(e.code,{children:"firstEffect"})," \u548c ",(0,t.jsx)(e.code,{children:"lastEffect"})," \u6307\u9488."]}),"\n",(0,t.jsxs)(e.li,{children:["\u8bc6\u522b ",(0,t.jsx)(e.code,{children:"beginWork"})," \u9636\u6bb5\u8bbe\u7f6e\u7684 ",(0,t.jsx)(e.code,{children:"fiber.flags"}),",\n\u82e5\u5f53\u524d Fiber \u5b58\u5728\u526f\u4f5c\u7528 (Effects),\n\u5219\u5c06\u5f53\u524d Fiber \u52a0\u5165\u5230\u7236\u8282\u70b9\u7684 Effects \u961f\u5217,\n\u7b49\u5f85 Commit \u9636\u6bb5\u5904\u7406."]}),"\n",(0,t.jsxs)(e.li,{children:["\u5c06 ",(0,t.jsx)(e.code,{children:"workInProgress"})," \u8bbe\u7f6e\u4e3a ",(0,t.jsx)(e.code,{children:"siblingFiber"})," (DFS \u904d\u5386) \u6216 ",(0,t.jsx)(e.code,{children:"returnFiber"})," (DFS \u56de\u6eaf),\n\u7ee7\u7eed\u6784\u5efa Fiber \u6811."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:[(0,t.jsx)(e.strong,{children:"completeWork"}),":","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u521b\u5efa DOM \u5b9e\u4f8b, \u7ed1\u5b9a\u81f3 ",(0,t.jsx)(e.code,{children:"HostComponent"}),"/",(0,t.jsx)(e.code,{children:"HostText"})," ",(0,t.jsx)(e.code,{children:"fiber.stateNode"})," (\u5c40\u90e8\u72b6\u6001)."]}),"\n",(0,t.jsx)(e.li,{children:"\u8bbe\u7f6e DOM \u8282\u70b9\u5c5e\u6027, \u7ed1\u5b9a\u4e8b\u4ef6."}),"\n",(0,t.jsxs)(e.li,{children:["\u8bbe\u7f6e ",(0,t.jsx)(e.code,{children:"fiber.flags"}),", \u6536\u96c6\u526f\u4f5c\u7528."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"export function scheduleUpdateOnFiber(\n  fiber: Fiber,\n  lane: Lane,\n  eventTime: number\n) {\n  const root = markUpdateLaneFromFiberToRoot(fiber, lane)\n\n  if (lane === SyncLane) {\n    if (\n      (executionContext & LegacyUnbatchedContext) !== NoContext\n      && (executionContext & (RenderContext | CommitContext)) === NoContext\n    ) {\n      // \u521d\u6b21\u6e32\u67d3.\n      performSyncWorkOnRoot(root)\n    } else {\n      // \u5bf9\u6bd4\u66f4\u65b0.\n      ensureRootIsScheduled(root, eventTime)\n    }\n  }\n\n  mostRecentlyUpdatedRoot = root\n}\n\nfunction performSyncWorkOnRoot(root) {\n  // 1. \u83b7\u53d6\u672c\u6b21render\u7684\u4f18\u5148\u7ea7, \u521d\u6b21\u6784\u9020\u8fd4\u56de NoLanes.\n  const lanes = getNextLanes(root, NoLanes)\n  // 2. \u4eceroot\u8282\u70b9\u5f00\u59cb, \u81f3\u4e0a\u800c\u4e0b\u66f4\u65b0.\n  const exitStatus = renderRootSync(root, lanes)\n  // 3. \u5c06\u6700\u65b0\u7684 Fiber \u6811\u6302\u8f7d\u5230 root.finishedWork \u8282\u70b9\u4e0a.\n  const finishedWork: Fiber = root.current.alternate\n  root.finishedWork = finishedWork\n  root.finishedLanes = lanes\n  // 4. \u8fdb\u5165 Commit \u9636\u6bb5.\n  commitRoot(root)\n}\n\nfunction performConcurrentWorkOnRoot(root) {\n  const originalCallbackNode = root.callbackNode\n\n  // 1. \u5237\u65b0 pending \u72b6\u6001\u7684 effects, \u6709\u53ef\u80fd\u67d0\u4e9b effect \u4f1a\u53d6\u6d88\u672c\u6b21\u4efb\u52a1.\n  const didFlushPassiveEffects = flushPassiveEffects()\n\n  if (didFlushPassiveEffects) {\n    if (root.callbackNode !== originalCallbackNode) {\n      // \u4efb\u52a1\u88ab\u53d6\u6d88, \u9000\u51fa\u8c03\u7528.\n      return null\n    } else {\n      // Current task was not canceled. Continue.\n    }\n  }\n\n  // 2. \u83b7\u53d6\u672c\u6b21\u6e32\u67d3\u7684\u4f18\u5148\u7ea7.\n  const lanes = getNextLanes(\n    root,\n    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes\n  )\n\n  // 3. \u6784\u9020 Fiber \u6811.\n  const exitStatus = renderRootConcurrent(root, lanes)\n\n  if (\n    includesSomeLane(\n      workInProgressRootIncludedLanes,\n      workInProgressRootUpdatedLanes\n    )\n  ) {\n    // \u5982\u679c\u5728 render \u8fc7\u7a0b\u4e2d\u4ea7\u751f\u4e86\u65b0 update, \u4e14\u65b0 update \u7684\u4f18\u5148\u7ea7\u4e0e\u6700\u521d render \u7684\u4f18\u5148\u7ea7\u6709\u4ea4\u96c6.\n    // \u90a3\u4e48\u6700\u521d render \u65e0\u6548, \u4e22\u5f03\u6700\u521d render \u7684\u7ed3\u679c, \u7b49\u5f85\u4e0b\u4e00\u6b21\u8c03\u5ea6.\n    prepareFreshStack(root, NoLanes)\n  } else if (exitStatus !== RootIncomplete) {\n    // 4. \u5f02\u5e38\u5904\u7406: \u6709\u53ef\u80fdfiber\u6784\u9020\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u5f02\u5e38.\n    if (exitStatus === RootError)\n      processError()\n\n    const finishedWork = root.current.alternate // Fiber\n    root.finishedWork = finishedWork\n    root.finishedLanes = lanes\n\n    // 5. \u8f93\u51fa: \u6e32\u67d3 Fiber\u6811.\n    finishConcurrentRender(root, exitStatus, lanes)\n  }\n\n  // \u9000\u51fa\u524d\u518d\u6b21\u68c0\u6d4b, \u662f\u5426\u8fd8\u6709\u5176\u4ed6\u66f4\u65b0, \u662f\u5426\u9700\u8981\u53d1\u8d77\u65b0\u8c03\u5ea6.\n  ensureRootIsScheduled(root, now())\n\n  if (root.callbackNode === originalCallbackNode) {\n    // \u6e32\u67d3\u88ab\u963b\u65ad, \u8fd4\u56de\u4e00\u4e2a\u65b0\u7684 performConcurrentWorkOnRoot \u51fd\u6570, \u7b49\u5f85\u4e0b\u4e00\u6b21\u8c03\u5ea6.\n    return performConcurrentWorkOnRoot.bind(null, root)\n  }\n\n  return null\n}\n\nfunction renderRootSync(root: FiberRoot, lanes: Lanes) {\n  const prevExecutionContext = executionContext\n  executionContext |= RenderContext\n\n  // \u5982\u679c FiberRoot \u53d8\u52a8, \u6216\u8005 update.lane \u53d8\u52a8, \u90fd\u4f1a\u5237\u65b0\u6808\u5e27, \u4e22\u5f03\u4e0a\u4e00\u6b21\u6e32\u67d3\u8fdb\u5ea6.\n  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {\n    // \u5237\u65b0\u6808\u5e27.\n    prepareFreshStack(root, lanes)\n  }\n  do {\n    try {\n      workLoopSync()\n      break\n    } catch (thrownValue) {\n      handleError(root, thrownValue)\n    }\n  } while (true)\n\n  // \u91cd\u7f6e\u5168\u5c40\u53d8\u91cf, \u8868\u660e render \u7ed3\u675f.\n  executionContext = prevExecutionContext\n  workInProgressRoot = null\n  workInProgressRootRenderLanes = NoLanes\n  return workInProgressRootExitStatus\n}\n\nfunction renderRootConcurrent(root: FiberRoot, lanes: Lanes) {\n  const prevExecutionContext = executionContext\n  executionContext |= RenderContext\n  const prevDispatcher = pushDispatcher()\n\n  // \u5982\u679c FiberRoot \u53d8\u52a8, \u6216\u8005 update.lane \u53d8\u52a8, \u90fd\u4f1a\u5237\u65b0\u6808\u5e27, \u4e22\u5f03\u4e0a\u4e00\u6b21\u6e32\u67d3\u8fdb\u5ea6.\n  if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {\n    resetRenderTimer()\n    // \u5237\u65b0\u6808\u5e27.\n    prepareFreshStack(root, lanes)\n    startWorkOnPendingInteractions(root, lanes)\n  }\n\n  const prevInteractions = pushInteractions(root)\n\n  do {\n    try {\n      workLoopConcurrent()\n      break\n    } catch (thrownValue) {\n      handleError(root, thrownValue)\n    }\n  } while (true)\n\n  // \u91cd\u7f6e\u5168\u5c40\u53d8\u91cf.\n  resetContextDependencies()\n  popDispatcher(prevDispatcher)\n  executionContext = prevExecutionContext\n\n  // Check if tree has completed.\n  if (workInProgress !== null) {\n    // Still work remaining.\n    return RootIncomplete\n  } else {\n    // Completed tree.\n    // Set this to null to indicate there's no in-progress render.\n    workInProgressRoot = null\n    workInProgressRootRenderLanes = NoLanes\n\n    // Return final exit status.\n    return workInProgressRootExitStatus\n  }\n}\n\nfunction prepareFreshStack(root: FiberRoot, lanes: Lanes) {\n  // \u91cd\u7f6e FiberRoot \u4e0a\u7684\u5c5e\u6027.\n  root.finishedWork = null\n  root.finishedLanes = NoLanes\n  const timeoutHandle = root.timeoutHandle\n\n  if (timeoutHandle !== noTimeout) {\n    root.timeoutHandle = noTimeout\n    cancelTimeout(timeoutHandle)\n  }\n\n  if (workInProgress !== null) {\n    let interruptedWork = workInProgress.return\n    while (interruptedWork !== null) {\n      unwindInterruptedWork(interruptedWork)\n      interruptedWork = interruptedWork.return\n    }\n  }\n\n  // \u91cd\u7f6e\u5168\u5c40\u53d8\u91cf.\n  workInProgressRoot = root\n  workInProgress = createWorkInProgress(root.current, null) // currentHostRootFiber.alternate.\n  workInProgressRootRenderLanes\n    = subtreeRenderLanes\n      = workInProgressRootIncludedLanes\n        = lanes\n  workInProgressRootExitStatus = RootIncomplete\n  workInProgressRootFatalError = null\n  workInProgressRootSkippedLanes = NoLanes\n  workInProgressRootUpdatedLanes = NoLanes\n  workInProgressRootPingedLanes = NoLanes\n}\n\nfunction workLoopSync() {\n  while (workInProgress !== null)\n    performUnitOfWork(workInProgress)\n}\n\nfunction workLoopConcurrent() {\n  // Perform work until Scheduler asks us to yield.\n  while (workInProgress !== null && !shouldYield())\n    performUnitOfWork(workInProgress)\n}\n\nfunction performUnitOfWork(unitOfWork: Fiber): void {\n  // unitOfWork \u5c31\u662f\u88ab\u4f20\u5165\u7684 workInProgress.\n  const current = unitOfWork.alternate\n  const next = beginWork(current, unitOfWork, subtreeRenderLanes)\n  unitOfWork.memoizedProps = unitOfWork.pendingProps\n\n  if (next === null) {\n    // \u5982\u679c\u6ca1\u6709\u6d3e\u751f\u51fa\u65b0\u7684\u4e0b\u7ea7\u8282\u70b9, \u5219\u8fdb\u5165 completeWork \u9636\u6bb5, \u4f20\u5165\u7684\u662f\u5f53\u524d unitOfWork.\n    completeUnitOfWork(unitOfWork)\n  } else {\n    // \u5982\u679c\u6d3e\u751f\u51fa\u65b0\u7684\u4e0b\u7ea7\u8282\u70b9, \u5219\u9012\u5f52\u5904\u7406.\n    workInProgress = next\n  }\n}\n\nfunction _performUnitOfWork_Recursive(unitOfWork: Fiber): void {\n  beginWork(unitOfWork.alternate, unitOfWork, subtreeRenderLanes)\n  if (unitOfWork.child)\n    _performUnitOfWork_Recursive(unitOfWork.child)\n  completeUnitOfWork(unitOfWork)\n  if (unitOfWork.sibling)\n    _performUnitOfWork_Recursive(unitOfWork.sibling)\n}\n\nfunction beginWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  // 1. \u8bbe\u7f6e workInProgress \u4f18\u5148\u7ea7\u4e3a NoLanes (\u6700\u9ad8\u4f18\u5148\u7ea7).\n  const updateLanes = workInProgress.lanes\n  didReceiveUpdate = false\n  workInProgress.lanes = NoLanes\n\n  // 2. \u6839\u636e workInProgress \u8282\u70b9\u7684\u7c7b\u578b, \u7528\u4e0d\u540c\u7684\u65b9\u6cd5\u6d3e\u751f\u51fa\u5b50\u8282\u70b9.\n  switch (workInProgress.tag) {\n    case ClassComponent: {\n      const Component = workInProgress.type\n      const unresolvedProps = workInProgress.pendingProps\n      const resolvedProps\n        = workInProgress.elementType === Component\n          ? unresolvedProps\n          : resolveDefaultProps(Component, unresolvedProps)\n      return updateClassComponent(\n        current,\n        workInProgress,\n        Component,\n        resolvedProps,\n        renderLanes\n      )\n    }\n    case HostRoot:\n      return updateHostRoot(current, workInProgress, renderLanes)\n    case HostComponent:\n      return updateHostComponent(current, workInProgress, renderLanes)\n    case HostText:\n      return updateHostText(current, workInProgress)\n    case Fragment:\n      return updateFragment(current, workInProgress, renderLanes)\n  }\n}\n\nfunction completeUnitOfWork(unitOfWork: Fiber): void {\n  let completedWork = unitOfWork\n\n  // \u5916\u5c42\u5faa\u73af\u63a7\u5236\u5e76\u79fb\u52a8\u6307\u9488 (workInProgress/completedWork).\n  do {\n    const current = completedWork.alternate\n    const returnFiber = completedWork.return\n\n    if ((completedWork.flags & Incomplete) === NoFlags) {\n      // 1. \u5904\u7406 Fiber \u8282\u70b9, \u4f1a\u8c03\u7528\u6e32\u67d3\u5668 (\u5173\u8054 Fiber \u8282\u70b9\u548c DOM \u5bf9\u8c61, \u7ed1\u5b9a\u4e8b\u4ef6\u7b49).\n      const next = completeWork(current, completedWork, subtreeRenderLanes)\n\n      if (next !== null) {\n        // \u5982\u679c\u6d3e\u751f\u51fa\u5176\u4ed6\u7684\u5b50\u8282\u70b9, \u5219\u56de\u5230 beginWork \u9636\u6bb5\u8fdb\u884c\u5904\u7406.\n        workInProgress = next\n        return\n      }\n\n      // \u91cd\u7f6e\u5b50\u8282\u70b9\u7684\u4f18\u5148\u7ea7.\n      resetChildLanes(completedWork)\n\n      if (\n        returnFiber !== null\n        && (returnFiber.flags & Incomplete) === NoFlags\n      ) {\n        // 2. \u6536\u96c6\u5f53\u524d Fiber \u8282\u70b9\u4ee5\u53ca\u5176\u5b50\u6811\u7684\u526f\u4f5c\u7528 Effects.\n        // 2.1 \u628a\u5b50\u8282\u70b9\u7684\u526f\u4f5c\u7528\u961f\u5217\u6dfb\u52a0\u5230\u7236\u8282\u70b9\u4e0a.\n        if (returnFiber.firstEffect === null)\n          returnFiber.firstEffect = completedWork.firstEffect\n\n        if (completedWork.lastEffect !== null) {\n          if (returnFiber.lastEffect !== null)\n            returnFiber.lastEffect.nextEffect = completedWork.firstEffect\n\n          returnFiber.lastEffect = completedWork.lastEffect\n        }\n\n        // 2.2 \u5982\u679c\u5f53\u524d Fiber \u8282\u70b9\u6709\u526f\u4f5c\u7528, \u5c06\u5176\u6dfb\u52a0\u5230\u5b50\u8282\u70b9\u7684\u526f\u4f5c\u7528\u961f\u5217\u4e4b\u540e.\n        const flags = completedWork.flags\n\n        if (returnFiber.lastEffect !== null)\n          returnFiber.lastEffect.nextEffect = completedWork\n        else\n          returnFiber.firstEffect = completedWork\n\n        returnFiber.lastEffect = completedWork\n      }\n    }\n\n    const siblingFiber = completedWork.sibling\n\n    if (siblingFiber !== null) {\n      // \u5982\u679c\u6709\u5144\u5f1f\u8282\u70b9, \u8fd4\u56de\u4e4b\u540e\u518d\u6b21\u8fdb\u5165 beginWork \u9636\u6bb5.\n      workInProgress = siblingFiber\n      return\n    }\n\n    // \u79fb\u52a8\u6307\u9488, \u6307\u5411\u4e0b\u4e00\u4e2a\u8282\u70b9.\n    completedWork = returnFiber\n    workInProgress = completedWork\n  } while (completedWork !== null)\n\n  // \u5df2\u56de\u6eaf\u5230\u6839\u8282\u70b9, \u8bbe\u7f6e workInProgressRootExitStatus = RootCompleted.\n  if (workInProgressRootExitStatus === RootIncomplete)\n    workInProgressRootExitStatus = RootCompleted\n}\n\nfunction completeWork(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n): Fiber | null {\n  const newProps = workInProgress.pendingProps\n\n  switch (workInProgress.tag) {\n    case HostRoot: {\n      const fiberRoot: FiberRoot = workInProgress.stateNode\n\n      if (fiberRoot.pendingContext) {\n        fiberRoot.context = fiberRoot.pendingContext\n        fiberRoot.pendingContext = null\n      }\n\n      if (current === null || current.child === null) {\n        // \u8bbe\u7f6e fiber.flags.\n        workInProgress.flags |= Snapshot\n      }\n\n      return null\n    }\n    case HostComponent: {\n      popHostContext(workInProgress)\n      const rootContainerInstance = getRootHostContainer()\n      const type = workInProgress.type\n      const currentHostContext = getHostContext()\n\n      // 1. \u521b\u5efa DOM \u5bf9\u8c61.\n      const instance = createInstance(\n        type,\n        newProps,\n        rootContainerInstance,\n        currentHostContext,\n        workInProgress\n      )\n\n      // 2. \u628a\u5b50\u6811\u4e2d\u7684 DOM \u5bf9\u8c61 append \u5230\u672c\u8282\u70b9\u7684 DOM \u5bf9\u8c61\u4e4b\u540e.\n      appendAllChildren(instance, workInProgress, false, false)\n\n      // 3. \u8bbe\u7f6e stateNode \u5c5e\u6027, \u6307\u5411 DOM \u5bf9\u8c61.\n      workInProgress.stateNode = instance\n\n      if (\n        // 4. \u8bbe\u7f6eDOM\u5bf9\u8c61\u7684\u5c5e\u6027, \u7ed1\u5b9a\u4e8b\u4ef6\u7b49.\n        finalizeInitialChildren(\n          instance,\n          type,\n          newProps,\n          rootContainerInstance,\n          currentHostContext\n        )\n      ) {\n        // \u8bbe\u7f6e fiber.flags (Update).\n        markUpdate(workInProgress)\n      }\n\n      if (workInProgress.ref !== null) {\n        // \u8bbe\u7f6e fiber.flags (Ref).\n        markRef(workInProgress)\n      }\n\n      return null\n    }\n  }\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"host-root",children:"Host Root"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"function updateHostRoot(current, workInProgress, renderLanes) {\n  // 1. \u72b6\u6001\u8ba1\u7b97, \u66f4\u65b0\u6574\u5408\u5230 workInProgress.memoizedState.\n  const updateQueue = workInProgress.updateQueue\n  const nextProps = workInProgress.pendingProps\n  const prevState = workInProgress.memoizedState\n  const prevChildren = prevState !== null ? prevState.element : null\n  cloneUpdateQueue(current, workInProgress)\n  // \u904d\u5386 updateQueue.shared.pending, \u63d0\u53d6\u6709\u8db3\u591f\u4f18\u5148\u7ea7\u7684 update\u5bf9\u8c61, \u8ba1\u7b97\u51fa\u6700\u7ec8\u7684\u72b6\u6001 workInProgress.memoizedState.\n  processUpdateQueue(workInProgress, nextProps, null, renderLanes)\n  const nextState = workInProgress.memoizedState\n\n  // 2. \u83b7\u53d6\u4e0b\u7ea7 ReactElement \u5bf9\u8c61.\n  const nextChildren = nextState.element\n  const root: FiberRoot = workInProgress.stateNode\n\n  // 3. \u6839\u636e ReactElement \u5bf9\u8c61, \u8c03\u7528 reconcileChildren \u751f\u6210 Fiber \u5b50\u8282\u70b9 (\u53ea\u751f\u6210\u6b21\u7ea7\u5b50\u8282\u70b9).\n  reconcileChildren(current, workInProgress, nextChildren, renderLanes)\n  return workInProgress.child\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"host-component",children:"Host Component"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-ts",children:"function updateHostComponent(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  renderLanes: Lanes\n) {\n  // 1. \u72b6\u6001\u8ba1\u7b97, \u7531\u4e8e HostComponent \u662f\u65e0\u72b6\u6001\u7ec4\u4ef6, \u53ea\u9700\u8981\u6536\u96c6 nextProps.\n  const type = workInProgress.type\n  const nextProps = workInProgress.pendingProps\n  const prevProps = current !== null ? current.memoizedProps : null\n\n  // 2. \u83b7\u53d6\u4e0b\u7ea7 ReactElement \u5bf9\u8c61.\n  let nextChildren = nextProps.children\n  const isDirectTextChild = shouldSetTextContent(type, nextProps)\n\n  if (isDirectTextChild) {\n    // \u5982\u679c\u5b50\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u6587\u672c\u8282\u70b9, \u4e0d\u7528\u518d\u521b\u5efa\u4e00\u4e2a HostText \u7c7b\u578b\u7684 Fiber.\n    nextChildren = null\n  } else if (prevProps !== null && shouldSetTextContent(type, prevProps)) {\n    // \u8bbe\u7f6e fiber.flags.\n    workInProgress.flags |= ContentReset\n  }\n\n  // \u8bbe\u7f6e fiber.flags.\n  markRef(current, workInProgress)\n\n  // 3. \u6839\u636e ReactElement \u5bf9\u8c61, \u8c03\u7528 reconcileChildren \u751f\u6210 Fiber \u5b50\u8282\u70b9(\u53ea\u751f\u6210\u6b21\u7ea7\u5b50\u8282\u70b9)\n  reconcileChildren(current, workInProgress, nextChildren, renderLanes)\n  return workInProgress.child\n}\n"})})]})}function u(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(a,{...n})}):a(n)}},86145:(n,e,r)=>{r.d(e,{R:()=>i,x:()=>l});var o=r(57140);const t={},s=o.createContext(t);function i(n){const e=o.useContext(s);return o.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:i(n.components),o.createElement(s.Provider,{value:e},n.children)}}}]);