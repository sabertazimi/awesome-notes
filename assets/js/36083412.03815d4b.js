"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[69236],{31978:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"programming/git/internals","title":"Internals","description":"Objects","source":"@site/content/programming/git/internals.md","sourceDirName":"programming/git","slug":"/programming/git/internals","permalink":"/notes/programming/git/internals","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/programming/git/internals.md","tags":[{"inline":true,"label":"Programming","permalink":"/notes/tags/programming"},{"inline":true,"label":"Git","permalink":"/notes/tags/git"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":10,"frontMatter":{"sidebar_position":10,"tags":["Programming","Git","Internals"]},"sidebar":"tutorialSidebar","previous":{"title":"GitHub","permalink":"/notes/programming/git/github"},"next":{"title":"Linux","permalink":"/notes/programming/linux/"}}');var r=t(35656),c=t(86145);const s={sidebar_position:10,tags:["Programming","Git","Internals"]},o="Internals",l={},a=[{value:"Objects",id:"objects",level:2},{value:"Packfiles",id:"packfiles",level:2},{value:"Add",id:"add",level:2},{value:"Commit",id:"commit",level:2},{value:"Checkout",id:"checkout",level:2},{value:"Merge",id:"merge",level:2},{value:"Fetch",id:"fetch",level:2},{value:"Clone",id:"clone",level:2},{value:"Push",id:"push",level:2},{value:"Branch",id:"branch",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"internals",children:"Internals"})}),"\n",(0,r.jsx)(n.h2,{id:"objects",children:"Objects"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:".git/objects"})," is immutable, ",(0,r.jsx)(n.code,{children:".git/refs"})," is mutable."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"blob"}),"\u6301\u6709\u6587\u4ef6\u7684\u5185\u5bb9,",(0,r.jsx)(n.code,{children:"\u6811\u5bf9\u8c61"}),"\u662f\u4e00\u4e2a\u5305\u542b",(0,r.jsx)(n.code,{children:"blob"}),"\u5bf9\u8c61\u548c",(0,r.jsx)(n.code,{children:"\u5b50\u6811\u5bf9\u8c61"}),"\u7684\u76ee\u5f55\u5217\u8868.\n",(0,r.jsx)(n.code,{children:"\u63d0\u4ea4\u5bf9\u8c61"}),"\u662f\u5de5\u4f5c\u76ee\u5f55\u7684\u4e00\u4e2a\u5feb\u7167, \u5305\u542b\u4e86\u4e00\u4e9b\u50cf\u65f6\u95f4\u6216\u63d0\u4ea4\u4fe1\u606f\u8fd9\u6837\u7684\u5143\u6570\u636e.\n",(0,r.jsx)(n.code,{children:"\u5206\u652f"}),"\u662f",(0,r.jsx)(n.code,{children:"\u63d0\u4ea4\u5bf9\u8c61"}),"\u7684\u547d\u540d\u5f15\u7528.\n",(0,r.jsx)(n.code,{children:"\u5de5\u4f5c\u76ee\u5f55"}),"\u662f\u4e00\u4e2a\u76ee\u5f55, \u6709\u7740\u76f8\u5e94\u7684\u4ed3\u5e93, ",(0,r.jsx)(n.code,{children:"\u6682\u5b58\u533a"}),"(\u7d22\u5f15)\u4e3a\u4e0b\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"\u63d0\u4ea4\u5bf9\u8c61"}),"\u6301\u6709\u5bf9\u5e94\u7684",(0,r.jsx)(n.code,{children:"\u6811\u5bf9\u8c61"}),",\n\u800c\u4ed3\u5e93\u5c31\u662f\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"\u63d0\u4ea4\u5bf9\u8c61"}),"\u7684\u96c6\u5408."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.blog/2022-08-29-gits-database-internals-i-packed-object-store",children:(0,r.jsx)(n.img,{alt:"Git Objects",src:t(22719).A+"",width:"800",height:"699"})})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"git hash-object \u521b\u5efablob\u5bf9\u8c61\ngit cat-file -t\ngit cat-file -p\ngit update-index --add --cache-info \u5c06\u6587\u4ef6\u6dfb\u52a0\u81f3\u6682\u5b58\u533a\ngit write-tree \u521b\u5efatree\u5bf9\u8c61\ngit commit-tree \u521b\u5efacommit\u5bf9\u8c61\n\n$ git hash-object -w --stdin\nHello, world!\naf5626b4a114abcb82d63db7c8082c3c4756e51b\n\n$ git cat-file -t af5626b4a114abcb82d63db7c8082c3c4756e51b\nblob\n\n$ git cat-file -p af5626b4a114abcb82d63db7c8082c3c4756e51b\nHello, world!\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# -w for write into codebase,\n# --stdin for reading from stdin not file\necho 'test content' | git hash-object -w --stdin\ngit cat-file -p <object-hash-number>\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\nfunction separator() {\n    for i in {1..20}\n    do\n        printf "-"\n    done\n    printf $1\n    for i in {1..20}\n    do\n        printf "-"\n    done\n    printf "\\n"\n}\n\nfunction git_object_type() {\n    printf "type => "\n    git cat-file -t $1\n    for i in {1..40}\n    do\n        printf "-"\n    done\n    printf "\\n"\n}\n\nfunction git_object_content() {\n    git cat-file -p $1\n}\n\nfunction print_git_objects() {\n    files=$(git rev-list --parents --objects HEAD | awk \'{print $1}\')\n    index=0\n\n    for file in $files\n    do\n        len=$(expr length "$file")\n\n        if [ $len -gt 30 ]\n        then\n            index=$(expr $index + 1)\n            separator $index\n            echo $file\n            git_object_type $file\n            git_object_content $file\n        fi\n    done\n}\n\nprint_git_objects\n'})}),"\n",(0,r.jsx)(n.h2,{id:"packfiles",children:"Packfiles"}),"\n",(0,r.jsxs)(n.p,{children:["Each ",(0,r.jsx)(n.code,{children:"*.pack"})," file in ",(0,r.jsx)(n.code,{children:".git/objects/pack/"}),"\nis called a ",(0,r.jsx)(n.code,{children:"packfile"}),".\nPackfiles store multiple objects in compressed forms."]}),"\n",(0,r.jsxs)(n.p,{children:["The pack-index ",(0,r.jsx)(n.code,{children:".idx"})," operates\nlike a query index that speeds up read queries\nthat rely on the primary key (object ID)."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Git Packfile",src:t(22182).A+"",title:"Git Packfile",width:"800",height:"309"})}),"\n",(0,r.jsx)(n.h2,{id:"add",children:"Add"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"create blob objects: contains content of files"}),"\n",(0,r.jsx)(n.li,{children:"add files to index list (.git/index)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"commit",children:"Commit"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"create tree objects: each object represent a directory,\ncontains blob object refs in this directory"}),"\n",(0,r.jsx)(n.li,{children:"create commit object:\ncontains root tree object hash number and parent commit object hash number"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"checkout",children:"Checkout"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"git checkout <commit-hash-id>\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"get commit object by commit hash id"}),"\n",(0,r.jsx)(n.li,{children:"get root tree object in commit object"}),"\n",(0,r.jsx)(n.li,{children:"write file entries by root tree object (tree graph)"}),"\n",(0,r.jsx)(n.li,{children:"write .git/index"}),"\n",(0,r.jsx)(n.li,{children:"set HEAD to that commit (detached HEAD state)"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",children:"// Get file commit history\nconst Git = require('nodegit')\n\nlet repo\n\nGit.Repository.open(path.resolve('./.git'))\n  .then((r) => {\n    repo = r\n    return repo.getMasterCommit()\n  })\n  .then((firstCommitOnMaster) => {\n    const walker = repo.createRevWalk()\n    walker.push(firstCommitOnMaster.sha())\n    walker.sorting(Git.Revwalk.SORT.Time)\n\n    return walker.fileHistoryWalk(historyFile, 2)\n  })\n  .then((resultingArrayOfCommits) => {\n    if (resultingArrayOfCommits.length > 0) {\n      const commit = resultingArrayOfCommits[0].commit\n      const date = commit.date()\n    }\n  })\n\nfunction getGitLastUpdatedTimeStamp(filePath) {\n  let lastUpdated = 0\n\n  try {\n    lastUpdated\n      = Number.parseInt(\n        spawn\n          .sync('git', ['log', '-1', '--format=%at', path.basename(filePath)], {\n            cwd: path.dirname(filePath),\n          })\n          .stdout.toString('utf-8')\n      ) * 1000\n  } catch (e) {\n    /* do not handle for now */\n  }\n\n  return lastUpdated\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"merge",children:"Merge"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"git merge <giver-branch>/<giver-commit>\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["write giver commit hash to ",(0,r.jsx)(n.code,{children:".git/MERGE_HEAD"})]}),"\n",(0,r.jsx)(n.li,{children:"find base commit (the most recent common ancestor commit)"}),"\n",(0,r.jsx)(n.li,{children:"diff and apply according to base commit, giver commit, receiver commit"}),"\n",(0,r.jsxs)(n.li,{children:["do what ",(0,r.jsx)(n.code,{children:"git checkout"})," do"]}),"\n",(0,r.jsxs)(n.li,{children:["remove ",(0,r.jsx)(n.code,{children:".git/MERGE_HEAD"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"fetch",children:"Fetch"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"get hash of remote commit and its root tree object"}),"\n",(0,r.jsx)(n.li,{children:"copy all diff objects in tree graph into .git/objects"}),"\n",(0,r.jsxs)(n.li,{children:["update ",(0,r.jsx)(n.code,{children:".git/refs/remotes/origin/<branch>"}),", set ",(0,r.jsx)(n.code,{children:".git/FETCH_HEAD"})," to it"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"clone",children:"Clone"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"git init"})," + ",(0,r.jsx)(n.code,{children:"git remote add origin <repo-url>"})," + ",(0,r.jsx)(n.code,{children:"git pull origin"})]}),"\n",(0,r.jsx)(n.h2,{id:"push",children:"Push"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"apply commit to remote repo"}),"\n",(0,r.jsxs)(n.li,{children:["update remote repo ",(0,r.jsx)(n.code,{children:".git/refs/heads/<branch>"})," to new commit"]}),"\n",(0,r.jsxs)(n.li,{children:["update local repo ",(0,r.jsx)(n.code,{children:".git/refs/remotes/origin/<branch>"})," to new commit"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"branch",children:"Branch"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"HEAD -> refs/heads/master -> commit object"}),"\n",(0,r.jsx)(n.li,{children:"branches are just refs, refs are just files (contain commit hash id)"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},22719:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/git-objects-bc78d893dec6ea4b262dc8c775eac8c1.webp"},22182:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/git-packfile-1c1bfc441cb4caa0acbf39aaa36ebdda.webp"},86145:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var i=t(57140);const r={},c=i.createContext(r);function s(e){const n=i.useContext(c);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);