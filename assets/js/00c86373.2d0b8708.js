"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[48001],{2433:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>t});const s=JSON.parse('{"id":"web/node/module","title":"Module","description":"- CommonJS \u6a21\u5757\u5728\u6267\u884c\u9636\u6bb5\u540c\u6b65\u52a0\u8f7d\u5b50\u6a21\u5757\u6587\u4ef6,","source":"@site/content/web/node/module.md","sourceDirName":"web/node","slug":"/web/node/module","permalink":"/notes/web/node/module","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/node/module.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"Node.js","permalink":"/notes/tags/node-js"},{"inline":true,"label":"Module","permalink":"/notes/tags/module"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":5,"frontMatter":{"sidebar_position":5,"tags":["Web","Node.js","Module"]},"sidebar":"tutorialSidebar","previous":{"title":"PNPM","permalink":"/notes/web/node/pnpm"},"next":{"title":"Process","permalink":"/notes/web/node/process"}}');var d=o(35656),l=o(86145);const r={sidebar_position:5,tags:["Web","Node.js","Module"]},i="Module",c={},t=[{value:"CommonJS",id:"commonjs",level:2},{value:"ESM",id:"esm",level:2},{value:"CallBack",id:"callback",level:2},{value:"Resolution",id:"resolution",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"module",children:"Module"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"CommonJS \u6a21\u5757\u5728\u6267\u884c\u9636\u6bb5\u540c\u6b65\u52a0\u8f7d\u5b50\u6a21\u5757\u6587\u4ef6,\nES6 \u6a21\u5757\u5728\u9884\u5904\u7406\u9636\u6bb5\u52a0\u8f7d\u5b50\u6a21\u5757\u6587\u4ef6, ES6 \u6a21\u5757\u5728\u6267\u884c\u9636\u6bb5\u4e5f\u4f1a\u52a0\u8f7d\u5b50\u6a21\u5757\u6587\u4ef6, \u4e0d\u8fc7\u4f1a\u4f7f\u7528\u9884\u5904\u7406\u9636\u6bb5\u7684\u7f13\u5b58."}),"\n",(0,d.jsx)(n.li,{children:"CommonJS \u6a21\u5757\u540c\u6b65\u52a0\u8f7d\u5e76\u6267\u884c\u6a21\u5757\u6587\u4ef6, ES6 \u6a21\u5757\u63d0\u524d\u52a0\u8f7d\u5e76\u6267\u884c\u6a21\u5757\u6587\u4ef6.\n\u5f02\u6b65\u901a\u5e38\u88ab\u7406\u89e3\u4e3a\u5ef6\u540e\u4e00\u4e2a\u65f6\u95f4\u8282\u70b9\u6267\u884c, \u6240\u4ee5\u8bf4\u6210\u5f02\u6b65\u52a0\u8f7d\u662f\u9519\u8bef\u7684."}),"\n",(0,d.jsx)(n.li,{children:"\u4ece\u5f62\u5f0f\u4e0a\u770b,\nCommonJS \u6a21\u5757\u6574\u4f53\u5bfc\u51fa\u4e00\u4e2a\u5305\u542b\u82e5\u5e72\u4e2a\u53d8\u91cf\u7684\u5bf9\u8c61,\nES6 \u6a21\u5757\u5206\u5f00\u5bfc\u51fa\u5355\u4e2a\u53d8\u91cf."}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"commonjs",children:"CommonJS"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"CommonJS"})," \u6a21\u5757\u4e00\u822c\u7531\u5305\u7ba1\u7406\u5668\u63d0\u4f9b\u7684\u8fd0\u884c\u65f6\u5b9e\u73b0."]}),"\n",(0,d.jsxs)(n.li,{children:["\u7531\u4e8e ",(0,d.jsx)(n.code,{children:"require"})," \u8bed\u53e5\u76f4\u63a5\u5206\u5272\u4e86\u6267\u884c\u7684\u4ee3\u7801\u5757,\n",(0,d.jsx)(n.code,{children:"CommonJS"})," \u6a21\u5757\u7684\u5bfc\u5165\u5bfc\u51fa\u8bed\u53e5\u7684\u4f4d\u7f6e\u4f1a\u5f71\u54cd\u6a21\u5757\u4ee3\u7801\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c."]}),"\n"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-ts",children:"const fs = require('node:fs')\nconst path = require('node:path')\nconst vm = require('node:vm')\n\nfunction Module(id) {\n  this.id = id\n  this.exports = {}\n}\n\nModule.wrapper = [\n  '(function(exports, module, Require, __dirname, __filename) {',\n  '})',\n]\n\nModule._extensions = {\n  '.js': function (module) {\n    const content = fs.readFileSync(module.id, 'utf8')\n    const fnStr = Module.wrapper[0] + content + Module.wrapper[1]\n    const fn = vm.runInThisContext(fnStr)\n    fn.call(\n      module.exports, // Bind `this` to `module.exports`\n      module.exports,\n      module,\n      Require,\n      _dirname,\n      _filename\n    )\n  },\n  '.json': function (module) {\n    const json = fs.readFileSync(module.id, 'utf8')\n    module.exports = JSON.parse(json) // \u628a\u6587\u4ef6\u7684\u7ed3\u679c\u653e\u5728exports\u5c5e\u6027\u4e0a\n  },\n}\n\nfunction Require(modulePath) {\n  const absPathname = path.resolve(__dirname, modulePath)\n  const module = new Module(absPathname)\n  tryModuleLoad(module)\n  return module.exports\n}\n\nfunction tryModuleLoad(module) {\n  const extension = path.extname(module.id)\n  Module._extensions[extension](module)\n}\n"})}),"\n",(0,d.jsx)(n.h2,{id:"esm",children:"ESM"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"ES6"})," \u6a21\u5757\u501f\u52a9 ",(0,d.jsx)(n.code,{children:"JS"})," \u5f15\u64ce\u5b9e\u73b0.\n",(0,d.jsx)(n.code,{children:"JS"})," \u5f15\u64ce\u5b9e\u73b0\u4e86 ",(0,d.jsx)(n.code,{children:"ES6"})," \u6a21\u5757\u7684\u5e95\u5c42\u6838\u5fc3\u903b\u8f91."]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"ES6"})," \u6a21\u5757\u6709 5 \u79cd\u72b6\u6001,\n\u5206\u522b\u4e3a ",(0,d.jsx)(n.code,{children:"unlinked"}),", ",(0,d.jsx)(n.code,{children:"linking"}),", ",(0,d.jsx)(n.code,{children:"linked"}),", ",(0,d.jsx)(n.code,{children:"evaluating"})," and ",(0,d.jsx)(n.code,{children:"evaluated"}),"\n(Module Environment Records)."]}),"\n",(0,d.jsxs)(n.li,{children:["\u7531\u4e8e\u8fde\u63a5\u9636\u6bb5\u4f1a\u7ed9\u5bfc\u5165\u6a21\u5757\u53d8\u91cf\u521b\u5efa\u7ed1\u5b9a\u5e76\u521d\u59cb\u5316\u4e3a\u5b50\u6a21\u5757\u7684\u5bf9\u5e94\u53d8\u91cf,\n\u5b50\u6a21\u5757\u7684\u5bf9\u5e94\u53d8\u91cf\u5728\u8bc4\u4f30\u9636\u6bb5\u4f1a\u5148\u88ab\u8d4b\u503c,\n\u6240\u4ee5\u5bfc\u5165\u6a21\u5757\u53d8\u91cf\u83b7\u5f97\u4e86\u548c\u51fd\u6570\u58f0\u660e\u53d8\u91cf\u4e00\u6837\u7684\u63d0\u5347\u6548\u679c.\n",(0,d.jsx)(n.code,{children:"ES6"})," \u6a21\u5757\u7684 ",(0,d.jsx)(n.code,{children:"import/export"})," \u4f4d\u7f6e\u4e0d\u5f71\u54cd\u6a21\u5757\u4ee3\u7801\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c."]}),"\n",(0,d.jsxs)(n.li,{children:["Experimental ",(0,d.jsx)(n.code,{children:".mjs"})," file."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"callback",children:"CallBack"}),"\n",(0,d.jsx)(n.p,{children:"\u7f16\u5199\u5177\u6709\u56de\u8c03\u51fd\u6570\u53c2\u6570\u7684\u6a21\u5757:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-ts",children:"function foo(x, y, callback) {\n  try {\n    if (paramNotValid())\n      throw new Error('Invalid parameters!')\n    else\n      callback(null, param)\n  } catch (error) {\n    callback(error, param)\n  }\n}\n\nfoo(a, b, (err, param) => {\n  if (err)\n    processError()\n  else\n    process()\n})\n"})}),"\n",(0,d.jsx)(n.p,{children:"\u5411\u5b9a\u4e49\u6700\u5185\u5c42\u56de\u8c03, \u53ef\u907f\u514d\u56de\u5957\u5d4c\u5957:"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-ts",children:"server.on('request', (req, res) => {\n  const render = function (wsData) {\n    page = pageRender(req, session, userData, wsData)\n  }\n  const getWsInfo = function (userData) {\n    ws.get(req, render)\n  }\n  const getDbInfo = function (session) {\n    db.get(session.user, getWsInfo)\n  }\n  const getMemCached = function (req, res) {\n    memcached.getSession(req, getDbInfo)\n  }\n})\n"})}),"\n",(0,d.jsx)(n.h2,{id:"resolution",children:"Resolution"}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"const x = require('./module')"}),":"]}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/root/src/module/package.json"})," + ",(0,d.jsx)(n.code,{children:'{ "main": "lib/mainModule.js" }'}),"\n= ",(0,d.jsx)(n.code,{children:"/root/src/module/lib/mainModule.js"})]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/module/index.js"})}),"\n"]}),"\n",(0,d.jsxs)(n.p,{children:[(0,d.jsx)(n.code,{children:"const x = require('module')"}),":"]}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/node_modules/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/root/src/node_modules/module/package.json"})," (if it specifies a ",(0,d.jsx)(n.code,{children:"main"})," property)"]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/src/node_modules/module/index.js"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/node_modules/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/root/node_modules/module/package.json"})," (if it specifies a ",(0,d.jsx)(n.code,{children:"main"})," property)"]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/root/node_modules/module/index.js"})}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/node_modules/module.js"})}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:"/node_modules/module/package.json"})," (if it specifies a ",(0,d.jsx)(n.code,{children:"main"})," property)"]}),"\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"/node_modules/module/index.js"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(a,{...e})}):a(e)}},86145:(e,n,o)=>{o.d(n,{R:()=>r,x:()=>i});var s=o(57140);const d={},l=s.createContext(d);function r(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:r(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);