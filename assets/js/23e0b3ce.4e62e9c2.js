"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[68440],{53353:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"web/react/concurrent","title":"Concurrent","description":"Features","source":"@site/content/web/react/concurrent.md","sourceDirName":"web/react","slug":"/web/react/concurrent","permalink":"/notes/web/react/concurrent","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/concurrent.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Concurrent","permalink":"/notes/tags/concurrent"},{"inline":true,"label":"Asynchronous","permalink":"/notes/tags/asynchronous"},{"inline":true,"label":"Suspense","permalink":"/notes/tags/suspense"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":8,"frontMatter":{"sidebar_position":8,"tags":["Web","React","Concurrent","Asynchronous","Suspense"]},"sidebar":"tutorialSidebar","previous":{"title":"Context","permalink":"/notes/web/react/context"},"next":{"title":"Server Components","permalink":"/notes/web/react/server-components"}}');var s=t(35656),o=t(86145);const i={sidebar_position:8,tags:["Web","React","Concurrent","Asynchronous","Suspense"]},c="Concurrent",a={},l=[{value:"Features",id:"features",level:2},{value:"Batching Updates",id:"batching-updates",level:2},{value:"Suspense",id:"suspense",level:2},{value:"Error Boundary",id:"error-boundary",level:3},{value:"Lazy",id:"lazy",level:3},{value:"SSR",id:"ssr",level:3}];function d(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"concurrent",children:"Concurrent"})}),"\n",(0,s.jsx)(e.h2,{id:"features",children:"Features"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import App from 'App'\nimport * as ReactDOM from 'react-dom'\n\n// Create a root by using ReactDOM.createRoot():\nconst root = ReactDOM.createRoot(document.getElementById('app'))\n\n// Render the main <App/> element to the root:\nroot.render(<App />)\n"})}),"\n",(0,s.jsx)(e.h2,{id:"batching-updates",children:"Batching Updates"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["All updates will be automatically batched,\nincluding updates inside of ",(0,s.jsx)(e.strong,{children:"promises, async code and native event handlers"}),"."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"ReactDOM.flushSync"})," can opt-out of automatic batching."]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function handleClick() {\n  // React 17: Re-rendering happens after both of the states are updated.\n  // This is called batching.\n  // This is also the default behavior of React 18.\n  setIsBirthday(b => !b)\n  setAge(a => a + 1)\n}\n\n// For the following code blocks,\n// React 18 does automatic batching, but React 17 doesn't.\n// 1. Promises:\nfunction handleClick() {\n  fetchSomething().then(() => {\n    setIsBirthday(b => !b)\n    setAge(a => a + 1)\n  })\n}\n\n// 2. Async code:\nsetInterval(() => {\n  setIsBirthday(b => !b)\n  setAge(a => a + 1)\n}, 5000)\n\n// 3. Native event handlers:\nelement.addEventListener('click', () => {\n  setIsBirthday(b => !b)\n  setAge(a => a + 1)\n})\n"})}),"\n",(0,s.jsx)(e.p,{children:"Reconciler \u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1\u65f6, \u4f1a\u901a\u8fc7\u8282\u6d41\u4e0e\u9632\u6296\u63d0\u5347\u8c03\u5ea6\u6027\u80fd:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u5728 Task \u6ce8\u518c\u5b8c\u6210\u540e, \u4f1a\u8bbe\u7f6e ",(0,s.jsx)(e.code,{children:"FiberRoot"})," \u7684\u5c5e\u6027, \u4ee3\u8868\u73b0\u5728\u5df2\u7ecf\u5904\u4e8e\u8c03\u5ea6\u8fdb\u884c\u4e2d."]}),"\n",(0,s.jsxs)(e.li,{children:["\u518d\u6b21\u8fdb\u5165 ",(0,s.jsx)(e.code,{children:"ensureRootIsScheduled"})," \u65f6\n(\u6bd4\u5982\u8fde\u7eed 2 \u6b21 ",(0,s.jsx)(e.code,{children:"setState"}),", \u7b2c\u4e8c\u6b21 ",(0,s.jsx)(e.code,{children:"setState"})," \u540c\u6837\u4f1a\u89e6\u53d1 Reconciler \u4e0e Scheduler \u6267\u884c),\n\u5982\u679c\u53d1\u73b0\u5904\u4e8e\u8c03\u5ea6\u4e2d, \u5219\u4f1a\u901a\u8fc7\u8282\u6d41\u4e0e\u9632\u6296, \u4fdd\u8bc1\u8c03\u5ea6\u6027\u80fd."]}),"\n",(0,s.jsxs)(e.li,{children:["\u8282\u6d41:\n",(0,s.jsx)(e.code,{children:"existingCallbackPriority === newCallbackPriority"}),",\n\u65b0\u65e7\u66f4\u65b0\u7684\u4f18\u5148\u7ea7\u76f8\u540c, \u5219\u65e0\u9700\u6ce8\u518c\u65b0 Task, \u7ee7\u7eed\u6cbf\u7528\u4e0a\u4e00\u4e2a\u4f18\u5148\u7ea7\u76f8\u540c\u7684 Task, \u76f4\u63a5\u9000\u51fa\u8c03\u7528."]}),"\n",(0,s.jsxs)(e.li,{children:["\u9632\u6296:\n",(0,s.jsx)(e.code,{children:"existingCallbackPriority !== newCallbackPriority"}),",\n\u65b0\u65e7\u66f4\u65b0\u7684\u4f18\u5148\u7ea7\u4e0d\u540c, \u5219\u53d6\u6d88\u65e7 Task, \u91cd\u65b0\u6ce8\u518c\u65b0 Task."]}),"\n"]}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberWorkLoop.js",children:"EnsureRootIsScheduled"}),":"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"function ensureRootIsScheduled(root: FiberRoot, currentTime: number) {\n  const existingCallbackNode = root.callbackNode\n  const nextLanes = getNextLanes(\n    root,\n    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes,\n  )\n\n  if (nextLanes === NoLanes) {\n    if (existingCallbackNode !== null)\n      cancelCallback(existingCallbackNode)\n\n    root.callbackNode = null\n    root.callbackPriority = NoLane\n    return\n  }\n\n  const newCallbackPriority = getHighestPriorityLane(nextLanes)\n  const existingCallbackPriority = root.callbackPriority\n\n  // Debounce.\n  if (existingCallbackPriority === newCallbackPriority) {\n    // The priority hasn't changed. We can reuse the existing task. Exit.\n    return\n  }\n\n  // Throttle.\n  if (existingCallbackNode != null) {\n    // Cancel the existing callback. We'll schedule a new one below.\n    cancelCallback(existingCallbackNode)\n  }\n\n  // Schedule a new callback.\n  let newCallbackNode\n\n  if (newCallbackPriority === SyncLane) {\n    if (root.tag === LegacyRoot)\n      scheduleLegacySyncCallback(performSyncWorkOnRoot.bind(null, root))\n    else scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root))\n\n    if (supportsMicroTasks) {\n      scheduleMicroTask(() => {\n        if (executionContext === NoContext)\n          flushSyncCallbacks()\n      })\n    } else {\n      scheduleCallback(ImmediateSchedulerPriority, flushSyncCallbacks)\n    }\n\n    newCallbackNode = null\n  } else {\n    const eventPriority = lanesToEventPriority(nextLanes)\n    const schedulerPriorityLevel\n      = eventPriorityToSchedulePriority(eventPriority)\n    newCallbackNode = scheduleCallback(\n      schedulerPriorityLevel,\n      performConcurrentWorkOnRoot.bind(null, root),\n    )\n  }\n\n  root.callbackPriority = newCallbackPriority\n  root.callbackNode = newCallbackNode\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"suspense",children:"Suspense"}),"\n",(0,s.jsx)(e.p,{children:"Extract loading/skeleton/placeholder components into single place:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"export default function App() {\n  return (\n    <Suspense fallback={<Skeleton />}>\n      <Header />\n      <Suspense fallback={<ListPlaceholder />}>\n        <ListLayout>\n          <List pageId={pageId} />\n        </ListLayout>\n      </Suspense>\n    </Suspense>\n  )\n}\n"})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.a,{href:"https://jser.dev/react/2022/04/02/suspense-in-concurrent-mode-1-reconciling",children:(0,s.jsx)(e.img,{src:"https://jser.dev/static/suspense-fiber-structure-hidden.png",alt:"Suspense Fiber Structure"})})}),"\n",(0,s.jsx)(e.admonition,{title:"React Bottlenecks",type:"tip",children:(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"CPU bottleneck: Concurrency Feature (Priority Interrupt Mechanism)."}),"\n",(0,s.jsx)(e.li,{children:"I/O bottleneck: Suspense."}),"\n"]})}),"\n",(0,s.jsx)(e.h3,{id:"error-boundary",children:"Error Boundary"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:'function ErrorFallback() {\n  return (\n    <div\n      className="text-red-500 w-screen h-screen flex flex-col justify-center items-center"\n      role="alert"\n    >\n      <h2 className="text-lg font-bold">Oops, something went wrong :( </h2>\n      <Button\n        className="mt-4"\n        onClick={() => window.location.assign(window.location.origin)}\n      >\n        Refresh\n      </Button>\n    </div>\n  )\n}\n\ninterface AppProviderProps {\n  children: React.ReactNode\n}\n\nexport function AppProvider({ children }: AppProviderProps) {\n  return (\n    <React.Suspense\n      fallback={(\n        <div className="h-screen w-screen flex items-center justify-center">\n          <Spinner size="xl" />\n        </div>\n      )}\n    >\n      <ErrorBoundary FallbackComponent={ErrorFallback}>\n        {children}\n      </ErrorBoundary>\n    </React.Suspense>\n  )\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"lazy",children:"Lazy"}),"\n",(0,s.jsx)(e.p,{children:"Lazy loading and code splitting:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:'import { lazy, Suspense } from \'react\'\n\nconst Product = lazy(() => import(\'./ProductHandler\'))\n\nexport default function App() {\n  return (\n    <div className="product-list">\n      <h1>My Awesome Product</h1>\n      <Suspense fallback={<h2>Product list is loading...</h2>}>\n        <p>Take a look at my product:</p>\n        <section>\n          <Product id="PDT-49-232" />\n          <Product id="PDT-50-233" />\n          <Product id="PDT-51-234" />\n        </section>\n      </Suspense>\n    </div>\n  )\n}\n'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"const { lazy, Suspense } = React\n\nconst Lazy = lazy(\n  () =>\n    new Promise((resolve) => {\n      setTimeout(() => {\n        resolve({ default: () => <Resource /> })\n      }, 4000)\n    }),\n)\n\nfunction Resource() {\n  return (\n    <div className=\"box\">\n      <h1>React Lazy</h1>\n      <p>\n        This component loaded after 4 seconds, using React Lazy and Suspense\n      </p>\n    </div>\n  )\n}\n\nexport default function App() {\n  return (\n    <Suspense fallback={<div>Loading...</div>}>\n      <Lazy />\n    </Suspense>\n  )\n}\n\nReactDOM.createRoot(document.getElementById('root')).render(<App />)\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"function createModuleLoader(load) {\n  return {\n    module: null,\n    promise: null,\n    error: null,\n    load() {\n      if (this.module != null) {\n        return this.module\n      }\n\n      if (this.error != null) {\n        throw this.error\n      }\n\n      if (this.promise == null) {\n        this.promise = load().then((res) => {\n          // suppose we get an ES module\n          this.module = res.default\n        }, (error) => {\n          this.error = error\n        })\n      }\n\n      throw this.promise\n    }\n  }\n}\n\nfunction lazy(load) {\n  const moduleLoader = createModuleLoader(load)\n  return function (props) {\n    const Component = moduleLoader.load()\n    return <Component {...props} />\n  }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"ssr",children:"SSR"}),"\n",(0,s.jsxs)(e.p,{children:["React v18+: enable ",(0,s.jsx)(e.code,{children:"Suspense"})," on the server:"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Selective Hydration: one slow part doesn't slow down whole page."}),"\n",(0,s.jsx)(e.li,{children:"Streaming HTML: show initial HTML early and stream the rest HTML."}),"\n",(0,s.jsx)(e.li,{children:"Enable code splitting for SSR."}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"export default function LandingPage() {\n  return (\n    <div>\n      <FastComponent />\n      <Suspense fallback={<Spinner />}>\n        <Comments />\n      </Suspense>\n    </div>\n  )\n}\n"})}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.a,{href:"https://jser.dev/react/2023/03/27/hydration-with-suspense",children:"Hydration for Suspense"}),":"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Suspense is serialized by comment node with ",(0,s.jsx)(e.code,{children:"\x3c!--$--\x3e"})," meaning non-suspended,\nand ",(0,s.jsx)(e.code,{children:"\x3c!--$!--\x3e"})," as suspended."]}),"\n",(0,s.jsx)(e.li,{children:"Hydration for Suspense is 2-pass process in order to put it into lower priority."}),"\n",(0,s.jsxs)(e.li,{children:["During hydration:","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"If pre-existing DOM is fallback, then it'll be discarded\nand client-side rendering will generate the new DOM, either fallback or contents."}),"\n",(0,s.jsx)(e.li,{children:"If pre-existing DOM is contents, but client-side suspends.\nWe want to switch the contents directly without fallback in the middle, so fallback won't be displayed."}),"\n",(0,s.jsx)(e.li,{children:"If pre-existing DOM is contents and also is the client-side,\nthen hydration continues to the children of Suspense."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-tsx",children:"import * as React from 'react'\nimport './style.css'\n\nfunction createCounter(delay) {\n  return {\n    data: null,\n    promise: null,\n    fetch() {\n      if (this.data != null) {\n        return this.data\n      }\n\n      if (this.promise == null) {\n        this.promise = new Promise((resolve) => {\n          setTimeout(() => {\n            this.data = delay\n            resolve(this.data)\n          }, delay)\n        })\n      }\n      throw this.promise\n    },\n  }\n}\n\nconst counter1000 = createCounter(1000)\nconst counter2000 = createCounter(2000)\n\nfunction Component({ counter }) {\n  const count = counter.fetch()\n  return (<button type=\"button\">{count}</button>)\n}\n\nfunction render(jsx, context) {\n  if (jsx == null) {\n    return ''\n  }\n\n  if (typeof jsx === 'string' || typeof jsx === 'number') {\n    return jsx\n  }\n\n  if (typeof jsx.type === 'string') {\n    return `<${jsx.type}>${render(jsx.props.children, context)}</${jsx.type}>`\n  }\n\n  if (Array.isArray(jsx)) {\n    return jsx.map(item => render(item, context)).join('')\n  }\n\n  if (typeof jsx.type === 'function') {\n    return render(jsx.type(jsx.props), context)\n  }\n\n  if (jsx.type === Symbol.for('react.suspense')) {\n    try {\n      return `<div hidden id=\"S:${context.id}\">${render(\n        jsx.props.children,\n        context\n      )}</div><script>TODO: some script to kick off the re-render of target suspense boundary<\/script>`\n    } catch (e) {\n      if ('then' in e) {\n        const currentContext = { ...context }\n        e.then(() => {\n          context.pipe(render(jsx, currentContext))\n        })\n\n        return `\x3c!--$?--\x3e<template id=\"B:${context.id++}\"></template>${render(\n          jsx.props.fallback,\n          context\n        )}\x3c!--/$--\x3e`\n      } else {\n        throw new Error(`error in rendering:${e}`)\n      }\n    }\n  }\n  throw new Error(`unhandled type${jsx.type}`)\n}\n\nfunction renderToPipe(jsx, pipe) {\n  pipe(\n    render(jsx, {\n      pipe,\n      id: 0, // increment id to differentiate suspense boundaries.\n    })\n  )\n}\n\nexport default function App() {\n  const [chunks, setChunks] = React.useState([])\n\n  const pipe = React.useCallback((chunk) => {\n    console.log('pipe', chunk)\n    setChunks(chunks => [...chunks, chunk])\n  }, [])\n\n  React.useEffect(() => {\n    const jsx = (\n      <div>\n        <React.Suspense fallback=\"loading\">\n          <Component counter={counter1000} />\n        </React.Suspense>\n        <React.Suspense fallback=\"loading\">\n          <Component counter={counter2000} />\n        </React.Suspense>\n        <p>another p</p>\n      </div>\n    )\n    renderToPipe(jsx, pipe)\n  }, [pipe])\n\n  return (\n    <div>\n      {chunks.map((chunk, i) => (\n        <div key={chunk.id}>\n          <p>\n            chunk\n            {i + 1}\n          </p>\n          <code>{chunk}</code>\n          <hr />\n        </div>\n      ))}\n    </div>\n  )\n}\n"})})]})}function u(n={}){const{wrapper:e}={...(0,o.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}},86145:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>c});var r=t(57140);const s={},o=r.createContext(s);function i(n){const e=r.useContext(o);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:i(n.components),r.createElement(o.Provider,{value:e},n.children)}}}]);