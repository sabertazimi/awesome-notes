"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[61112],{31794:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"web/react/redux/middleware","title":"Middleware","description":"Redux middleware were designed to enable writing side effects logic:","source":"@site/content/web/react/redux/middleware.md","sourceDirName":"web/react/redux","slug":"/web/react/redux/middleware","permalink":"/notes/web/react/redux/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/redux/middleware.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Redux","permalink":"/notes/tags/redux"},{"inline":true,"label":"State Management","permalink":"/notes/tags/state-management"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3,"tags":["Web","React","Redux","State Management"]},"sidebar":"tutorialSidebar","previous":{"title":"Toolkit","permalink":"/notes/web/react/redux/toolkit"},"next":{"title":"Query","permalink":"/notes/web/react/redux/query"}}');var i=t(35656),d=t(86145);const s={sidebar_position:3,tags:["Web","React","Redux","State Management"]},c="Middleware",a={},l=[{value:"Concepts",id:"concepts",level:2},{value:"Types",id:"types",level:2},{value:"Scheduler",id:"scheduler",level:2},{value:"Thunk",id:"thunk",level:2},{value:"Internals",id:"internals",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,i.jsx)(n.p,{children:"Redux middleware were designed to enable writing side effects logic:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"I/O: logging, saving files."}),"\n",(0,i.jsx)(n.li,{children:"AJAX HTTP request."}),"\n",(0,i.jsx)(n.li,{children:"Async timer."}),"\n",(0,i.jsxs)(n.li,{children:["Modifying state outside of ",(0,i.jsx)(n.code,{children:"reducer"})," function."]}),"\n",(0,i.jsxs)(n.li,{children:["Mutating arguments to ",(0,i.jsx)(n.code,{children:"dispatch"})," function."]}),"\n",(0,i.jsxs)(n.li,{children:["Generating random numbers or unique random IDs\r\n(e.g. ",(0,i.jsx)(n.code,{children:"uuid()"}),"/",(0,i.jsx)(n.code,{children:"Math.random()"}),"/",(0,i.jsx)(n.code,{children:"Date.now()"}),")."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"concepts",children:"Concepts"}),"\n",(0,i.jsx)(n.p,{children:"\u6bcf\u4e00\u4e2a Middleware \u53ef\u4ee5\u901a\u8fc7\u4e0a\u4e0b\u6587\u83b7\u53d6:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["original ",(0,i.jsx)(n.code,{children:"store"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["original ",(0,i.jsx)(n.code,{children:"store.dispatch"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["get state by ",(0,i.jsx)(n.code,{children:"store.getState"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"dispatch"})," \u5bf9\u8c61\u76f4\u63a5\u53d1\u5e03 ",(0,i.jsx)(n.code,{children:"action"})," \u5bf9\u8c61."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next"})," \u65b9\u6cd5: \u524d\u4e00\u4e2a Middleware \u8fd4\u56de\u7684 ",(0,i.jsx)(n.code,{children:"dispatch"})," \u65b9\u6cd5.\r\n\u5f53\u524d Middleware \u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u5bf9 action \u7684\u5224\u65ad\u548c\u5904\u7406\u7ed3\u679c,\r\n\u51b3\u5b9a\u662f\u5426\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"next"})," \u65b9\u6cd5 (\u662f\u5426\u8df3\u8fc7\u5176\u4ed6 Middleware \u7684 ",(0,i.jsx)(n.code,{children:"dispatch"}),"),\r\n\u4ee5\u53ca\u4f20\u5165\u4ec0\u4e48\u6837\u7684\u53c2\u6570."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4ece\u800c\u5b9e\u73b0\u5982\u4e0b\u529f\u80fd:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Execute extra logic when any action is dispatched."}),"\n",(0,i.jsx)(n.li,{children:"Pause, modify, delay, replace, or halt dispatched actions."}),"\n",(0,i.jsxs)(n.li,{children:["Write extra code that has access to ",(0,i.jsx)(n.code,{children:"dispatch"})," and ",(0,i.jsx)(n.code,{children:"getState"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Teach ",(0,i.jsx)(n.code,{children:"dispatch"})," how to accept other values besides plain action objects,\r\nsuch as ",(0,i.jsx)(n.strong,{children:"functions"})," (",(0,i.jsx)(n.code,{children:"action(dispatch, getState, extraArgument)"}),") and promises,\r\nby intercepting them and dispatching real action objects instead."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"types",children:"Types"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export interface Middleware<\r\n  DispatchExt = object,\r\n  S = any,\r\n  D extends Dispatch = Dispatch, // type of the dispatch method\r\n> {\r\n  ext: DispatchExt\r\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import type { Middleware } from 'redux'\r\nimport type { RootState } from '../store'\r\n\r\nexport const exampleMiddleware: Middleware<\r\n  object, // Most middleware do not modify the dispatch return value\r\n  RootState\r\n> = store => next => (action) => {\r\n  const state = store.getState() // correctly typed as RootState\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"scheduler",children:"Scheduler"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"/**\r\n * Schedules actions with { meta: { delay: N } } to be delayed by N milliseconds.\r\n * Makes `dispatch` return a function to cancel the interval in this case.\r\n */\r\nfunction timeoutScheduler(store) {\r\n  return next => (action) => {\r\n    if (!action.meta || !action.meta.delay)\r\n      return next(action)\r\n\r\n    const intervalId = setTimeout(() => next(action), action.meta.delay)\r\n\r\n    return function cancel() {\r\n      clearInterval(intervalId)\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"thunk",children:"Thunk"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// thunk middleware\r\nfunction thunk(store) {\r\n  return next => action =>\r\n    typeof action === 'function'\r\n      ? action(store.dispatch, store.getState)\r\n      : next(action)\r\n}\r\n\r\nconst createStoreWithMiddleware = applyMiddleware(\r\n  logger,\r\n  thunk,\r\n  timeoutScheduler\r\n)(createStore)\r\nconst store = createStoreWithMiddleware(combineReducers(reducers))\r\n\r\nfunction addFave(tweetId) {\r\n  return (dispatch, getState) => {\r\n    if (getState.tweets[tweetId] && getState.tweets[tweetId].liked)\r\n      return\r\n\r\n    dispatch({ type: IS_LOADING })\r\n    // Yay, that could be sync or async dispatching\r\n    remote.addFave(tweetId).then(\r\n      (res) => {\r\n        dispatch({ type: ADD_FAVE_SUCCEED })\r\n      },\r\n      (err) => {\r\n        dispatch({ type: ADD_FAVE_FAILED, err })\r\n      }\r\n    )\r\n  }\r\n}\r\n\r\nstore.dispatch(addFave())\n"})}),"\n",(0,i.jsx)(n.h2,{id:"internals",children:"Internals"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Raw Middleware: ",(0,i.jsx)(n.code,{children:"store => next => action => T"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"middleware(store)"}),": ",(0,i.jsx)(n.code,{children:"next => action => T"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"middleware(store)(next)"}),": ",(0,i.jsx)(n.code,{children:"action => T"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next"}),": ",(0,i.jsx)(n.code,{children:"action => T"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"dispatch"}),": ",(0,i.jsx)(n.code,{children:"action => T"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"middleware(store)(next)"}),", ",(0,i.jsx)(n.code,{children:"next"})," and ",(0,i.jsx)(n.code,{children:"dispatch"})," have same function signature:\r\n",(0,i.jsx)(n.code,{children:"type Dispatch = (action: Action | AsyncAction) => any"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["After ",(0,i.jsx)(n.code,{children:"middlewares.forEach"}),", set ",(0,i.jsx)(n.code,{children:"next"})," to ",(0,i.jsx)(n.code,{children:"store.dispatch"}),",\r\nmake new ",(0,i.jsx)(n.code,{children:"dispatch"})," get all functions from ",(0,i.jsx)(n.code,{children:"middlewares"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function applyMiddleware(store, middlewares) {\r\n  middlewares = middlewares.slice()\r\n  middlewares.reverse()\r\n\r\n  let next = store.dispatch\r\n  // Reduce middlewares with reverse order in Redux.\r\n  middlewares.forEach(middleware => (next = middleware(store)(next)))\r\n\r\n  // When user app execute `dispatch` function,\r\n  // middlewares execute with forward order.\r\n  return Object.assign({}, store, { dispatch: next })\r\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { applyMiddleware, combineReducers, createStore } from 'redux'\r\n\r\n// applyMiddleware takes createStore() and returns\r\n// a function with a compatible API.\r\nconst createStoreWithMiddleware = applyMiddleware(\r\n  logger,\r\n  crashReporter\r\n)(createStore)\r\n\r\n// Use it like you would use createStore()let todoApp = combineReducers(reducers);\r\nconst store = createStoreWithMiddleware(todoApp)\n"})})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},86145:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>c});var r=t(57140);const i={},d=r.createContext(i);function s(e){const n=r.useContext(d);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(d.Provider,{value:n},e.children)}}}]);