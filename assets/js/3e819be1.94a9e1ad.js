"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[97597],{8098:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>d,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"web/devops/service-worker","title":"Service Worker","description":"Progressive Web Apps:","source":"@site/content/web/devops/service-worker.md","sourceDirName":"web/devops","slug":"/web/devops/service-worker","permalink":"/notes/web/devops/service-worker","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/devops/service-worker.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"DevOps","permalink":"/notes/tags/dev-ops"},{"inline":true,"label":"Service Worker","permalink":"/notes/tags/service-worker"},{"inline":true,"label":"PWA","permalink":"/notes/tags/pwa"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1,"tags":["Web","DevOps","Service Worker","PWA"]},"sidebar":"tutorialSidebar","previous":{"title":"DevOps","permalink":"/notes/web/devops/"},"next":{"title":"Rendering Patterns","permalink":"/notes/web/devops/render"}}');var t=r(35656),i=r(86145);const c={sidebar_position:1,tags:["Web","DevOps","Service Worker","PWA"]},a="Service Worker",o={},l=[{value:"Caching Strategy",id:"caching-strategy",level:2},{value:"Registration",id:"registration",level:2},{value:"Broken Images",id:"broken-images",level:2},{value:"Caches Version",id:"caches-version",level:2},{value:"References",id:"references",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"service-worker",children:"Service Worker"})}),"\n",(0,t.jsx)(n.p,{children:"Progressive Web Apps:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Served over ",(0,t.jsx)(n.code,{children:"HTTPS"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Provide a manifest."}),"\n",(0,t.jsxs)(n.li,{children:["Register a ",(0,t.jsx)(n.code,{children:"ServiceWorker"}),"\n(web cache for offline and performance)."]}),"\n",(0,t.jsx)(n.li,{children:"Consists of website, web app manifest,\nservice worker, expanded capabilities\nand OS integration."}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{title:"Pros",type:"tip",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Cache."}),"\n",(0,t.jsx)(n.li,{children:"Offline."}),"\n",(0,t.jsx)(n.li,{children:"Background."}),"\n",(0,t.jsx)(n.li,{children:"Custom request to minimize network."}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://developer.mozilla.org/docs/Web/API/ServiceWorkerRegistration/showNotification",children:"Notification API"}),"."]}),"\n"]})}),"\n",(0,t.jsxs)(n.admonition,{title:"Costs",type:"caution",children:[(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u670d\u52a1\u5de5\u4f5c\u8005\u7ebf\u7a0b\u7f13\u5b58\u4e0d\u81ea\u52a8\u7f13\u5b58\u4efb\u4f55\u8bf7\u6c42, \u6240\u6709\u7f13\u5b58\u90fd\u5fc5\u987b\u660e\u786e\u6307\u5b9a."}),"\n",(0,t.jsx)(n.li,{children:"\u670d\u52a1\u5de5\u4f5c\u8005\u7ebf\u7a0b\u7f13\u5b58\u6ca1\u6709\u5230\u671f\u5931\u6548\u7684\u6982\u5ff5."}),"\n",(0,t.jsx)(n.li,{children:"\u670d\u52a1\u5de5\u4f5c\u8005\u7ebf\u7a0b\u7f13\u5b58\u5fc5\u987b\u624b\u52a8\u66f4\u65b0\u548c\u5220\u9664."}),"\n",(0,t.jsx)(n.li,{children:"\u7f13\u5b58\u7248\u672c\u5fc5\u987b\u624b\u52a8\u7ba1\u7406:\n\u6bcf\u6b21\u670d\u52a1\u5de5\u4f5c\u8005\u7ebf\u7a0b\u66f4\u65b0, \u65b0\u670d\u52a1\u5de5\u4f5c\u8005\u7ebf\u7a0b\u8d1f\u8d23\u63d0\u4f9b\u65b0\u7684\u7f13\u5b58\u952e\u4ee5\u4fdd\u5b58\u65b0\u7f13\u5b58."}),"\n",(0,t.jsx)(n.li,{children:"\u552f\u4e00\u7684\u6d4f\u89c8\u5668\u5f3a\u5236\u9010\u51fa\u7b56\u7565\u57fa\u4e8e\u670d\u52a1\u5de5\u4f5c\u8005\u7ebf\u7a0b\u7f13\u5b58\u5360\u7528\u7684\u7a7a\u95f4.\n\u7f13\u5b58\u8d85\u8fc7\u6d4f\u89c8\u5668\u9650\u5236\u65f6, \u6d4f\u89c8\u5668\u4f1a\u57fa\u4e8e LRU \u539f\u5219\u4e3a\u65b0\u7f13\u5b58\u817e\u51fa\u7a7a\u95f4."}),"\n",(0,t.jsxs)(n.li,{children:["Need startup time: ",(0,t.jsx)(n.code,{children:"performance.getEntriesByName(url)[0].requestStart - performance.getEntriesByName(url)[0].workerStart"}),",\n20~100 ms for desktop, 100 ms for mobile."]}),"\n",(0,t.jsxs)(n.li,{children:["Cache reads aren't always instant:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["cache hit time = read time (only this case better than ",(0,t.jsx)(n.code,{children:"NO SW"}),"),"]}),"\n",(0,t.jsx)(n.li,{children:"cache miss time = read time + network latency,"}),"\n",(0,t.jsx)(n.li,{children:"cache slow time = slow read time + network latency,"}),"\n",(0,t.jsx)(n.li,{children:"SW asleep = SW boot latency + read time ( + network latency),"}),"\n",(0,t.jsx)(n.li,{children:"NO SW = network latency."}),"\n"]}),"\n"]}),"\n"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"const entry = performance.getEntriesByName(url)[0]\n\n// no remote request means this was handled by the cache\nif (entry.transferSize === 0) {\n  const cacheTime = entry.responseStart - entry.requestStart\n}\n\nasync function handleRequest(event) {\n  const cacheStart = performance.now()\n  const response = await caches.match(event.request)\n  const cacheEnd = performance.now()\n}\n"})})]}),"\n",(0,t.jsx)(n.h2,{id:"caching-strategy",children:"Caching Strategy"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Service Worker Cache",src:r(42419).A+"",title:"Service Worker Cache",width:"845",height:"545"})}),"\n",(0,t.jsxs)(n.p,{children:["5 caching strategy in ",(0,t.jsx)(n.a,{href:"https://developer.chrome.com/docs/workbox/caching-strategies-overview",children:"workbox"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Stale-While-Revalidate:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"globalThis.addEventListener('fetch', (event) => {\n  event.respondWith(\n    caches.open(cacheName).then((cache) => {\n      cache.match(event.request).then((cacheResponse) => {\n        fetch(event.request).then((networkResponse) => {\n          cache.put(event.request, networkResponse)\n        })\n\n        return cacheResponse || networkResponse\n      })\n    })\n  )\n})\n"})}),"\n",(0,t.jsx)(n.p,{children:"Cache first, then Network:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"globalThis.addEventListener('fetch', (event) => {\n  event.respondWith(\n    caches.open(cacheName).then((cache) => {\n      cache.match(event.request).then((cacheResponse) => {\n        if (cacheResponse)\n          return cacheResponse\n\n        return fetch(event.request).then((networkResponse) => {\n          cache.put(event.request, networkResponse.clone())\n          return networkResponse\n        })\n      })\n    })\n  )\n})\n"})}),"\n",(0,t.jsx)(n.p,{children:"Network first, then Cache:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"globalThis.addEventListener('fetch', (event) => {\n  event.respondWith(\n    fetch(event.request).catch(() => {\n      return caches.match(event.request)\n    })\n  )\n})\n"})}),"\n",(0,t.jsx)(n.p,{children:"Cache only:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"globalThis.addEventListener('fetch', (event) => {\n  event.respondWith(\n    caches.open(cacheName).then((cache) => {\n      cache.match(event.request).then((cacheResponse) => {\n        return cacheResponse\n      })\n    })\n  )\n})\n"})}),"\n",(0,t.jsx)(n.p,{children:"Network only:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"globalThis.addEventListener('fetch', (event) => {\n  event.respondWith(\n    fetch(event.request).then((networkResponse) => {\n      return networkResponse\n    })\n  )\n})\n"})}),"\n",(0,t.jsx)(n.h2,{id:"registration",children:"Registration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// Check that service workers are registered\nif ('serviceWorker' in navigator) {\n  // Use the window load event to keep the page load performance\n  window.addEventListener('load', () => {\n    navigator.serviceWorker.register('/sw.js')\n  })\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"broken-images",children:"Broken Images"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"function isImage(fetchRequest) {\n  return fetchRequest.method === 'GET' && fetchRequest.destination === 'image'\n}\n\nglobalThis.addEventListener('fetch', (e) => {\n  e.respondWith(\n    fetch(e.request)\n      .then((response) => {\n        if (response.ok)\n          return response\n\n        // User is online, but response was not ok\n        if (isImage(e.request)) {\n          // Get broken image placeholder from cache\n          return caches.match('/broken.png')\n        }\n      })\n      .catch((err) => {\n        // User is probably offline\n        if (isImage(e.request)) {\n          // Get broken image placeholder from cache\n          return caches.match('/broken.png')\n        }\n        process(err)\n      })\n  )\n})\n\nglobalThis.addEventListener('install', (e) => {\n  globalThis.skipWaiting()\n  e.waitUntil(\n    caches.open('precache').then((cache) => {\n      // Add /broken.png to \"precache\"\n      cache.add('/broken.png')\n    })\n  )\n})\n"})}),"\n",(0,t.jsx)(n.h2,{id:"caches-version",children:"Caches Version"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"globalThis.addEventListener('activate', (event) => {\n  const cacheWhitelist = ['v2']\n\n  event.waitUntil(\n    caches.keys().then((keyList) => {\n      return Promise.all([\n        keyList.map((key) => {\n          return cacheWhitelist.includes(key) ? caches.delete(key) : null\n        }),\n        globalThis.clients.claim(),\n      ])\n    })\n  )\n})\n"})}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Service worker ",(0,t.jsx)(n.a,{href:"https://developer.chrome.com/docs/workbox/service-worker-overview",children:"overview"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Workbox ",(0,t.jsx)(n.a,{href:"https://github.com/GoogleChrome/workbox",children:"library"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Offline cookbook ",(0,t.jsx)(n.a,{href:"https://web.dev/offline-cookbook",children:"guide"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["PWA extensive ",(0,t.jsx)(n.a,{href:"https://www.smashingmagazine.com/2018/11/guide-pwa-progressive-web-applications",children:"guide"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Network reliable web app definitive ",(0,t.jsx)(n.a,{href:"https://web.dev/reliable",children:"guide"}),":","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://web.dev/resilient-search-experiences",children:"Resilient search"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://web.dev/instant-navigation-experiences",children:"Instant navigation"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://web.dev/app-shell-ux-with-service-workers",children:"App shell"}),">"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://web.dev/adaptive-loading-with-service-workers",children:"Adaptive loading"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://web.dev/broadcast-updates-guide",children:"Broadcast updates"}),"."]}),"\n"]}),"\n"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},42419:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/images/service-worker-cache-1a97150573c7890e205fa561615e88b1.webp"},86145:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>a});var s=r(57140);const t={},i=s.createContext(t);function c(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);