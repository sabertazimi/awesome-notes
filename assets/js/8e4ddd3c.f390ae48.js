"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[76684],{44170:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>f,frontMatter:()=>i,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"web/vue/modern-reactivity","title":"Modern Reactivity","description":"System","source":"@site/content/web/vue/modern-reactivity.md","sourceDirName":"web/vue","slug":"/web/vue/modern-reactivity","permalink":"/notes/web/vue/modern-reactivity","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/vue/modern-reactivity.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"Vue","permalink":"/notes/tags/vue"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Reactivity","permalink":"/notes/tags/reactivity"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":29,"frontMatter":{"tags":["Web","Vue","Internals","Reactivity"],"sidebar_position":29},"sidebar":"tutorialSidebar","previous":{"title":"Legacy Reactivity","permalink":"/notes/web/vue/legacy-reactivity"},"next":{"title":"Language","permalink":"/notes/language/"}}');var c=t(35656),s=t(86145);const i={tags:["Web","Vue","Internals","Reactivity"],sidebar_position:29},l="Modern Reactivity",a={},o=[{value:"System",id:"system",level:2},{value:"Effects",id:"effects",level:2},{value:"Proxy",id:"proxy",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"modern-reactivity",children:"Modern Reactivity"})}),"\n",(0,c.jsx)(n.h2,{id:"system",children:"System"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"effect.ts"}),": ",(0,c.jsx)(n.code,{children:"effect"}),", ",(0,c.jsx)(n.code,{children:"track"}),", ",(0,c.jsx)(n.code,{children:"trigger"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"baseHandlers.ts"}),": proxy handler (",(0,c.jsx)(n.code,{children:"get"})," and ",(0,c.jsx)(n.code,{children:"set"}),")."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"reactive.ts"}),": ",(0,c.jsx)(n.code,{children:"reactive"})," using ES6 Proxy."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"ref.ts"}),":","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"reactive reference using Object Accessors."}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"ref"})," performant over ",(0,c.jsx)(n.code,{children:"reactive"}),"."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"computed.ts"}),": ",(0,c.jsx)(n.code,{children:"computed"})," using ",(0,c.jsx)(n.code,{children:"effect"})," and return a ",(0,c.jsx)(n.code,{children:"ref"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"effects",children:"Effects"}),"\n",(0,c.jsxs)(n.p,{children:["Data ",(0,c.jsx)(n.code,{children:"getter"}),"/",(0,c.jsx)(n.code,{children:"setter"})," -> Notify -> Watcher -> Trigger --\x3e Renderer:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"console.log(data.a) // getHook() get called.\ndata.a = 2 // setHook() get called.\n"})}),"\n",(0,c.jsx)(n.p,{children:"Effects bucket:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"targetMap"})," = ",(0,c.jsx)(n.code,{children:"target: effectsMap"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"effectsMap"})," = ",(0,c.jsx)(n.code,{children:"keyName: effectsSet"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"type Primitive = string | number | boolean\ntype Key = string | symbol\ntype Effect<T> = () => T\n\nconst runningEffects = []\n\nconst targetMap = new WeakMap()\n\nconst IterateKey = Symbol('IterateKey')\nconst LengthKey = 'length'\n\n// runEffect -> effect -> proxy.get -> track.\nfunction createEffect<T>(effect: Effect<T>) {\n  runningEffects.push(effect)\n  effect()\n  runningEffects.pop()\n}\n\nfunction track<T extends object>(target: T, key: Key) {\n  for (const effect of runningEffects) {\n    let effectsMap = targetMap.get(target)\n    if (!effectsMap)\n      targetMap.set(target, (effectsMap = new Map()))\n\n    let effects = effectsMap.get(key)\n    if (!effects)\n      effectsMap.set(key, (effects = new Set()))\n\n    effects.add(effect)\n  }\n}\n\nfunction trigger<T extends object>(target: T, key: Key, type: Type) {\n  const effectsMap = targetMap.get(target)\n  if (!effectsMap)\n    return\n\n  const effectsToRun = new Set()\n\n  const ordinaryEffects = effectsMap.get(key)\n  ordinaryEffects?.forEach((effect) => {\n    // Remove current running effect\n    // to avoid infinite call stack\n    // (skip triggering current tracking effect):\n    // reactive.foo = reactive.foo + 1;\n    if (effect !== runningEffects.top())\n      effectsToRun.add(effect)\n  })\n\n  if (type === 'ADD' || type === 'DELETE') {\n    const iterateEffects = effectsMap.get(IterateKey)\n    iterateEffects?.forEach((effect) => {\n      if (effect !== runningEffects.top())\n        effectsToRun.add(effect)\n    })\n  }\n\n  if (type === 'LENGTH') {\n    const lengthEffects = effectsMap.get(LengthKey)\n    lengthEffects?.forEach((effect) => {\n      if (effect !== runningEffects.top())\n        effectsToRun.add(effect)\n    })\n  }\n\n  effectsToRun.forEach((effect) => {\n    if (effect.options.scheduler)\n      effect.options.scheduler(effect)\n    else effect()\n  })\n}\n\nexport function reactive<T extends object>(target: T) {\n  const handler: ProxyHandler<T> = {\n    get(target, key, receiver) {\n      const value = Reflect.get(target, key, receiver)\n      track(target, key)\n      if (value !== null && typeof value === 'object')\n        return reactive(value)\n      else return value\n    },\n    has(target, key) {\n      track(target, key)\n      return Reflect.has(target, key)\n    },\n    ownKeys(target) {\n      // Proxy `for key in target` operator.\n      track(target, Array.isArray(target) ? LengthKey : IterateKey)\n      return Reflect.ownKeys(target)\n    },\n    set(target, key, value, receiver) {\n      const type = Array.isArray(target)\n        ? Number(key) < target.length\n          ? 'SET'\n          : 'LENGTH'\n        : Object.hasOwn(target, key)\n          ? 'SET'\n          : 'ADD'\n      const oldValue = Reflect.get(target, key, receiver)\n      const result = Reflect.set(target, key, value, receiver)\n      if (result && oldValue !== value)\n        trigger(target, key, type)\n      return result\n    },\n    deleteProperty(target, key) {\n      const isOwnKey = Object.hasOwn(target, key)\n      const result = Reflect.deleteProperty(target, key)\n      if (result && isOwnKey)\n        trigger(target, key, 'DELETE')\n      return result\n    },\n  }\n\n  return new Proxy(target, handler)\n}\n\nexport function ref<T extends Primitive>(raw?: T) {\n  const refObject = {\n    get value() {\n      track(refObject, 'value')\n      return raw\n    },\n    set value(newValue: T) {\n      raw = newValue\n      trigger(refObject, 'value')\n    },\n  }\n\n  return refObject\n}\n\nexport function computed<T extends Primitive>(getter: () => T) {\n  const refObject = ref<T>()\n  createEffect(() => (refObject.value = getter()))\n  return refObject\n}\n"})}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"interface Product {\n  price: number\n  quantity: number\n}\n\nconst product = reactive<Product>({ price: 5, quantity: 2 })\nconst salePrice = computed(() => product.price * 0.9)\nconst total = computed(() => salePrice.value * product.quantity)\n\nconsole.assert(salePrice.value === 4.5)\nconsole.assert(total.value === 9)\n\nproduct.quantity = 3\nconsole.assert(total.value === 13.5)\n\nproduct.quantity = 4\nconsole.assert(total.value === 18)\n\nproduct.price = 6\nconsole.assert(salePrice.value === 5.4)\nconsole.assert(total.value === 21.6)\n"})}),"\n",(0,c.jsx)(n.h2,{id:"proxy",children:"Proxy"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Simple: ",(0,c.jsx)(n.code,{children:"Proxy"})," \u4f7f\u7528\u4e0a\u6bd4 ",(0,c.jsx)(n.code,{children:"Object.defineProperty"})," \u65b9\u4fbf.","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Object.defineProperty"})," \u53ea\u80fd\u76d1\u542c\u5bf9\u8c61, \u5bfc\u81f4 ",(0,c.jsx)(n.code,{children:"Vue 2"})," ",(0,c.jsx)(n.code,{children:"data"})," \u5c5e\u6027\u5fc5\u987b\u901a\u8fc7\u4e00\u4e2a\u8fd4\u56de\u5bf9\u8c61\u7684\u51fd\u6570\u65b9\u5f0f\u521d\u59cb\u5316."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Vue 3"})," \u66f4\u52a0\u591a\u5143\u5316, \u53ef\u4ee5\u76d1\u542c\u4efb\u610f\u6570\u636e."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["Performant: ",(0,c.jsx)(n.code,{children:"Proxy"})," \u4ee3\u7406\u6574\u4e2a\u5bf9\u8c61, ",(0,c.jsx)(n.code,{children:"Object.defineProperty"})," \u53ea\u4ee3\u7406\u5bf9\u8c61\u4e0a\u7684\u67d0\u4e2a\u5c5e\u6027.","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Object.defineProperty"})," \u7531\u4e8e\u6bcf\u6b21\u53ea\u80fd\u76d1\u542c\u5bf9\u8c61\u4e00\u4e2a\u952e\u7684 ",(0,c.jsx)(n.code,{children:"get"}),"/",(0,c.jsx)(n.code,{children:"set"}),", \u5bfc\u81f4\u9700\u8981\u5faa\u73af\u76d1\u542c\u6d6a\u8d39\u6027\u80fd."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u4e00\u6b21\u6027\u76d1\u542c\u5230\u6240\u6709\u5c5e\u6027."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["Lazy: ",(0,c.jsx)(n.code,{children:"Proxy"})," \u6027\u80fd\u4f18\u4e8e ",(0,c.jsx)(n.code,{children:"Object.defineProperty"}),".","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u5982\u679c\u5bf9\u8c61\u5185\u90e8\u8981\u5168\u90e8\u9012\u5f52\u4ee3\u7406, \u5219 ",(0,c.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u53ea\u5728\u8c03\u7528\u65f6\u9012\u5f52."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Object.defineProperty"})," \u9700\u8981\u5728\u4e00\u5f00\u59cb\u5c31\u5168\u90e8\u9012\u5f52."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["Feature:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u5bf9\u8c61\u4e0a\u5b9a\u4e49\u65b0\u5c5e\u6027\u65f6, \u53ea\u6709 ",(0,c.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u76d1\u542c\u5230:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Vue2: \u63d0\u4f9b ",(0,c.jsx)(n.code,{children:"Vue.set"}),"/",(0,c.jsx)(n.code,{children:"Vue.delete"})," \u7b49\u8f85\u52a9\u65b9\u6cd5."]}),"\n",(0,c.jsxs)(n.li,{children:["Vue3: ",(0,c.jsx)(n.code,{children:"Proxy"})," \u76d1\u542c\u65b0\u5c5e\u6027."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\u6570\u7ec4\u65b0\u589e\u5220\u9664\u4fee\u6539\u65f6, \u53ea\u6709 ",(0,c.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u76d1\u542c\u5230:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Object.defineProperty"})," \u65e0\u6cd5\u76d1\u542c\u6570\u7ec4, ",(0,c.jsx)(n.code,{children:"Proxy"})," \u5219\u53ef\u4ee5\u76f4\u63a5\u76d1\u542c\u6570\u7ec4\u53d8\u5316."]}),"\n",(0,c.jsx)(n.li,{children:"Vue2: \u91cd\u5199\u6570\u7ec4\u65b9\u6cd5\u76d1\u542c\u6570\u7ec4\u53d8\u5316."}),"\n",(0,c.jsxs)(n.li,{children:["Vue3: ",(0,c.jsx)(n.code,{children:"Proxy"})," \u76d1\u542c\u6570\u7ec4\u53d8\u5316."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Proxy"})," \u4e0d\u517c\u5bb9 IE, ",(0,c.jsx)(n.code,{children:"Object.defineProperty"})," \u4e0d\u517c\u5bb9 IE8 \u53ca\u4ee5\u4e0b."]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"Vue 2:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"Vue.set(app.items, indexOfItem, newValue)\nVue.set(app.product, newField, newValue)\n"})}),"\n",(0,c.jsx)(n.p,{children:"Vue 3:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-ts",children:"app.items[indexOfItem] = newValue\napp.product[newField] = newValue\n"})})]})}function f(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}},86145:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var r=t(57140);const c={},s=r.createContext(c);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);