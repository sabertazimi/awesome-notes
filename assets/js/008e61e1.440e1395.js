"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[18243],{91700:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"web/react/scheduler","title":"Scheduler","description":"Work loop in scheduler focus on Task Scheduling,","source":"@site/content/web/react/scheduler.md","sourceDirName":"web/react","slug":"/web/react/scheduler","permalink":"/notes/web/react/scheduler","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/notes/edit/main/content/web/react/scheduler.md","tags":[{"inline":true,"label":"Web","permalink":"/notes/tags/web"},{"inline":true,"label":"React","permalink":"/notes/tags/react"},{"inline":true,"label":"Internals","permalink":"/notes/tags/internals"},{"inline":true,"label":"Scheduler","permalink":"/notes/tags/scheduler"}],"version":"current","lastUpdatedBy":"Sabertaz","lastUpdatedAt":1769518084000,"sidebarPosition":31,"frontMatter":{"sidebar_position":31,"tags":["Web","React","Internals","Scheduler"]},"sidebar":"tutorialSidebar","previous":{"title":"Architecture","permalink":"/notes/web/react/architecture"},"next":{"title":"Fiber","permalink":"/notes/web/react/fiber"}}');var i=t(35656),s=t(86145);const a={sidebar_position:31,tags:["Web","React","Internals","Scheduler"]},o="Scheduler",l={},c=[{value:"Priority",id:"priority",level:2},{value:"Workflow",id:"workflow",level:2},{value:"Time Slicing",id:"time-slicing",level:2},{value:"Task Queue",id:"task-queue",level:2},{value:"Work Loop",id:"work-loop",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"scheduler",children:"Scheduler"})}),"\n",(0,i.jsxs)(n.p,{children:["Work loop in scheduler focus on ",(0,i.jsx)(n.strong,{children:"Task Scheduling"}),",\nnot only including ",(0,i.jsx)(n.code,{children:"Reconciler.performSyncWorkOnRoot"}),"/",(0,i.jsx)(n.code,{children:"Reconciler.performConcurrentWorkOnRoot"}),",\nbut also for non-react tasks\n(meaning ",(0,i.jsx)(n.code,{children:"Scheduler"})," module can work standalone without ",(0,i.jsx)(n.code,{children:"React"}),")."]}),"\n",(0,i.jsx)(n.h2,{id:"priority",children:"Priority"}),"\n",(0,i.jsxs)(n.p,{children:["React 16, unstable concurrent mode with\n",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerPriorities.js",children:(0,i.jsx)(n.code,{children:"Priorities"})}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["ImmediatePriority: \u7acb\u5373\u6267\u884c\u4f18\u5148\u7ea7, \u7ea7\u522b\u6700\u9ad8, ",(0,i.jsx)(n.code,{children:"expirationTime = -1"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["UserBlockingPriority: \u7528\u6237\u963b\u585e\u4f18\u5148\u7ea7, ",(0,i.jsx)(n.code,{children:"expirationTime = 250"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["NormalPriority: \u6b63\u5e38\u4f18\u5148\u7ea7, ",(0,i.jsx)(n.code,{children:"expirationTime = 5000"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["LowPriority: \u4f4e\u4f18\u5148\u7ea7, ",(0,i.jsx)(n.code,{children:"expirationTime = 10000"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["IdlePriority: \u53ef\u95f2\u7f6e\u4f18\u5148\u7ea7, ",(0,i.jsx)(n.code,{children:"expirationTime = maxSigned31BitInt"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["React 17, stable concurrent mode with\n",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberLane.js",children:(0,i.jsx)(n.code,{children:"Lanes"})}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export type Lanes = number\nexport type Lane = number\n\nexport const TotalLanes = 31\n\nexport const NoLanes: Lanes = /*                        */ 0b0000000000000000000000000000000\nexport const NoLane: Lane = /*                          */ 0b0000000000000000000000000000000\n\nexport const SyncLane: Lane = /*                        */ 0b0000000000000000000000000000001\n\nexport const InputContinuousHydrationLane: Lane = /*    */ 0b0000000000000000000000000000010\nexport const InputContinuousLane: Lanes = /*            */ 0b0000000000000000000000000000100\n\nexport const DefaultHydrationLane: Lane = /*            */ 0b0000000000000000000000000001000\nexport const DefaultLane: Lanes = /*                    */ 0b0000000000000000000000000010000\n\nconst TransitionHydrationLane: Lane = /*                */ 0b0000000000000000000000000100000\nconst TransitionLanes: Lanes = /*                       */ 0b0000000001111111111111111000000\nconst TransitionLane1: Lane = /*                        */ 0b0000000000000000000000001000000\nconst TransitionLane2: Lane = /*                        */ 0b0000000000000000000000010000000\nconst TransitionLane3: Lane = /*                        */ 0b0000000000000000000000100000000\nconst TransitionLane4: Lane = /*                        */ 0b0000000000000000000001000000000\nconst TransitionLane5: Lane = /*                        */ 0b0000000000000000000010000000000\nconst TransitionLane6: Lane = /*                        */ 0b0000000000000000000100000000000\nconst TransitionLane7: Lane = /*                        */ 0b0000000000000000001000000000000\nconst TransitionLane8: Lane = /*                        */ 0b0000000000000000010000000000000\nconst TransitionLane9: Lane = /*                        */ 0b0000000000000000100000000000000\nconst TransitionLane10: Lane = /*                       */ 0b0000000000000001000000000000000\nconst TransitionLane11: Lane = /*                       */ 0b0000000000000010000000000000000\nconst TransitionLane12: Lane = /*                       */ 0b0000000000000100000000000000000\nconst TransitionLane13: Lane = /*                       */ 0b0000000000001000000000000000000\nconst TransitionLane14: Lane = /*                       */ 0b0000000000010000000000000000000\nconst TransitionLane15: Lane = /*                       */ 0b0000000000100000000000000000000\nconst TransitionLane16: Lane = /*                       */ 0b0000000001000000000000000000000\n\nconst RetryLanes: Lanes = /*                            */ 0b0000111110000000000000000000000\nconst RetryLane1: Lane = /*                             */ 0b0000000010000000000000000000000\nconst RetryLane2: Lane = /*                             */ 0b0000000100000000000000000000000\nconst RetryLane3: Lane = /*                             */ 0b0000001000000000000000000000000\nconst RetryLane4: Lane = /*                             */ 0b0000010000000000000000000000000\nconst RetryLane5: Lane = /*                             */ 0b0000100000000000000000000000000\n\nexport const SomeRetryLane: Lane = RetryLane1\n\nexport const SelectiveHydrationLane: Lane = /*          */ 0b0001000000000000000000000000000\n\nconst NonIdleLanes = /*                                 */ 0b0001111111111111111111111111111\n\nexport const IdleHydrationLane: Lane = /*               */ 0b0010000000000000000000000000000\nexport const IdleLane: Lanes = /*                       */ 0b0100000000000000000000000000000\n\nexport const OffscreenLane: Lane = /*                   */ 0b1000000000000000000000000000000\n"})}),"\n",(0,i.jsx)(n.h2,{id:"workflow",children:"Workflow"}),"\n",(0,i.jsxs)(n.p,{children:["Scheduler main ",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/scheduler/src/forks/Scheduler.js",children:"workflow"}),":"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"scheduleCallback(callback)"}),"\n-> ",(0,i.jsx)(n.code,{children:"push(queue, newTask)"})," (Wrap ",(0,i.jsx)(n.code,{children:"callback"})," into ",(0,i.jsx)(n.code,{children:"task"}),")\n(For delayed task -> ",(0,i.jsx)(n.code,{children:"requestHostTimeout(handleTimeout, delayTime)"}),")\n-> ",(0,i.jsx)(n.code,{children:"requestHostCallback(flushWork)"}),"\n-> ",(0,i.jsx)(n.code,{children:"messageChannelPort.postMessage(null)"}),"\n-> ",(0,i.jsx)(n.code,{children:"performWorkUntilDeadline()"}),"\n-> ",(0,i.jsx)(n.code,{children:"flushWork(hasTimeRemaining, currentTime)"}),":\n-> ",(0,i.jsx)(n.code,{children:"workLoop(hasTimeRemaining, currentTime)"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"\u5c06 Reconciler \u7684\u5de5\u4f5c (Callback)\n\u5305\u88c5\u6210 Task \u7ec4\u6210 Task Queue,\n\u6309\u7167\u65f6\u95f4\u5206\u7247\u673a\u5236,\n\u4e0d\u65ad\u5730\u6d88\u8d39 Task Queue."}),"\n",(0,i.jsx)(n.p,{children:"\u5bf9\u4e8e\u5ef6\u65f6\u4efb\u52a1 (Delayed Task),\n\u4f1a\u5c06\u5176\u5148\u653e\u5165 Timer Queue,\n\u7b49\u5f85\u5ef6\u65f6\u5b8c\u6210\u540e\u518d\u5c06\u5176\u653e\u5165 Task Queue."}),"\n",(0,i.jsx)(n.h2,{id:"time-slicing",children:"Time Slicing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// \u65f6\u95f4\u5207\u7247\u5468\u671f, \u9ed8\u8ba4\u662f 5ms.\n// \u5982\u679c\u4e00\u4e2a task \u8fd0\u884c\u8d85\u8fc7\u8be5\u5468\u671f, \u4e0b\u4e00\u4e2a task \u6267\u884c\u524d, \u4f1a\u628a\u63a7\u5236\u6743\u5f52\u8fd8\u6d4f\u89c8\u5668.\nconst yieldInterval = 5\nconst maxYieldInterval = 300\n\nlet deadline = 0 // currentTime + yieldInterval.\nlet needsPaint = false\nlet isMessageLoopRunning = false\nlet scheduledHostCallback = null\n\nconst channel = new MessageChannel()\nconst port = channel.port2\nchannel.port1.onmessage = performWorkUntilDeadline\n\nconst scheduling = navigator.scheduling\nconst getCurrentTime = performance.now\n\n// \u8bf7\u6c42\u56de\u8c03:\nfunction requestHostCallback(callback) {\n  // 1. \u4fdd\u5b58 callback.\n  scheduledHostCallback = callback\n\n  if (!isMessageLoopRunning) {\n    isMessageLoopRunning = true\n    // 2. \u901a\u8fc7 MessageChannel \u53d1\u9001\u6d88\u606f.\n    port.postMessage(null)\n  }\n}\n\n// \u53d6\u6d88\u56de\u8c03:\nfunction cancelHostCallback() {\n  scheduledHostCallback = null\n}\n\nfunction requestHostTimeout(callback, ms) {\n  taskTimeoutID = setTimeout(() => {\n    callback(getCurrentTime())\n  }, ms)\n}\n\nfunction cancelHostTimeout() {\n  clearTimeout(taskTimeoutID)\n  taskTimeoutID = -1\n}\n\n// \u662f\u5426\u8ba9\u51fa\u4e3b\u7ebf\u7a0b (time slice):\nfunction shouldYieldToHost() {\n  const currentTime = getCurrentTime()\n\n  if (currentTime >= deadline) {\n    if (needsPaint || scheduling.isInputPending()) {\n      // There is either a pending paint or a pending input.\n      return true\n    }\n\n    // There's no pending input.\n    // Only yield if we've reached max yield interval.\n    return currentTime >= maxYieldInterval\n  } else {\n    // There's still time left in frame.\n    return false\n  }\n}\n\n// \u8bf7\u6c42\u7ed8\u5236:\nfunction requestPaint() {\n  needsPaint = true\n}\n\n// \u5b9e\u9645\u56de\u8c03\u51fd\u6570\u5904\u7406:\nfunction performWorkUntilDeadline() {\n  if (scheduledHostCallback !== null) {\n    // 1. \u8bbe\u7f6e currentTime \u4e0e deadline.\n    const currentTime = getCurrentTime()\n    deadline = currentTime + yieldInterval\n    const hasTimeRemaining = true\n\n    try {\n      // 2. \u6267\u884c\u56de\u8c03, \u8fd4\u56de\u662f\u5426\u6709\u8fd8\u6709\u5269\u4f59\u4efb\u52a1.\n      const hasMoreWork = scheduledHostCallback(hasTimeRemaining, currentTime)\n\n      if (!hasMoreWork) {\n        // \u6ca1\u6709\u5269\u4f59\u4efb\u52a1, \u9000\u51fa.\n        isMessageLoopRunning = false\n        scheduledHostCallback = null\n      } else {\n        port.postMessage(null) // \u6709\u5269\u4f59\u4efb\u52a1, \u53d1\u8d77\u65b0\u7684\u8c03\u5ea6.\n      }\n    } catch (error) {\n      port.postMessage(null) // \u5982\u6709\u5f02\u5e38, \u91cd\u65b0\u53d1\u8d77\u8c03\u5ea6.\n      throw error\n    }\n  } else {\n    isMessageLoopRunning = false\n  }\n\n  needsPaint = false // Reset.\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"task-queue",children:"Task Queue"}),"\n",(0,i.jsxs)(n.p,{children:["Task queue is ",(0,i.jsx)(n.a,{href:"https://github.com/facebook/react/blob/main/packages/scheduler/src/SchedulerMinHeap.js",children:"MinHeap"}),",\nstoring Tasks."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const newTask = {\n  id: taskIdCounter++,\n  callback, // Work from reconciler.\n  priorityLevel,\n  startTime,\n  expirationTime,\n  sortIndex: -1, // MinHeap queue indexing.\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function scheduleCallback(priorityLevel, callback, options) {\n  const currentTime = getCurrentTime()\n  const startTime = currentTime\n  const expirationTime = startTime + timeout[priorityLevel] // -1/250/5000/10000/MAX_INT.\n  const newTask = {\n    id: taskIdCounter++,\n    callback,\n    priorityLevel,\n    startTime,\n    expirationTime,\n    sortIndex: -1,\n  }\n\n  if (startTime > currentTime) {\n    // Delayed task.\n    newTask.sortIndex = startTime\n    push(timerQueue, newTask)\n\n    // All tasks are delayed, and this is task with earliest delay.\n    if (peek(taskQueue) === null && newTask === peek(timerQueue)) {\n      if (isHostTimeoutScheduled) {\n        // Cancel an existing timeout.\n        cancelHostTimeout()\n      } else {\n        isHostTimeoutScheduled = true\n      }\n\n      // Schedule a timeout.\n      requestHostTimeout(handleTimeout, startTime - currentTime)\n    }\n  } else {\n    // Normal task.\n    newTask.sortIndex = expirationTime\n    push(taskQueue, newTask)\n\n    if (!isHostCallbackScheduled && !isPerformingWork) {\n      isHostCallbackScheduled = true\n      requestHostCallback(flushWork)\n    }\n  }\n\n  return newTask\n}\n\nfunction handleTimeout(currentTime) {\n  isHostTimeoutScheduled = false\n  advanceTimers(currentTime)\n\n  if (!isHostCallbackScheduled) {\n    if (peek(taskQueue) !== null) {\n      isHostCallbackScheduled = true\n      requestHostCallback(flushWork)\n    } else {\n      const firstTimer = peek(timerQueue)\n\n      if (firstTimer !== null)\n        requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime)\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"work-loop",children:"Work Loop"}),"\n",(0,i.jsxs)(n.p,{children:["\u5f53 ",(0,i.jsx)(n.code,{children:"callback()"})," \u8fd4\u56de\u51fd\u6570\u65f6, \u8868\u660e\u4ea7\u751f\u8fde\u7eed\u56de\u8c03 (e.g. \u51fa\u73b0\u66f4\u9ad8\u4f18\u5148\u4efb\u52a1/\u65f6\u95f4\u5206\u7247\u7528\u5b8c, \u6e32\u67d3\u4e2d\u65ad),\n\u9700\u5c06\u8fd4\u56de\u7684\u51fd\u6570\u518d\u6b21\u653e\u5165\u4efb\u52a1\u961f\u5217, \u7ee7\u7eed\u8fdb\u884c\u8c03\u5ea6\u76f4\u81f3\u6e05\u7a7a\u4efb\u52a1\u961f\u5217 (\u6e32\u67d3\u6062\u590d)."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function flushWork(hasTimeRemaining, initialTime) {\n  // We'll need a host callback next time work is scheduled.\n  isHostCallbackScheduled = false\n\n  if (isHostTimeoutScheduled) {\n    // We scheduled a timeout but it's no longer needed. Cancel it.\n    isHostTimeoutScheduled = false\n    cancelHostTimeout()\n  }\n\n  isPerformingWork = true // Lock.\n  const previousPriorityLevel = currentPriorityLevel\n\n  try {\n    return workLoop(hasTimeRemaining, initialTime)\n  } finally {\n    // Restore context.\n    currentTask = null\n    currentPriorityLevel = previousPriorityLevel\n    isPerformingWork = false\n  }\n}\n\nfunction workLoop(hasTimeRemaining, initialTime) {\n  let currentTime = initialTime\n  advanceTimers(currentTime)\n  currentTask = peek(taskQueue)\n\n  while (currentTask !== null) {\n    if (\n      currentTask.expirationTime > currentTime\n      && (!hasTimeRemaining || shouldYieldToHost())\n    ) {\n      // This currentTask hasn't expired, and we've reached deadline.\n      break\n    }\n\n    const callback = currentTask.callback\n\n    if (typeof callback === 'function') {\n      currentTask.callback = null\n      currentPriorityLevel = currentTask.priorityLevel\n      const didUserCallbackTimeout = currentTask.expirationTime <= currentTime\n      const continuationCallback = callback(didUserCallbackTimeout)\n      currentTime = getCurrentTime()\n\n      if (typeof continuationCallback === 'function') {\n        // \u4ea7\u751f\u4e86\u8fde\u7eed\u56de\u8c03 (\u5982 Fiber\u6811\u592a\u5927, \u51fa\u73b0\u4e86\u4e2d\u65ad\u6e32\u67d3), \u4fdd\u7559 currentTask.\n        currentTask.callback = continuationCallback\n      } else {\n        if (currentTask === peek(taskQueue))\n          pop(taskQueue)\n      }\n\n      advanceTimers(currentTime)\n    } else {\n      // \u5982\u679c\u4efb\u52a1\u88ab\u53d6\u6d88 (currentTask.callback = null), \u5c06\u5176\u79fb\u51fa\u961f\u5217.\n      pop(taskQueue)\n    }\n\n    currentTask = peek(taskQueue)\n  }\n\n  // Return whether there's additional work.\n  if (currentTask !== null) {\n    return true\n  } else {\n    const firstTimer = peek(timerQueue)\n\n    // \u5b58\u5728\u5ef6\u65f6\u4efb\u52a1, \u7ee7\u7eed\u8fdb\u884c\u8c03\u5ea6.\n    if (firstTimer !== null)\n      requestHostTimeout(handleTimeout, firstTimer.startTime - currentTime)\n\n    return false\n  }\n}\n"})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},86145:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(57140);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);